<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ - ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶¨‡¶æ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Font: Hind Siliguri -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base Font Size Increased for Facebook-like feel */
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f0f2f5; font-size: 16px; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        .app-container { max-width: 480px; margin: 0 auto; background: #ffffff; min-height: 100vh; position: relative; padding-bottom: calc(75px + env(safe-area-inset-bottom)); }
        
        /* Nav Buttons */
        .nav-active { color: #16a34a; border-top: 2px solid #16a34a; }
        .nav-btn { color: #65676b; position: relative; transition: all 0.2s ease-in-out; }
        .nav-btn:active { transform: scale(0.9); }
        .nav-btn i { font-size: 1.6rem; margin-bottom: 2px; }
        .nav-btn p { font-size: 0.75rem; font-weight: 600; }

        .hidden-custom { display: none !important; }
        
        input:focus, select:focus, textarea:focus { outline: 2px solid #16a34a; border-color: transparent; }

        button, .cursor-pointer { transition: transform 0.1s ease, background-color 0.2s ease; }
        button:active { transform: scale(0.96); }

        /* Sidebar Animation */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-100%); }
        #sidebar.open { transform: translateX(0); }
        .sidebar-overlay { transition: opacity 0.3s; opacity: 0; pointer-events: none; }
        .sidebar-overlay.open { opacity: 1; pointer-events: auto; }
        
        .sidebar-item { border-radius: 0 50px 50px 0; margin-right: 15px; position: relative; overflow: hidden; }
        .sidebar-item:active { background-color: #f0fdf4; }
        
        /* Chat Bubbles */
        .chat-bubble-me { background: #16a34a; color: white; border-radius: 18px 18px 0 18px; word-wrap: break-word; font-size: 15px; }
        .chat-bubble-other { background: #e4e6eb; color: black; border-radius: 18px 18px 18px 0; word-wrap: break-word; font-size: 15px; }

        .post-color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .post-color-dot:hover, .post-color-dot.selected { transform: scale(1.2); border-color: #333; }
        .colored-post-bg { display: flex; align-items: center; justify-content: center; min-height: 250px; text-align: center; font-size: 1.6rem; font-weight: bold; color: white; padding: 20px; border-radius: 8px; margin-bottom: 10px; background-size: cover; background-position: center; }

        .post-menu-dropdown { transform-origin: top right; transition: transform 0.1s ease-out, opacity 0.1s ease-out; }
        .cover-photo-gradient { background: linear-gradient(135deg, #16a34a 0%, #0d9488 100%); }

        /* FAB Animation */
        .fab-options { transition: all 0.3s ease-in-out; opacity: 0; transform: translateY(20px); pointer-events: none; }
        .fab-options.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-btn { transition: transform 0.3s; }
        .fab-btn.rotate { transform: rotate(45deg); background-color: #ef4444; border-color: #ef4444; }

        /* Toast */
        #toast-container { position: fixed; bottom: calc(90px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 300; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: rgba(0, 0, 0, 0.85); color: white; padding: 12px 20px; border-radius: 50px; text-align: center; font-size: 15px; animation: fadeUp 0.3s ease-out; box-shadow: 0 4px 6px rgba(0,0,0,0.1); backdrop-filter: blur(4px); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Badge Style */
        .badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 10px; font-weight: bold; padding: 2px 5px; border-radius: 10px; border: 2px solid white; display: none; min-width: 18px; text-align: center; z-index: 10; }
        .badge.active { display: block; }
        
        .nav-badge { position: absolute; top: -2px; right: 20%; background: #ef4444; color: white; font-size: 10px; font-weight: bold; padding: 1px 5px; border-radius: 10px; border: 2px solid white; display: none; }
        
        /* Modal Transitions */
        #comment-full-modal { transition: transform 0.3s ease-in-out; transform: translateY(100%); }
        #comment-full-modal.open { transform: translateY(0); }
        #search-modal { transition: opacity 0.3s; opacity: 0; pointer-events: none; }
        #search-modal.open { opacity: 1; pointer-events: auto; }

        .poll-option { transition: all 0.2s; }
        .poll-fill { transition: width 0.5s ease-out; }
        
        .skeleton { background: #e1e4e8; border-radius: 4px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        .verified-badge { color: #1d9bf0; margin-left: 4px; font-size: 0.95em; }
        .journalist-badge { color: #8b5cf6; margin-left: 4px; font-size: 0.95em; }
        .journalist-post { border: 2px solid #ddd6fe !important; background-color: #faf5ff; }

        body.text-large { font-size: 120%; }
        body.text-small { font-size: 90%; }
        
        @keyframes emergency-pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .btn-emergency { animation: emergency-pulse 2s infinite; }

        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.75rem; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .video-container.portrait { padding-bottom: 177.77%; }

        .feed-tab { border-bottom: 3px solid transparent; transition: all 0.3s; font-size: 14px; }
        .feed-tab.active { border-bottom-color: #16a34a; color: #16a34a; font-weight: bold; }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-12px); } 100% { transform: translateY(0px); } }
        @keyframes soft-pulse { 0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(22, 163, 74, 0); } 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }
        .logo-animate { animation: float 3s ease-in-out infinite, soft-pulse 2s infinite; }
        
        /* New Post Highlight Animation */
        @keyframes highlight-fade { 0% { background-color: #dcfce7; } 100% { background-color: white; } }
        .new-post-highlight { animation: highlight-fade 3s ease-out forwards; }

    </style>
</head>
<body id="body-main">

<!-- ‡¶ü‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
<div id="toast-container"></div>

<!-- ‡ßß. ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
<div id="auth-screen" class="fixed inset-0 bg-white z-[200] flex flex-col items-center justify-center p-6 overflow-y-auto">
    <div class="text-center mb-8">
        <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 logo-animate border-4 border-white shadow-xl">
            <i class="fa-solid fa-map-location-dot text-green-600 text-5xl"></i>
        </div>
        <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ</h1>
        <p class="text-gray-500 mt-1 font-medium">‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶∏‡ßá‡¶¨‡¶æ</p>
    </div>
    <div id="login-form" class="w-full max-w-sm">
        <h2 class="text-xl font-bold mb-6 text-green-700 border-l-4 border-green-600 pl-3">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
        <input type="email" id="login-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full bg-gray-50 border border-gray-200 p-3.5 rounded-xl mb-3 focus:bg-white transition-all text-base">
        <div class="relative w-full mb-2">
            <input type="password" id="login-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="w-full bg-gray-50 border border-gray-200 p-3.5 rounded-xl focus:bg-white pr-10 transition-all text-base">
            <i onclick="togglePassword('login-pass', this)" class="fa-regular fa-eye absolute right-3 top-4 text-gray-500 cursor-pointer text-lg"></i>
        </div>
        <div class="text-right mb-6">
            <span onclick="toggleAuth('forgot')" class="text-sm text-gray-500 hover:text-green-600 cursor-pointer font-medium">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®?</span>
        </div>
        <button onclick="handleLogin()" id="btn-login-action" class="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl hover:bg-green-700 shadow-lg transition active:scale-95 flex justify-center items-center gap-2 text-lg">‡¶≤‡¶ó‡¶á‡¶®</button>
        <p class="mt-8 text-center text-sm text-gray-600">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? <span onclick="toggleAuth('register')" class="text-green-600 font-bold cursor-pointer hover:underline">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span></p>
    </div>
    <div id="register-form" class="w-full max-w-sm hidden-custom">
        <h2 class="text-xl font-bold mb-6 text-green-700 border-l-4 border-green-600 pl-3">‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</h2>
        <div class="space-y-4">
            <input type="text" id="reg-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full bg-gray-50 border p-3.5 rounded-xl text-base">
            <input type="email" id="reg-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full bg-gray-50 border p-3.5 rounded-xl text-base">
            <input type="tel" id="reg-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ (‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü)" class="w-full bg-gray-50 border p-3.5 rounded-xl text-base">
            <div class="relative">
                <label class="text-xs text-gray-500 ml-1 block mb-1 font-bold">‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® *</label>
                <select id="reg-union" onchange="loadVillagesForUnion(this.value, 'reg-village')" class="w-full bg-gray-50 border p-3.5 rounded-xl text-base">
                    <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    <option value="Patharghata Union Sadar">‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶® (‡¶∏‡¶¶‡¶∞)</option>
                    <option value="Char Duani Union">‡¶ö‡¶∞‡¶¶‡ßÅ‡¶Ø‡¶º‡¶æ‡¶®‡ßÄ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                    <option value="Kakchira Union">‡¶ï‡¶æ‡¶ï‡¶ö‡¶ø‡¶∞‡¶æ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                    <option value="Kalmegha Union">‡¶ï‡¶æ‡¶≤‡¶Æ‡ßá‡¶ò‡¶æ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                    <option value="Kathaltoli Union">‡¶ï‡¶æ‡¶Å‡¶†‡¶æ‡¶≤‡¶§‡¶≤‡ßÄ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                    <option value="Nachnapara Union">‡¶®‡¶æ‡¶ö‡¶®‡¶æ‡¶™‡¶æ‡¶°‡¶º‡¶æ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                    <option value="Raihanpur Union">‡¶∞‡¶æ‡¶Ø‡¶º‡¶π‡¶æ‡¶®‡¶™‡ßÅ‡¶∞ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                </select>
            </div>
            <div>
                 <label class="text-xs text-gray-500 ml-1 block mb-1 font-bold">‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ/‡¶Æ‡¶π‡¶≤‡ßç‡¶≤‡¶æ *</label>
                 <select id="reg-village" class="w-full bg-gray-50 border p-3.5 rounded-xl text-base disabled:bg-gray-100" disabled>
                     <option value="">‡¶Ü‡¶ó‡ßá ‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                 </select>
            </div>
            <div class="flex gap-3">
                <div class="w-1/2"><label class="text-xs text-gray-500 ml-1 block mb-1 font-bold">‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label><input type="date" id="reg-dob" class="w-full bg-gray-50 border p-2.5 rounded-xl text-sm"></div>
                <div class="w-1/2"><label class="text-xs text-gray-500 ml-1 block mb-1 font-bold">‡¶≤‡¶ø‡¶ô‡ßç‡¶ó</label><select id="reg-gender" class="w-full bg-gray-50 border p-3 rounded-xl text-sm"><option value="Male">‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑</option><option value="Female">‡¶Æ‡¶π‡¶ø‡¶≤‡¶æ</option></select></div>
            </div>
            <div class="relative w-full">
                <input type="password" id="reg-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ)" class="w-full bg-gray-50 border p-3.5 rounded-xl pr-10 text-base">
                <i onclick="togglePassword('reg-pass', this)" class="fa-regular fa-eye absolute right-3 top-4 text-gray-500 cursor-pointer"></i>
            </div>
        </div>
        <button onclick="handleRegister()" id="btn-reg-action" class="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl hover:bg-green-700 mt-6 shadow-lg transition active:scale-95 flex justify-center items-center gap-2 text-lg">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <p class="mt-8 text-center text-sm text-gray-600">‡¶Ü‡¶ó‡ßá‡¶á ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <span onclick="toggleAuth('login')" class="text-green-600 font-bold cursor-pointer hover:underline">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span></p>
    </div>
    <div id="forgot-form" class="w-full max-w-sm hidden-custom">
        <h2 class="text-xl font-bold mb-6 text-orange-600 border-l-4 border-orange-500 pl-3">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</h2>
        <p class="text-sm text-gray-500 mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡¶®, ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßã‡•§</p>
        <input type="email" id="forgot-email" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full bg-gray-50 border border-gray-200 p-3.5 rounded-xl mb-6 focus:bg-white text-base">
        <button onclick="handleForgotPass()" id="btn-forgot-action" class="w-full bg-orange-500 text-white font-bold py-3.5 rounded-xl hover:bg-orange-600 shadow-lg transition active:scale-95 flex justify-center items-center gap-2 text-lg">‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
        <p class="mt-8 text-center text-sm text-gray-600"><span onclick="toggleAuth('login')" class="text-green-600 font-bold cursor-pointer hover:underline">‡¶≤‡¶ó‡¶á‡¶®‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</span></p>
    </div>
</div>

<!-- ‡ß®. ‡¶∏‡ßç‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
<div id="splash-screen" class="fixed inset-0 bg-green-600 z-[150] flex flex-col items-center justify-center text-white transition-opacity duration-500">
    <i class="fa-solid fa-map-location-dot text-7xl mb-6 logo-animate"></i>
    <h2 class="text-3xl font-bold">‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ</h2>
    <p class="text-sm opacity-90 mt-1">‡¶π‡¶æ‡¶§‡ßá‡¶∞ ‡¶Æ‡ßÅ‡¶†‡ßã‡ßü ‡¶∏‡¶¨ ‡¶∏‡ßá‡¶¨‡¶æ</p>
    <div class="animate-spin rounded-full h-8 w-8 border-4 border-white border-t-transparent mt-8"></div>
</div>

<!-- ‡ß©. ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶®‡ßÅ -->
<div id="sidebar-overlay" onclick="toggleSidebar(false)" class="sidebar-overlay fixed inset-0 bg-black bg-opacity-40 z-[140] backdrop-blur-sm"></div>
<div id="sidebar" class="fixed top-0 left-0 bottom-0 w-80 bg-white z-[145] shadow-2xl flex flex-col rounded-r-2xl overflow-hidden">
    <div class="bg-gradient-to-br from-green-600 to-teal-700 text-white pt-10 pb-6 px-6 relative">
        <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fa-solid fa-tree text-8xl"></i></div>
        <div class="relative z-10 flex flex-col items-start pt-safe">
            <div id="sidebar-avatar-container" class="w-16 h-16 rounded-full border-4 border-white/30 bg-white text-green-600 flex items-center justify-center text-2xl shadow-lg mb-3 overflow-hidden"><i class="fa-solid fa-user"></i></div>
            <h3 id="sidebar-name" class="font-bold text-xl truncate tracking-wide">‡¶®‡¶æ‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</h3>
            <p id="sidebar-village" class="text-sm opacity-90 font-light tracking-wider bg-white/20 px-2 py-0.5 rounded-full inline-block mt-1">---</p>
        </div>
    </div>
    <div class="flex-1 overflow-y-auto py-4 bg-white">
        <ul class="space-y-2">
            <li onclick="switchPage('profile'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-green-700 hover:bg-green-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-green-50 flex items-center justify-center text-green-600 text-lg"><i class="fa-solid fa-user"></i></div> <span class="font-bold text-base">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</span></li>
            <li onclick="openDynamicCategory('history_tourism', '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶™‡¶∞‡ßç‡¶Ø‡¶ü‡¶®'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-purple-700 hover:bg-purple-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 text-lg"><i class="fa-solid fa-landmark"></i></div> <span class="font-bold text-base">‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶™‡¶∞‡ßç‡¶Ø‡¶ü‡¶®</span></li>
            <li onclick="switchPage('directory'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-blue-700 hover:bg-blue-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 text-lg"><i class="fa-solid fa-address-book"></i></div> <span class="font-bold text-base">‡¶™‡ßç‡¶∞‡¶∂‡¶æ‡¶∏‡¶®‡¶ø‡¶ï ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø</span></li>
            <li onclick="switchPage('market'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-orange-700 hover:bg-orange-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-orange-50 flex items-center justify-center text-orange-600 text-lg"><i class="fa-solid fa-store"></i></div> <span class="font-bold text-base">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü</span></li>
            <li onclick="switchPage('complaints'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-red-700 hover:bg-red-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-red-50 flex items-center justify-center text-red-600 text-lg"><i class="fa-solid fa-box-archive"></i></div> <span class="font-bold text-base">‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ï‡ßç‡¶∏</span></li>
            <li onclick="switchPage('settings'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-gray-900 hover:bg-gray-100 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 text-lg"><i class="fa-solid fa-gear"></i></div> <span class="font-bold text-base">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</span></li>
            <div class="border-t mx-6 my-2 border-gray-100"></div>
            <li id="sidebar-help" onclick="alert('‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó: help@patharghata.com'); toggleSidebar(false)" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-4 text-gray-500 hover:bg-gray-50 transition-all"><i class="fa-solid fa-circle-question w-6 text-center"></i> <span class="text-sm font-medium">Help & Support</span></li>
            <li id="sidebar-privacy" onclick="alert('Coming Soon'); toggleSidebar(false)" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-4 text-gray-500 hover:bg-gray-50 transition-all"><i class="fa-solid fa-shield-cat w-6 text-center"></i> <span class="text-sm font-medium">Privacy Policy</span></li>
        </ul>
    </div>
    <div class="p-5 border-t bg-gray-50 pb-safe">
        <button onclick="handleLogout()" class="w-full bg-white border border-red-200 text-red-500 py-3.5 rounded-xl font-bold hover:bg-red-50 hover:border-red-300 hover:text-red-600 flex items-center justify-center gap-2 transition shadow-sm text-base"><i class="fa-solid fa-right-from-bracket"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
    </div>
</div>

<!-- ‡ß™. ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶∏‡¶Æ‡ßÇ‡¶π -->
<div id="verification-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[210] flex items-center justify-center hidden-custom p-4">
    <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl relative max-h-[85vh] overflow-y-auto">
        <button onclick="document.getElementById('verification-modal').classList.add('hidden-custom')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        <h3 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</h3>
        <p class="text-xs text-gray-500 mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®‡•§ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡¶®‡•§</p>
        <div class="space-y-4">
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶ú‡¶æ‡¶§‡ßÄ‡ßü ‡¶™‡¶∞‡¶ø‡¶ö‡ßü‡¶™‡¶§‡ßç‡¶∞ (NID) / ‡¶ú‡¶®‡ßç‡¶Æ ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label><input type="text" id="verify-nid" placeholder="‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶Ü‡¶á‡¶°‡¶ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø</label><input type="file" id="verify-doc-img" accept="image/*" class="w-full bg-gray-50 border border-gray-200 p-2 rounded-lg text-sm file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700"></div>
             <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶õ‡¶¨‡¶ø (‡¶Ü‡¶á‡¶°‡¶ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶π)</label><input type="file" id="verify-user-img" accept="image/*" class="w-full bg-gray-50 border border-gray-200 p-2 rounded-lg text-sm file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700"></div>
        </div>
        <button onclick="submitVerification()" id="btn-verify-submit" class="w-full bg-blue-600 text-white font-bold py-3 mt-6 rounded-lg shadow hover:bg-blue-700 transition flex justify-center items-center gap-2">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
    </div>
</div>

<div id="search-modal" class="fixed inset-0 bg-white z-[190] flex flex-col">
    <div class="flex items-center gap-3 p-4 border-b bg-white shadow-sm z-10 pt-safe sticky top-0">
        <button onclick="toggleGlobalSearch(false)" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600"><i class="fa-solid fa-arrow-left text-xl"></i></button>
        <div class="flex-1 relative">
            <input type="text" id="global-search-input" onkeydown="if(event.key==='Enter') handleGlobalSearch(this.value)" onkeyup="handleGlobalSearch(this.value)" placeholder="‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑, ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶¨‡¶æ ‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶ú‡ßÅ‡¶®..." class="w-full bg-gray-100 py-3 pl-4 pr-10 rounded-full text-base focus:bg-white focus:ring-1 focus:ring-green-500 border-0">
            <i class="fa-solid fa-search absolute right-4 top-3.5 text-gray-400 text-lg"></i>
        </div>
    </div>
    <div id="global-search-results" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 pb-20">
        <div class="text-center mt-20 text-gray-400"><i class="fa-solid fa-magnifying-glass text-4xl mb-3 opacity-30"></i><p>‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</p></div>
    </div>
</div>

<div id="comment-full-modal" class="fixed inset-0 bg-white z-[180] flex flex-col hidden-custom">
    <div class="flex items-center justify-between p-4 border-b bg-white shadow-sm z-10 sticky top-0 pt-safe">
        <div class="flex items-center gap-2"><button onclick="closeFullCommentModal()" class="w-9 h-9 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button><h3 class="font-bold text-gray-800 text-lg">‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h3></div>
        <span id="full-comment-count" class="text-sm bg-gray-100 px-3 py-1 rounded-full font-bold text-gray-600">0</span>
    </div>
    <div id="full-comments-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 pb-20"></div>
    <div class="p-3 border-t bg-white flex gap-2 items-center sticky bottom-0 w-full pb-safe">
        <div id="my-comment-avatar-full" class="w-9 h-9 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center border border-gray-100 shrink-0"><i class="fa-solid fa-user text-gray-400"></i></div>
        <input type="text" id="full-comment-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶§‡¶æ‡¶Æ‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="flex-1 bg-gray-100 rounded-full px-5 py-3 text-sm border-0 focus:ring-1 focus:ring-green-500">
        <button onclick="submitFullComment()" class="text-green-600 text-xl p-2 hover:bg-gray-100 rounded-full w-10 h-10 flex items-center justify-center shadow-sm border border-gray-100"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<!-- SINGLE POST MODAL -->
<div id="single-post-modal" class="fixed inset-0 bg-white z-[180] flex flex-col hidden-custom">
    <div class="flex items-center gap-2 p-4 border-b bg-white shadow-sm z-10 sticky top-0 pt-safe">
        <button onclick="document.getElementById('single-post-modal').classList.add('hidden-custom')" class="w-9 h-9 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
        <h3 class="font-bold text-gray-800 text-lg">‡¶™‡ßã‡¶∏‡ßç‡¶ü</h3>
    </div>
    <div id="single-post-content" class="flex-1 overflow-y-auto p-4 bg-gray-100 pb-20">
        <!-- Post content injected here -->
    </div>
</div>

<!-- UPDATED PROFESSIONAL POST MODAL -->
<div id="post-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center hidden-custom p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-[500px] rounded-2xl shadow-2xl transform transition-all scale-100 overflow-hidden relative">
        <!-- Header -->
        <div class="flex justify-between items-center px-4 py-3 border-b bg-white relative z-10">
            <h3 class="font-bold text-lg text-gray-800 text-center flex-1">‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <button onclick="togglePostModal(false)" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition absolute right-3">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
        </div>
        
        <div class="max-h-[80vh] overflow-y-auto">
            <!-- User Info & Privacy -->
            <div class="px-4 py-3 flex items-center gap-3">
                <div id="post-modal-user-img" class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center border border-gray-100">
                    <i class="fa-solid fa-user text-gray-400 text-xl"></i>
                </div>
                <div>
                    <h4 id="post-modal-user-name" class="font-bold text-gray-800 text-base leading-tight">User Name</h4>
                    <select id="post-privacy" class="mt-1 bg-gray-100 text-xs font-semibold text-gray-600 px-2 py-1 rounded-md border-0 focus:ring-0 cursor-pointer">
                        <option value="public">üåç Public</option>
                        <option value="friends">üë• Friends</option>
                        <option value="only_me">üîí Only Me</option>
                    </select>
                </div>
            </div>

            <!-- Text Area -->
            <div class="px-4">
                <textarea id="post-text" class="w-full min-h-[150px] text-lg lg:text-xl placeholder-gray-500 border-none focus:ring-0 resize-none p-0" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶®‡ßá ‡¶ï‡ßÄ ‡¶Ü‡¶õ‡ßá?"></textarea>
            </div>

            <!-- Background Color Options -->
            <div class="px-4 py-2" id="color-picker-wrapper">
                 <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide" id="color-picker-container">
                    <div onclick="selectPostColor('')" class="post-color-dot bg-white border-gray-300 shadow-sm shrink-0" title="Default"></div>
                    <div onclick="selectPostColor('linear-gradient(to right, #ff5f6d, #ffc371)')" class="post-color-dot shrink-0" style="background: linear-gradient(to right, #ff5f6d, #ffc371);"></div>
                    <div onclick="selectPostColor('linear-gradient(to right, #2193b0, #6dd5ed)')" class="post-color-dot shrink-0" style="background: linear-gradient(to right, #2193b0, #6dd5ed);"></div>
                    <div onclick="selectPostColor('linear-gradient(to right, #cc2b5e, #753a88)')" class="post-color-dot shrink-0" style="background: linear-gradient(to right, #cc2b5e, #753a88);"></div>
                    <div onclick="selectPostColor('linear-gradient(to right, #000000, #434343)')" class="post-color-dot shrink-0" style="background: linear-gradient(to right, #000000, #434343);"></div>
                    <div onclick="selectPostColor('linear-gradient(to right, #11998e, #38ef7d)')" class="post-color-dot shrink-0" style="background: linear-gradient(to right, #11998e, #38ef7d);"></div>
                </div>
                <input type="hidden" id="selected-post-color" value="">
            </div>

            <!-- Image Preview Area -->
            <div id="image-preview-area" class="px-4 mb-2 hidden">
                <div class="relative rounded-xl overflow-hidden border border-gray-200">
                    <img id="post-img-preview" src="" class="w-full max-h-60 object-cover">
                    <button onclick="removePostImage()" class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-md text-gray-700 hover:text-red-500">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>

            <!-- Add to Post Options -->
            <div class="px-4 pb-2">
                <div class="border border-gray-300 rounded-lg p-3 flex justify-between items-center shadow-sm">
                    <span class="text-sm font-semibold text-gray-700">Add to your post</span>
                    <div class="flex gap-4">
                        <div onclick="document.getElementById('post-image-file').click()" class="cursor-pointer text-green-500 hover:bg-green-50 p-1.5 rounded-full transition" title="Photo">
                            <i class="fa-solid fa-images text-2xl"></i>
                        </div>
                        <div class="cursor-pointer text-blue-500 hover:bg-blue-50 p-1.5 rounded-full transition" title="Tag People">
                            <i class="fa-solid fa-user-tag text-xl"></i>
                        </div>
                        <div class="cursor-pointer text-yellow-500 hover:bg-yellow-50 p-1.5 rounded-full transition" title="Feeling/Activity">
                            <i class="fa-regular fa-face-smile text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Extra Fields (Collapsible or just small) -->
            <div class="px-4 py-2 flex gap-2">
                <input type="tel" id="post-mobile" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ (‡¶ï‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶®)" class="w-1/2 bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm focus:bg-white">
                <input type="url" id="post-social-link" placeholder="‡¶∏‡ßã‡¶∂‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï (WhatsApp)" class="w-1/2 bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm focus:bg-white">
            </div>

            <!-- Hidden File Input -->
            <input type="file" id="post-image-file" accept="image/*" class="hidden" onchange="previewPostImage(this)">

            <!-- Submit Button -->
            <div class="p-4">
                <button onclick="submitPost()" id="btn-post-submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-green-700 transition active:scale-[0.98] disabled:opacity-70 disabled:cursor-not-allowed text-lg">
                    ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>
</div>

<div id="edit-post-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[110] flex items-center justify-center hidden-custom p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl">
        <h3 class="font-bold text-lg text-gray-700 mb-4">‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <input type="hidden" id="edit-post-id">
        <textarea id="edit-post-text" class="w-full h-32 p-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white resize-none text-base"></textarea>
        <div class="flex gap-2 mt-4"><button onclick="document.getElementById('edit-post-modal').classList.add('hidden-custom')" class="flex-1 bg-gray-200 text-gray-700 font-bold py-2.5 rounded-lg">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button><button onclick="submitEditPost()" class="flex-1 bg-green-600 text-white font-bold py-2.5 rounded-lg">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
    </div>
</div>

<div id="poll-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center hidden-custom p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl transform transition-all scale-100">
        <div class="flex justify-between items-center mb-4 border-b pb-3"><h3 class="font-bold text-lg text-gray-700">‡¶™‡ßã‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3><button onclick="togglePollModal(false)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-red-100 hover:text-red-500 transition"><i class="fa-solid fa-xmark"></i></button></div>
        <div class="space-y-3">
            <input type="text" id="poll-question" placeholder="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∏‡ßá‡¶∞‡¶æ ‡¶ñ‡ßá‡¶≤‡¶æ ‡¶ï‡ßã‡¶®‡¶ü‡¶ø?)" class="w-full bg-gray-50 border p-3 rounded-lg text-sm font-bold">
            <input type="text" id="poll-opt-1" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ßß" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
            <input type="text" id="poll-opt-2" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ß®" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
            <input type="text" id="poll-opt-3" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ß© (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
            <input type="text" id="poll-opt-4" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ß™ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
        </div>
        <button onclick="submitPoll()" class="w-full bg-blue-600 text-white font-bold py-3 mt-4 rounded-lg shadow hover:bg-blue-700 transition flex justify-center items-center gap-2"><i class="fa-solid fa-square-poll-vertical"></i> ‡¶™‡ßã‡¶≤ ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<div id="sell-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center hidden-custom p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl relative">
        <button onclick="toggleSellModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">‡¶™‡¶£‡ßç‡¶Ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <div class="space-y-3">
            <input type="text" id="sell-title" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
            <input type="number" id="sell-price" placeholder="‡¶¶‡¶æ‡¶Æ (‡¶ü‡¶æ‡¶ï‡¶æ)" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
            <textarea id="sell-desc" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞..." rows="3" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></textarea>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø</label><input type="file" id="sell-image-file" accept="image/*" class="w-full bg-gray-50 border border-gray-200 p-2 rounded-lg text-sm file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:bg-orange-50 file:text-orange-700"></div>
        </div>
        <button onclick="submitProduct()" id="btn-sell-submit" class="w-full bg-orange-500 text-white font-bold py-3 mt-4 rounded-lg shadow hover:bg-orange-600 transition flex justify-center items-center gap-2">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡¶ø‡¶®</button>
    </div>
</div>

<div id="donor-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[100] flex items-center justify-center hidden-custom p-4">
    <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl relative">
        <button onclick="toggleDonorModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        <h3 class="text-xl font-bold text-red-600 mb-1 text-center">‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶§‡¶æ ‡¶π‡ßã‡¶®</h3>
        <p class="text-xs text-gray-500 text-center mb-6">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶ï‡ßç‡¶§‡ßá ‡¶¨‡¶æ‡¶Å‡¶ö‡¶¨‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶æ‡¶£ ‚ù§Ô∏è</p>
        <div class="space-y-4">
            <div><label class="block text-xs font-bold text-gray-600 mb-1">‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™</label><select id="donor-blood-group" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm"><option value="">‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="O+">O+</option><option value="O-">O-</option><option value="AB+">AB+</option><option value="AB-">AB-</option></select></div>
            <div><label class="block text-xs font-bold text-gray-600 mb-1">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label><input type="tel" id="donor-phone" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm" placeholder="017XXXXXXXX"></div>
            <div><label class="block text-xs font-bold text-gray-600 mb-1">‡¶∂‡ßá‡¶∑ ‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label><input type="date" id="donor-last-date" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm"></div>
        </div>
        <button onclick="submitDonor()" class="w-full bg-red-600 text-white font-bold py-3 mt-6 rounded-lg shadow-lg hover:bg-red-700 transition">‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶®</button>
    </div>
</div>

<div id="modal-blood-request" class="fixed inset-0 bg-black bg-opacity-80 z-[105] flex items-center justify-center hidden-custom p-4">
    <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl relative">
        <button onclick="toggleBloodRequestModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        <div class="text-center mb-5"><div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-2 animate-pulse"><i class="fa-solid fa-bell text-red-600 text-3xl"></i></div><h3 class="text-xl font-bold text-red-600">‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</h3><p class="text-xs text-red-500">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶°‡ßã‡¶®‡¶æ‡¶∞‡¶ï‡ßá ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá</p></div>
        <div class="space-y-3">
             <select id="req-blood-group" class="w-full border-2 border-red-200 p-2.5 rounded-lg bg-red-50 text-sm font-bold text-red-800"><option value="">‡¶ï‡ßã‡¶® ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™‡ßá‡¶∞ ‡¶∞‡¶ï‡ßç‡¶§ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®?</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="O+">O+</option><option value="O-">O-</option><option value="AB+">AB+</option><option value="AB-">AB-</option></select>
            <input type="text" id="req-location" placeholder="‡¶π‡¶æ‡¶∏‡¶™‡¶æ‡¶§‡¶æ‡¶≤ ‡¶¨‡¶æ ‡¶∏‡ßç‡¶•‡¶æ‡¶®" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm">
            <input type="tel" id="req-contact" placeholder="‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm">
        </div>
        <button onclick="sendEmergencyBloodRequest()" id="btn-blood-req" class="w-full bg-red-600 text-white font-bold py-3 mt-6 rounded-lg shadow-lg hover:bg-red-700 transition btn-emergency">‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
    </div>
</div>

<div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[160] flex items-center justify-center hidden-custom p-4">
    <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl relative max-h-[85vh] overflow-y-auto">
        <button onclick="toggleEditProfile(false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        <h3 class="text-lg font-bold text-gray-800 mb-5 border-b pb-2">‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <div class="space-y-4">
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶õ‡¶¨‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label><input type="file" id="edit-profile-img" accept="image/*" class="w-full bg-gray-50 border p-2 rounded-lg text-sm file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶®‡¶æ‡¶Æ</label><input type="text" id="edit-name" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶°‡¶æ‡¶ï ‡¶®‡¶æ‡¶Æ (Nickname)</label><input type="text" id="edit-nickname" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∞‡¶æ‡¶®‡¶æ" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® (‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶®‡ßü)</label><input type="text" id="edit-union" disabled class="w-full bg-gray-100 border p-2.5 rounded-lg text-sm text-gray-500 cursor-not-allowed"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ/‡¶Æ‡¶π‡¶≤‡ßç‡¶≤‡¶æ (‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶®‡ßü)</label><input type="text" id="edit-village" disabled class="w-full bg-gray-100 border p-2.5 rounded-lg text-sm text-gray-500 cursor-not-allowed"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶™‡ßá‡¶∂‡¶æ</label><input type="text" id="edit-profession" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï, ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡ßü‡ßÄ" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label><input type="text" id="edit-location" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶¨‡¶æ‡ßü‡ßã (‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß´‡ß¶ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)</label><textarea id="edit-bio" maxlength="50" rows="2" placeholder="‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></textarea></div>
        </div>
        <button onclick="saveProfileChanges()" id="btn-save-profile" class="w-full bg-green-600 text-white font-bold py-3 mt-6 rounded-lg shadow hover:bg-green-700 transition flex justify-center items-center gap-2">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<!-- ‡ß´. ‡¶Æ‡ßá‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
<div class="app-container hidden-custom" id="main-app">
    <header class="bg-white text-gray-800 p-4 sticky top-0 z-40 flex justify-between items-center shadow-sm border-b pt-safe">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar(true)" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center hover:bg-gray-200 transition"><i class="fa-solid fa-bars text-xl"></i></button>
            <h1 id="app-header-title" class="text-xl font-bold text-green-600">‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ</h1>
        </div>
        <div class="flex items-center gap-3">
             <button onclick="toggleGlobalSearch(true)" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-600 hover:bg-gray-200"><i class="fa-solid fa-magnifying-glass text-xl"></i></button>
             <div onclick="switchPage('notifications')" class="cursor-pointer relative">
                <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 border border-gray-200 hover:bg-gray-200"><i class="fa-regular fa-bell text-xl"></i></div>
                <span id="header-badge-notice" class="badge">0</span>
            </div>
        </div>
    </header>

    <main id="content-pages">
        
        <div id="page-home" class="p-0 animate-fade">
            <div id="live-notices"></div> 
            <div class="bg-white border-b sticky top-[68px] z-30 flex">
                <div onclick="filterFeed('all')" id="tab-feed-all" class="flex-1 text-center py-3.5 text-xs font-bold text-gray-500 cursor-pointer feed-tab active uppercase">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ</div>
                <div onclick="filterFeed('union')" id="tab-feed-union" class="flex-1 text-center py-3.5 text-xs font-bold text-gray-500 cursor-pointer feed-tab uppercase">‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶®</div>
                <div onclick="filterFeed('village')" id="tab-feed-village" class="flex-1 text-center py-3.5 text-xs font-bold text-gray-500 cursor-pointer feed-tab uppercase" style="display: none;">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</div>
            </div>
            <div class="bg-gray-100 pb-20">
                <div id="news-feed" class="px-0 space-y-3 min-h-[300px] mt-2">
                    <div class="flex flex-col gap-3 p-4">
                        <div class="h-40 w-full skeleton"></div>
                        <div class="h-40 w-full skeleton"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-services" class="hidden p-4 min-h-screen bg-gray-50 pb-20">
             <div class="bg-white p-3 sticky top-20 z-30 shadow-sm flex items-center gap-2 mb-4 rounded-xl">
                <button onclick="switchPage('home')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                <h2 class="font-bold text-lg text-gray-800">‡¶∏‡¶ï‡¶≤ ‡¶∏‡ßá‡¶¨‡¶æ</h2>
            </div>
            <div id="services-grid" class="grid grid-cols-4 gap-3 p-4 bg-white mb-2 shadow-sm rounded-xl"><p class="col-span-4 text-center text-gray-400 py-4">‡¶∏‡ßá‡¶¨‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>

        <div id="page-dynamic-content" class="hidden p-4 bg-gray-50 min-h-screen pb-20">
            <button onclick="switchPage('services')" class="mb-4 text-gray-500 text-sm font-bold"><i class="fa-solid fa-arrow-left"></i> ‡¶∏‡¶ï‡¶≤ ‡¶∏‡ßá‡¶¨‡¶æ</button>
            <h2 id="dynamic-content-title" class="text-xl font-bold mb-5 border-l-4 border-blue-500 pl-3 text-gray-700">...</h2>
            <div id="dynamic-items-container" class="space-y-3"><p class="text-center text-gray-400 mt-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>

        <div id="page-notifications" class="hidden p-4 min-h-screen bg-gray-50 pb-20">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-yellow-500 pl-3">‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</h2>
            <div id="notifications-list" class="space-y-3"><p class="text-center text-gray-400 mt-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>
        
        <div id="page-people" class="hidden p-0 min-h-screen bg-gray-50 pb-20">
            <div class="bg-white p-4 sticky top-16 z-30 shadow-sm border-b">
                <h2 class="text-xl font-bold text-gray-800 mb-3">‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑ ‡¶ñ‡ßÅ‡¶ú‡ßÅ‡¶®</h2>
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400 text-lg"></i>
                    <div class="flex gap-2">
                         <input type="text" id="search-people" onkeydown="if(event.key==='Enter') filterUsers()" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶ú‡ßÅ‡¶®..." class="w-full bg-gray-100 p-3 pl-12 rounded-full text-base focus:bg-white border border-transparent focus:border-green-200">
                         <button onclick="filterUsers()" class="bg-green-600 text-white px-5 rounded-full text-sm font-bold shadow hover:bg-green-700">Search</button>
                    </div>
                </div>
            </div>
            
            <div class="p-4 space-y-6">
                <div id="friend-requests-section" class="hidden">
                     <h3 class="font-bold text-gray-700 mb-2 border-l-4 border-yellow-500 pl-2 text-sm">‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü</h3>
                     <div id="friend-requests-list" class="space-y-2"></div>
                </div>
                <div>
                     <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-gray-700 border-l-4 border-green-500 pl-2 text-sm">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</h3><button onclick="switchPage('friends-list')" class="text-xs text-green-600 font-bold hover:underline">‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button></div>
                     <div id="my-friends-preview-list" class="grid grid-cols-2 gap-2"><p class="col-span-2 text-center text-gray-400 text-xs py-2">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
                </div>
                <div>
                     <h3 class="font-bold text-gray-700 mb-2 border-l-4 border-blue-500 pl-2 text-sm">‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü / ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶®</h3>
                     <div id="users-list" class="space-y-3"><p class="text-center text-gray-400 text-sm">‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...</p></div>
                </div>
            </div>
        </div>

        <div id="page-messages" class="hidden p-0 min-h-screen bg-white pb-20">
            <div id="chat-list-view" class="h-full">
                <div class="p-4 border-b"><h2 class="text-xl font-bold text-gray-800">‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</h2></div>
                <div class="px-4 py-3 border-b bg-gray-50 overflow-x-auto whitespace-nowrap"><h4 class="text-xs font-bold text-gray-500 mb-2">Active Friends</h4><div id="quick-chat-friends" class="flex gap-4"><p class="text-xs text-gray-400">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div></div>
                <div id="chat-list-container" class="space-y-0"><p class="text-center text-gray-400 mt-10 text-sm">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            </div>
            <div id="chat-conversation-view" class="hidden h-[calc(100vh-130px)] flex flex-col bg-gray-50 relative">
                <div class="bg-white p-3 border-b flex items-center gap-3 sticky top-0 z-20 shadow-sm">
                    <button onclick="closeChat()" class="text-gray-500 w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-700 font-bold border border-green-200 overflow-hidden" id="chat-header-img">U</div>
                    <h3 onclick="openUserProfile(currentChatUser.uid)" class="font-bold text-gray-800 cursor-pointer text-lg" id="chat-header-name">User</h3>
                </div>
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#f0f2f5]"></div>
                <div class="bg-white p-3 border-t flex gap-2 items-center absolute bottom-0 w-full pb-safe">
                    <input type="text" id="msg-input" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="flex-1 bg-gray-100 rounded-full px-5 py-3 text-sm border-0 focus:ring-1 focus:ring-green-500">
                    <button onclick="sendMsg()" class="text-green-600 text-xl p-2 hover:bg-gray-100 rounded-full w-12 h-12 flex items-center justify-center"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="page-market" class="hidden p-4 bg-gray-100 min-h-screen pb-20">
             <div class="flex items-center mb-5 sticky top-20 z-30 bg-gray-100 py-2 gap-3">
                 <button onclick="switchPage('services')" class="text-gray-500 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                 <h2 class="text-xl font-bold text-gray-800 border-l-4 border-orange-500 pl-3 flex-1">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü</h2>
                 <button onclick="toggleSellModal(true)" class="bg-orange-500 text-white px-5 py-2.5 rounded-full text-sm font-bold shadow hover:bg-orange-600 flex items-center gap-2 transform active:scale-95 transition"><i class="fa-solid fa-plus"></i> ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
             </div>
             <div id="market-list" class="grid grid-cols-2 gap-3"><p class="col-span-2 text-center text-gray-400 py-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>

        <div id="page-profile" class="hidden bg-[#f0f2f5] min-h-screen pb-20 z-0">
            <div class="relative bg-white shadow-sm pb-4 mb-3">
                <div class="h-48 w-full cover-photo-gradient relative"></div>
                <div class="px-4">
                    <div class="relative -mt-24 mb-3 flex flex-col items-center">
                         <div class="w-40 h-40 rounded-full p-1.5 bg-white shadow-md">
                            <div id="profile-avatar-container" class="w-full h-full bg-gray-200 rounded-full flex items-center justify-center text-gray-400 text-5xl overflow-hidden border-4 border-white"><i class="fa-solid fa-user"></i></div>
                         </div>
                    </div>
                    <div class="text-center">
                        <h2 id="profile-name" class="text-2xl font-bold text-gray-900 flex items-center justify-center gap-1">...</h2>
                        <span id="profile-union-badge" class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mt-1 mb-1 font-bold">---</span>
                        <p id="profile-village-badge" class="text-sm text-gray-500"><i class="fa-solid fa-location-dot"></i> <span id="profile-village-text">...</span></p>
                        <p id="profile-bio" class="text-sm text-gray-600 mt-2 max-w-xs mx-auto italic">...</p>
                    </div>
                    <div class="flex gap-3 mt-6 border-b pb-4">
                        <button onclick="toggleEditProfile(true)" class="flex-1 bg-gray-100 text-gray-800 py-2.5 rounded-lg font-bold text-sm hover:bg-gray-200 flex items-center justify-center gap-2 transition"><i class="fa-solid fa-pen"></i> ‡¶è‡¶°‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</button>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 shadow-sm mb-3">
                <h3 class="font-bold text-lg text-gray-800 mb-3">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-briefcase w-6 text-center text-gray-400 text-lg"></i><span class="text-base">‡¶™‡ßá‡¶∂‡¶æ: <strong id="profile-profession" class="text-gray-800 ml-1">---</strong></span></div>
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-location-dot w-6 text-center text-gray-400 text-lg"></i><span class="text-base">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: <strong id="profile-location" class="text-gray-800 ml-1">---</strong></span></div>
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-phone w-6 text-center text-gray-400 text-lg"></i><span class="text-base" id="profile-phone">---</span></div>
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-envelope w-6 text-center text-gray-400 text-lg"></i><span class="text-base" id="profile-email">---</span></div>
                </div>
            </div>
            <div class="bg-white p-4 shadow-sm mb-3">
                <div class="flex justify-between items-center mb-3">
                    <div><h3 class="font-bold text-lg text-gray-800">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¨‡¶æ‡¶®‡ßç‡¶ß‡¶¨</h3><p class="text-sm text-gray-500" id="friends-count-me">0 ‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</p></div>
                    <button onclick="showAllFriends('me')" class="text-green-600 text-sm font-bold hover:bg-gray-100 px-3 py-1.5 rounded transition">‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                </div>
                <div id="profile-friends-preview-me" class="grid grid-cols-3 gap-2"><p class="col-span-3 text-center text-sm text-gray-400 py-4">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            </div>
            <div class="px-0">
                <div class="bg-white p-3 mb-2 shadow-sm flex items-center gap-2"><h3 class="font-bold text-gray-700 text-lg">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h3></div>
                <div id="my-posts-feed" class="space-y-3 pb-10"><p class="text-center text-gray-400 text-sm py-6">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            </div>
        </div>

        <div id="page-view-profile" class="hidden bg-[#f0f2f5] min-h-screen pb-20 z-50 absolute top-0 left-0 w-full">
             <div class="bg-white p-2 sticky top-0 z-30 shadow-sm flex items-center gap-2 pt-safe">
                <button onclick="switchPage('home')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                <h2 class="font-bold text-lg text-gray-800" id="view-profile-header-name">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</h2>
            </div>
            <div class="relative bg-white shadow-sm pb-4 mb-3">
                <div class="h-48 w-full bg-gradient-to-r from-blue-500 to-indigo-600 relative"></div>
                <div class="px-4">
                    <div class="relative -mt-24 mb-3 flex flex-col items-center">
                         <div class="w-40 h-40 rounded-full p-1.5 bg-white shadow-md">
                            <div class="w-full h-full bg-gray-200 rounded-full flex items-center justify-center text-blue-600 text-5xl overflow-hidden font-bold border-4 border-white" id="view-profile-avatar-container"><span id="view-profile-initial">U</span></div>
                         </div>
                    </div>
                    <div class="text-center">
                        <h2 id="view-profile-name" class="text-2xl font-bold text-gray-900 flex items-center justify-center gap-1">...</h2>
                        <span id="view-profile-union-badge" class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mt-1 mb-1 font-bold">---</span>
                         <p class="text-sm text-gray-500"><i class="fa-solid fa-location-dot"></i> <span id="view-profile-village-text">...</span></p>
                        <p id="view-profile-bio" class="text-sm text-gray-600 mt-2 max-w-xs mx-auto italic">---</p>
                    </div>
                    <div id="view-profile-actions" class="flex gap-3 mt-6 border-b pb-4 px-2"></div>
                </div>
            </div>
            <div class="bg-white p-4 shadow-sm mb-3">
                <h3 class="font-bold text-lg text-gray-800 mb-3">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-briefcase w-6 text-center text-gray-400 text-lg"></i><span class="text-base">‡¶™‡ßá‡¶∂‡¶æ: <strong id="view-profile-profession" class="text-gray-800 ml-1">---</strong></span></div>
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-location-dot w-6 text-center text-gray-400 text-lg"></i><span class="text-base">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: <strong id="view-profile-location" class="text-gray-800 ml-1">---</strong></span></div>
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-phone w-6 text-center text-gray-400 text-lg"></i><span class="text-base" id="view-profile-phone">---</span></div>
                </div>
            </div>
            <div class="bg-white p-4 shadow-sm mb-3">
                <div class="flex justify-between items-center mb-3">
                    <div><h3 class="font-bold text-lg text-gray-800">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¨‡¶æ‡¶®‡ßç‡¶ß‡¶¨</h3><p class="text-sm text-gray-500" id="friends-count-other">0 ‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</p></div>
                    <button id="btn-view-friends-other" class="text-blue-600 text-sm font-bold hover:bg-gray-100 px-3 py-1.5 rounded transition">‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                </div>
                <div id="profile-friends-preview-other" class="grid grid-cols-3 gap-2"><p class="col-span-3 text-center text-sm text-gray-400 py-4">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            </div>
            <div class="px-0">
                <div class="bg-white p-3 mb-2 shadow-sm border-t border-b border-gray-100"><h3 id="view-profile-posts-title" class="font-bold text-gray-700 text-lg">‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h3></div>
                <div id="view-profile-posts-feed" class="space-y-3 pb-10"><p class="text-center text-gray-400 text-sm">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            </div>
        </div>
        
        <div id="page-friends-list" class="hidden p-4 min-h-screen bg-gray-50 pb-20">
            <button onclick="window.history.back()" class="mb-4 text-gray-500 font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            <h2 class="text-xl font-bold mb-5 border-l-4 border-green-500 pl-3 text-gray-700">‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</h2>
            <div id="all-friends-container" class="grid grid-cols-1 gap-3"><p class="text-center text-gray-400 mt-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>

        <div id="page-blood" class="hidden p-4 bg-gray-50 min-h-screen">
            <button onclick="switchPage('services')" class="mb-4 text-gray-500 font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-6 text-center text-white mb-6 shadow-lg relative overflow-hidden">
                <i class="fa-solid fa-heart-pulse absolute -right-6 -bottom-6 text-9xl opacity-20"></i>
                <h2 class="text-2xl font-bold mb-2">‡¶∞‡¶ï‡ßç‡¶§ ‡¶¶‡¶ø‡¶®, ‡¶ú‡ßÄ‡¶¨‡¶® ‡¶¨‡¶æ‡¶Å‡¶ö‡¶æ‡¶®</h2>
                <div class="flex gap-2 justify-center mt-4">
                     <button onclick="toggleDonorModal(true)" class="bg-white text-red-600 px-5 py-2.5 rounded-full font-bold shadow-md text-sm hover:bg-red-50 transition transform hover:scale-105 active:scale-95">‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶π‡¶®</button>
                     <button onclick="toggleBloodRequestModal(true)" class="bg-red-800 text-white px-5 py-2.5 rounded-full font-bold shadow-md text-sm border border-red-400 animate-pulse hover:bg-red-900 transition transform hover:scale-105 active:scale-95">‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</button>
                </div>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm mb-4">
                <h3 class="font-bold text-gray-700 border-l-4 border-red-500 pl-3 mb-3">‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</h3>
                <div class="flex gap-2">
                    <select id="blood-filter" onchange="filterDonors()" class="w-1/2 text-sm bg-gray-50 border p-2.5 rounded-lg"><option value="all">‡¶∏‡¶ï‡¶≤ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="O+">O+</option><option value="O-">O-</option><option value="AB+">AB+</option><option value="AB-">AB-</option></select>
                    <select id="blood-union-filter" onchange="filterDonors()" class="w-1/2 text-sm bg-gray-50 border p-2.5 rounded-lg"><option value="all">‡¶∏‡¶ï‡¶≤ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ</option><option value="Char Duani Union">‡¶ö‡¶∞‡¶¶‡ßÅ‡¶Ø‡¶º‡¶æ‡¶®‡ßÄ</option><option value="Kakchira Union">‡¶ï‡¶æ‡¶ï‡¶ö‡¶ø‡¶∞‡¶æ</option><option value="Kalmegha Union">‡¶ï‡¶æ‡¶≤‡¶Æ‡ßá‡¶ò‡¶æ</option><option value="Kathaltoli Union">‡¶ï‡¶æ‡¶Å‡¶†‡¶æ‡¶≤‡¶§‡¶≤‡ßÄ</option><option value="Nachnapara Union">‡¶®‡¶æ‡¶ö‡¶®‡¶æ‡¶™‡¶æ‡¶°‡¶º‡¶æ</option><option value="Patharghata Union Sadar">‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ (‡¶∏‡¶¶‡¶∞)</option><option value="Raihanpur Union">‡¶∞‡¶æ‡¶Ø‡¶º‡¶π‡¶æ‡¶®‡¶™‡ßÅ‡¶∞</option></select>
                </div>
            </div>
            <div id="donor-list" class="space-y-3 pb-20"><p class="text-center text-gray-400 text-sm py-4">‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>

        <div id="page-directory" class="hidden p-4 bg-gray-50 min-h-screen pb-20">
            <button onclick="switchPage('services')" class="mb-4 text-gray-500 font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            <h2 class="text-xl font-bold mb-5 border-l-4 border-blue-500 pl-3 text-gray-700">‡¶™‡ßç‡¶∞‡¶∂‡¶æ‡¶∏‡¶®‡¶ø‡¶ï ‡¶ì ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø</h2>
            <h4 class="font-bold text-gray-500 text-sm mb-3">‡¶™‡ßç‡¶∞‡¶∂‡¶æ‡¶∏‡¶®</h4>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div onclick="openDirectoryCategory('uno', '‡¶á‡¶â‡¶è‡¶®‡¶ì ‡¶Ö‡¶´‡¶ø‡¶∏')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-blue-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-building-flag text-3xl text-blue-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶á‡¶â‡¶è‡¶®‡¶ì</span></div>
                 <div onclick="openDirectoryCategory('acland', '‡¶≠‡ßÇ‡¶Æ‡¶ø ‡¶Ö‡¶´‡¶ø‡¶∏')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-green-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-file-contract text-3xl text-green-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶≠‡ßÇ‡¶Æ‡¶ø ‡¶Ö‡¶´‡¶ø‡¶∏</span></div>
                <div onclick="openDirectoryCategory('police', '‡¶•‡¶æ‡¶®‡¶æ ‡¶™‡ßÅ‡¶≤‡¶ø‡¶∂')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-indigo-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-shield-halved text-3xl text-indigo-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶•‡¶æ‡¶®‡¶æ</span></div>
            </div>
            <h4 class="font-bold text-gray-500 text-sm mb-3">‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ</h4>
            <div class="grid grid-cols-3 gap-3 mb-4">
                 <div onclick="openDirectoryCategory('health', '‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶ï‡¶Æ‡¶™‡ßç‡¶≤‡ßá‡¶ï‡ßç‡¶∏')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-red-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-hospital text-3xl text-red-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶π‡¶æ‡¶∏‡¶™‡¶æ‡¶§‡¶æ‡¶≤</span></div>
                <div onclick="openDirectoryCategory('electricity', '‡¶™‡¶≤‡ßç‡¶≤‡ßÄ ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-yellow-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-bolt text-3xl text-yellow-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé</span></div>
                <div onclick="openDirectoryCategory('fire', '‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-orange-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-fire-extinguisher text-3xl text-orange-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞</span></div>
            </div>
             <h4 class="font-bold text-gray-500 text-sm mb-3">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</h4>
            <div class="grid grid-cols-3 gap-3">
                <div onclick="openDirectoryCategory('doctor', '‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-blue-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-user-doctor text-3xl text-blue-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞</span></div>
                <div onclick="openDirectoryCategory('ambulance', '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶¨‡ßÅ‡¶≤‡ßá‡¶®‡ßç‡¶∏')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-red-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-truck-medical text-3xl text-red-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶¨‡ßÅ‡¶≤‡ßá‡¶®‡ßç‡¶∏</span></div>
                 <div onclick="openDirectoryCategory('union', '‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶™‡¶∞‡¶ø‡¶∑‡¶¶')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-teal-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-building-columns text-3xl text-teal-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶á‡¶â‡¶™‡¶ø</span></div>
            </div>
        </div>

        <div id="page-directory-list" class="hidden p-4 bg-gray-50 min-h-screen pb-20">
            <button onclick="switchPage('directory')" class="mb-4 text-gray-500 font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> ‡¶∏‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</button>
            <h2 id="directory-list-title" class="text-xl font-bold mb-5 border-l-4 border-blue-500 pl-3 text-gray-700">‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
            <div id="directory-items-container" class="space-y-3"><p class="text-center text-gray-400 mt-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>

        <div id="page-complaints" class="hidden p-4 bg-gray-50 min-h-screen pb-20">
            <button onclick="switchPage('services')" class="mb-4 text-gray-500 font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            <h2 class="text-xl font-bold mb-5 border-l-4 border-red-500 pl-3 text-gray-700">‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ï‡ßç‡¶∏</h2>
            <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                <h3 class="font-bold text-gray-800 mb-3 text-base">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <div class="space-y-3">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">‡¶ï‡¶æ‡¶ï‡ßá ‡¶ú‡¶æ‡¶®‡¶æ‡¶¨‡ßá‡¶®?</label><select id="complaint-to" class="w-full bg-gray-50 border p-3 rounded-lg text-sm"><option value="UNO">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶π‡ßÄ ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ (UNO)</option><option value="OC">‡¶•‡¶æ‡¶®‡¶æ ‡¶™‡ßÅ‡¶≤‡¶ø‡¶∂ (OC)</option><option value="Chairman">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶ö‡ßá‡ßü‡¶æ‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®</option><option value="ViceChairman">‡¶≠‡¶æ‡¶á‡¶∏ ‡¶ö‡ßá‡ßü‡¶æ‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®</option><option value="General">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">‡¶¨‡¶ø‡¶∑‡ßü</label><select id="complaint-type" class="w-full bg-gray-50 border p-3 rounded-lg text-sm"><option value="Road">‡¶∞‡¶æ‡¶∏‡ßç‡¶§‡¶æ‡¶ò‡¶æ‡¶ü ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶æ‡¶∞</option><option value="Water">‡¶™‡¶æ‡¶®‡¶ø ‡¶ì ‡¶™‡ßü‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∂‡¶®</option><option value="Dispute">‡¶™‡¶æ‡¶∞‡¶ø‡¶¨‡¶æ‡¶∞‡¶ø‡¶ï/‡¶ú‡¶Æ‡¶ø ‡¶¨‡¶ø‡¶∞‡ßã‡¶ß</option><option value="Corruption">‡¶Ö‡¶®‡¶ø‡ßü‡¶Æ ‡¶ì ‡¶¶‡ßÅ‡¶∞‡ßç‡¶®‡ßÄ‡¶§‡¶ø</option><option value="Other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option></select></div>
                    <textarea id="complaint-text" rows="3" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="w-full bg-gray-50 border p-3 rounded-lg text-sm"></textarea>
                    <div class="flex items-center gap-2"><input type="checkbox" id="complaint-anon" class="w-5 h-5 text-green-600 rounded"><label for="complaint-anon" class="text-sm text-gray-600 font-medium">‡¶®‡¶æ‡¶Æ ‡¶ó‡ßã‡¶™‡¶® ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶® (Anonymous)</label></div>
                    <button onclick="submitComplaint()" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow hover:bg-red-700 text-base mt-2">‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
                </div>
            </div>
            <div><h3 class="font-bold text-gray-700 mb-3 text-sm">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó‡¶∏‡¶Æ‡ßÇ‡¶π</h3><div id="my-complaints-list" class="space-y-3"><p class="text-center text-gray-400 text-xs py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶®‡ßá‡¶á</p></div></div>
        </div>

        <div id="page-settings" class="hidden p-0 bg-gray-100 min-h-screen pb-20">
             <div class="bg-white p-4 sticky top-0 z-30 shadow-sm border-b pt-safe flex items-center gap-2">
                <button onclick="switchPage('home')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                <h2 class="text-xl font-bold text-gray-800">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h2>
            </div>
            <div class="p-4 space-y-4">
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-3 bg-gray-50 border-b font-bold text-gray-700 text-sm">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</div>
                    <div class="p-4 space-y-4">
                        <div onclick="toggleEditProfile(true)" class="flex items-center justify-between cursor-pointer hover:bg-gray-50 p-2 rounded transition"><span class="text-base text-gray-700">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶è‡¶°‡¶ø‡¶ü</span><i class="fa-solid fa-pen-to-square text-gray-400 text-lg"></i></div>
                        <div onclick="document.getElementById('verification-modal').classList.remove('hidden-custom')" class="flex items-center justify-between cursor-pointer hover:bg-gray-50 p-2 rounded transition"><span class="text-base text-gray-700">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</span><i class="fa-solid fa-certificate text-blue-500 text-lg"></i></div>
                        <div class="flex items-center justify-between p-2"><span class="text-base text-gray-700">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤/‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶ó‡ßã‡¶™‡¶® ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®</span><input type="checkbox" onchange="togglePrivacy(this.checked)" id="setting-privacy-toggle" class="w-6 h-6 text-green-600 rounded"></div>
                        <div onclick="toggleAuth('forgot'); handleLogout()" class="flex items-center justify-between cursor-pointer hover:bg-gray-50 p-2 rounded transition"><span class="text-base text-gray-700">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</span><i class="fa-solid fa-key text-gray-400 text-lg"></i></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-3 bg-gray-50 border-b font-bold text-gray-700 text-sm">‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</div>
                    <div class="p-4 space-y-4">
                        <div class="flex items-center justify-between p-2"><span class="text-base text-gray-700">‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü</span><input type="checkbox" id="toggle-blood-alert" onchange="updateSettings('bloodAlert', this.checked)" class="w-6 h-6 text-green-600 rounded"></div>
                        <div class="flex items-center justify-between p-2"><span class="text-base text-gray-700">‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶¶‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</span><input type="checkbox" id="toggle-market-alert" onchange="updateSettings('marketAlert', this.checked)" class="w-6 h-6 text-green-600 rounded"></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-3 bg-gray-50 border-b font-bold text-gray-700 text-sm">‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá</div>
                    <div class="p-4 flex gap-4"><button onclick="changeFontSize('small')" class="flex-1 border py-2.5 rounded hover:bg-gray-50 text-sm font-medium">‡¶õ‡ßã‡¶ü</button><button onclick="changeFontSize('normal')" class="flex-1 border py-2.5 rounded hover:bg-gray-50 text-base font-bold bg-gray-100">‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï</button><button onclick="changeFontSize('large')" class="flex-1 border py-2.5 rounded hover:bg-gray-50 text-lg font-medium">‡¶¨‡ßú</button></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-red-100">
                    <div class="p-3 bg-red-50 border-b font-bold text-red-700 text-sm">‡¶°‡ßá‡¶û‡ßç‡¶ú‡¶æ‡¶∞ ‡¶ú‡ßã‡¶®</div>
                    <div class="p-4"><button onclick="handleDeleteAccount()" class="w-full border border-red-500 text-red-600 py-3 rounded-lg font-bold text-base hover:bg-red-50 transition">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
                </div>
                 <div class="text-center text-xs text-gray-400 mt-4">‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶® ‡ß©.‡ß®.‡ß¶ | ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü: help@patharghata.com</div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-2 z-50 text-gray-500 max-w-[480px] mx-auto shadow-[0_-5px_15px_rgba(0,0,0,0.05)] pb-safe">
        <div onclick="switchPage('home')" class="nav-btn w-1/5 text-center cursor-pointer nav-active py-1" id="btn-home"><i class="fa-solid fa-house mb-1"></i><p>‡¶π‡ßã‡¶Æ</p></div>
        <div onclick="switchPage('services')" class="nav-btn w-1/5 text-center cursor-pointer py-1" id="btn-services"><i class="fa-solid fa-layer-group mb-1"></i><p>‡¶∏‡ßá‡¶¨‡¶æ</p></div>
        <div onclick="switchPage('messages')" class="nav-btn w-1/5 text-center cursor-pointer py-1" id="btn-messages"><i class="fa-solid fa-comments mb-1"></i><p>‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</p></div>
        <div onclick="switchPage('people')" class="nav-btn w-1/5 text-center cursor-pointer py-1" id="btn-people"><i class="fa-solid fa-users mb-1"></i><p>‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑</p><span id="nav-badge-people" class="nav-badge">0</span></div>
        <div onclick="switchPage('profile')" class="nav-btn w-1/5 text-center cursor-pointer py-1" id="btn-profile"><i class="fa-solid fa-user mb-1"></i><p>‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</p></div>
    </nav>

    <div class="fixed bottom-24 right-5 z-40 flex flex-col items-center gap-4 pb-safe">
        <div id="fab-options" class="fab-options flex flex-col gap-3">
            <button onclick="togglePostModal(true); toggleFab()" class="bg-white text-gray-700 w-14 h-14 rounded-full shadow-lg flex items-center justify-center border border-gray-100 hover:bg-gray-50"><i class="fa-solid fa-pen text-xl"></i></button>
            <button onclick="togglePollModal(true); toggleFab()" class="bg-white text-blue-600 w-14 h-14 rounded-full shadow-lg flex items-center justify-center border border-gray-100 hover:bg-blue-50"><i class="fa-solid fa-square-poll-vertical text-xl"></i></button>
        </div>
        <div onclick="toggleFab()" id="main-fab" class="fab-btn bg-green-600 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-2xl cursor-pointer hover:bg-green-700 border-2 border-white"><i class="fa-solid fa-plus"></i></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, onChildAdded, onChildChanged, get, update, remove, query, limitToLast, runTransaction, startAt, endAt, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    const firebaseConfig = { apiKey: "AIzaSyBfI-THOXOvhyL7LumZVKixtTVwF94CjsI", authDomain: "pathargata-digital-comnity-ltd.firebasestorage.app", databaseURL: "https://pathargata-digital-comnity-ltd-default-rtdb.firebaseio.com", projectId: "pathargata-digital-comnity-ltd", storageBucket: "pathargata-digital-comnity-ltd.firebasestorage.app", messagingSenderId: "991014085926", appId: "1:991014085926:android:b249e489d8424433ed4de7" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const IMGBB_API_KEY = "ca4089327c76dd8ae49510fe0f16ad3a";
    
    // Global variable exposed to window
    window.currentUser = null;
    
    let userDetails = {}, allUsers = [], myFriends = [], currentChatUser = null, allDonors = [], currentFullPostId = null, globalMarketItems = [], globalDirectory = {}, currentFeedFilter = 'all', allPostsData = [];

    const unionVillagesData = { "Patharghata Union Sadar": ["‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ", "‡¶ó‡¶π‡¶∞‡¶™‡ßÅ‡¶∞", "‡¶®‡¶ø‡¶ú‡¶≤‡¶æ‡¶†‡¶ø‡¶Æ‡¶æ‡¶∞‡¶æ", "‡¶π‡¶æ‡¶§‡ßá‡¶Æ‡¶™‡ßÅ‡¶∞", "‡¶¨‡ßú‡¶á‡¶§‡¶≤‡¶æ", "‡¶¨‡ßú ‡¶ü‡ßá‡¶Ç‡¶∞‡¶æ", "‡¶ï‡ßã‡ßú‡¶æ‡¶≤‡¶ø‡ßü‡¶æ", "‡¶∞‡ßÅ‡¶π‡¶ø‡¶§‡¶æ", "‡¶™‡¶¶‡ßç‡¶Æ‡¶æ", "‡¶π‡¶æ‡ßú‡¶ø‡¶ü‡¶æ‡¶®‡¶æ", "‡¶¨‡¶æ‡¶¶‡ßÅ‡¶∞‡¶§‡¶≤‡¶æ", "‡¶ö‡¶∞‡¶≤‡¶æ‡¶†‡¶ø‡¶Æ‡¶æ‡¶∞‡¶æ"], "Char Duani Union": ["‡¶ö‡¶∞‡¶¶‡ßÅ‡¶Ø‡¶º‡¶æ‡¶®‡ßÄ", "‡¶¶‡¶ï‡ßç‡¶∑‡¶ø‡¶£ ‡¶ö‡¶∞‡¶¶‡ßÅ‡¶Ø‡¶º‡¶æ‡¶®‡ßÄ", "‡¶Æ‡¶†‡ßá‡¶∞ ‡¶ñ‡¶æ‡¶≤", "‡¶π‡ßã‡¶ó‡¶≤‡¶æ‡¶™‡¶æ‡¶∂‡¶æ", "‡¶ó‡¶æ‡¶¨‡¶¨‡¶æ‡¶°‡¶º‡¶ø‡¶Ø‡¶º‡¶æ"], "Kakchira Union": ["‡¶ï‡¶æ‡¶ï‡¶ö‡¶ø‡¶∞‡¶æ", "‡¶ú‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶ò‡¶æ‡¶ü‡¶æ", "‡¶∞‡ßÇ‡¶™‡¶ß‡¶®", "‡¶¨‡¶æ‡¶á‡¶≤‡¶æ‡¶ö‡¶æ‡¶∞‡¶æ"], "Kalmegha Union": ["‡¶ï‡¶æ‡¶≤‡¶Æ‡ßá‡¶ò‡¶æ", "‡¶ò‡ßÅ‡¶ü‡¶æ‡¶¨‡¶æ‡¶õ‡¶æ", "‡¶ï‡ßÅ‡¶™‡¶¶‡ßã‡¶®", "‡¶™‡¶∂‡ßç‡¶ö‡¶ø‡¶Æ ‡¶ï‡¶æ‡¶≤‡¶Æ‡ßá‡¶ò‡¶æ"], "Kathaltoli Union": ["‡¶ï‡¶æ‡¶Å‡¶†‡¶æ‡¶≤‡¶§‡¶≤‡ßÄ", "‡¶§‡¶æ‡¶≤‡¶§‡¶≤‡ßÄ", "‡¶∏‡¶æ‡¶™‡¶≤‡ßá‡¶ú‡¶æ", "‡¶ï‡¶∞‡ßÅ‡¶£‡¶æ"], "Nachnapara Union": ["‡¶®‡¶æ‡¶ö‡¶®‡¶æ‡¶™‡¶æ‡¶°‡¶º‡¶æ", "‡¶ú‡ßç‡¶û‡¶æ‡¶®‡¶™‡¶æ‡¶°‡¶º‡¶æ", "‡¶¨‡¶æ‡¶Å‡¶∂‡¶§‡¶≤‡¶æ", "‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï‡¶ñ‡¶æ‡¶≤‡ßÄ"], "Raihanpur Union": ["‡¶∞‡¶æ‡¶Ø‡¶º‡¶π‡¶æ‡¶®‡¶™‡ßÅ‡¶∞", "‡¶∂‡¶§‡¶ï‡¶∞", "‡¶≤‡ßá‡¶Æ‡ßÅ‡¶Ø‡¶º‡¶æ", "‡¶π‡¶∞‡¶ø‡¶£‡¶ò‡¶æ‡¶ü‡¶æ"] };
    const videoObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) entry.target.contentWindow.postMessage(JSON.stringify({ event: 'command', func: 'playVideo' }), '*'); else entry.target.contentWindow.postMessage(JSON.stringify({ event: 'command', func: 'pauseVideo' }), '*'); }); }, { threshold: 0.5 });

    window.escapeHTML = (str) => { if (!str) return ""; return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
    window.showToast = (msg, type = 'success') => { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = 'toast'; toast.innerText = msg; toast.style.borderLeft = type === 'error' ? "4px solid #ef4444" : "4px solid #22c55e"; container.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; setTimeout(()=> toast.remove(), 300); }, 3000); }
    window.togglePassword = (id, icon) => { const input = document.getElementById(id); if (input.type === "password") { input.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); } else { input.type = "password"; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); } };
    async function uploadImageToImgBB(file) { const formData = new FormData(); formData.append("image", file); try { const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData }); const result = await response.json(); if (result.success) return result.data.url; else throw new Error("Image upload failed"); } catch (error) { throw error; } }
    function timeAgo(timestamp) { const seconds = Math.floor((Date.now() - timestamp) / 1000); if (seconds < 60) return "‡¶è‡¶á‡¶Æ‡¶æ‡¶§‡ßç‡¶∞"; const minutes = Math.floor(seconds / 60); if (minutes < 60) return minutes + " ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶Ü‡¶ó‡ßá"; const hours = Math.floor(minutes / 60); if (hours < 24) return hours + " ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ‡¶Ü‡¶ó‡ßá"; const days = Math.floor(hours / 24); if (days < 30) return days + " ‡¶¶‡¶ø‡¶® ‡¶Ü‡¶ó‡ßá"; const months = Math.floor(days / 30); if (months < 12) return months + " ‡¶Æ‡¶æ‡¶∏ ‡¶Ü‡¶ó‡ßá"; return Math.floor(months / 12) + " ‡¶¨‡¶õ‡¶∞ ‡¶Ü‡¶ó‡ßá"; }
    function checkUserBadge(user) { if (!user) return ""; const role = user.role ? user.role.toLowerCase() : ''; if (role === 'journalist') return `<i class="fa-solid fa-feather-pointed journalist-badge"></i>`; if (user.isVerified || ['chairman', 'member', 'admin', 'doctor', 'uno', 'oc'].includes(role)) return `<i class="fa-solid fa-circle-check verified-badge"></i>`; return ""; }

    onAuthStateChanged(auth, (user) => {
        const authScreen = document.getElementById('auth-screen'), mainApp = document.getElementById('main-app'), splash = document.getElementById('splash-screen');
        setTimeout(() => { splash.classList.add('hidden-custom'); }, 1500);
        if (user) {
            window.currentUser = user; 
            authScreen.classList.add('hidden-custom'); mainApp.classList.remove('hidden-custom');
            const savedSize = localStorage.getItem('fontSize'); if(savedSize) changeFontSize(savedSize);
            if (!history.state) { const currentHash = window.location.hash.replace('#', ''); if (currentHash && currentHash !== 'home') setTimeout(() => switchPage(currentHash), 500); else history.replaceState({ page: 'home' }, "", "#home"); } else switchPage(history.state.page || 'home', false);
            onValue(ref(db, 'users/' + user.uid), (snap) => { userDetails = snap.val() || {}; updateUIWithUserData(); loadFriendsPreview(user.uid, 'me'); loadSettingsData(); if(document.getElementById('setting-privacy-toggle')) document.getElementById('setting-privacy-toggle').checked = userDetails.privacy_hide_contact || false; });
            loadServiceCategories(); loadDynamicSidebar();
            onValue(ref(db, `users/${user.uid}/friends`), (snap) => { myFriends = snap.exists() ? Object.keys(snap.val()) : []; loadQuickChatFriends(); });
            loadUsersLimited(); onValue(ref(db, 'directory'), (snap) => { globalDirectory = snap.val() || {}; });
            listenForFriendRequests(user.uid); listenForNotifications(user.uid); loadChatList(user.uid); loadMyComplaints();
            // Using Optimized Feed Loader
            renderInitialFeed(); 
            listenForFeedUpdates();
            onValue(ref(db, 'app_info/name'), (snap) => { const name = snap.val(); if(name) document.getElementById('app-header-title').innerText = name; });
        } else { window.currentUser = null; authScreen.classList.remove('hidden-custom'); mainApp.classList.add('hidden-custom'); document.getElementById('login-form').classList.remove('hidden-custom'); }
    });

    // --- OPTIMISTIC LIKE FEATURE & GREEN BUTTON (FIXED DUPLICATE ID ISSUE) ---
    window.toggleLike = (postId) => {
        // Query ALL instances of this post's like components in the DOM
        const btns = document.querySelectorAll(`[id^="like-btn-${postId}"]`);
        const icons = document.querySelectorAll(`[id^="like-icon-${postId}"]`);
        const countSpans = document.querySelectorAll(`[id^="like-cnt-${postId}"]`);
        
        // Take the first one to check current state
        if(icons.length === 0) return;
        const icon = icons[0];
        const countSpan = countSpans[0];
        
        // Optimistic UI Update
        const isLiked = icon.classList.contains('fa-solid'); // Solid means liked
        let currentCount = parseInt(countSpan.innerText) || 0;
        let newCount = isLiked ? Math.max(0, currentCount - 1) : currentCount + 1;
        
        // Update ALL instances in DOM
        icons.forEach(i => {
            if (isLiked) {
                i.classList.remove('fa-solid', 'text-green-600');
                i.classList.add('fa-regular');
            } else {
                i.classList.remove('fa-regular');
                i.classList.add('fa-solid', 'text-green-600');
            }
        });

        countSpans.forEach(s => {
            s.innerText = newCount;
            if (isLiked) s.classList.remove('font-bold', 'text-green-600');
            else s.classList.add('font-bold', 'text-green-600');
        });

        // Backend Update
        const likeRef = ref(db, `posts/${postId}/likes/${window.currentUser.uid}`);
        get(likeRef).then((snap) => {
            if (snap.exists()) {
                set(likeRef, null);
            } else {
                set(likeRef, true);
                // Trigger Notification for Like
                get(ref(db, `posts/${postId}`)).then(postSnap => {
                    const post = postSnap.val();
                    if(post && post.uid !== window.currentUser.uid) {
                         push(ref(db, `notifications/${post.uid}`), {
                            type: 'like',
                            fromUid: window.currentUser.uid,
                            fromName: userDetails.name,
                            postId: postId,
                            timestamp: Date.now(),
                            read: false
                        });
                    }
                });
            }
        });
    };

    // --- FIXED: PROFILE POSTS VISIBILITY ---
    window.loadProfilePosts = (targetUid, containerId) => {
        const feedDiv = document.getElementById(containerId);
        if(!feedDiv) return;
        feedDiv.innerHTML = '<div class="flex justify-center py-6"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div></div>';
        
        // Use client-side filtering on a batch to ensure we find posts without indexing
        get(query(ref(db, 'posts'), limitToLast(200))).then(snap => {
             const data = snap.val();
             if(data) {
                 let html = '';
                 // Sort descending
                 const allPosts = Object.entries(data).sort((a,b)=>b[1].timestamp-a[1].timestamp);
                 let foundCount = 0;
                 allPosts.forEach(([id, post]) => {
                     // Strict Match
                     if(post.uid === targetUid) {
                        html += createPostHTML(post, id);
                        foundCount++;
                     }
                 });
                 if(foundCount > 0) feedDiv.innerHTML = html;
                 else feedDiv.innerHTML = '<p class="text-center text-gray-400 py-10">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</p>';
             } else {
                 feedDiv.innerHTML = '<p class="text-center text-gray-400 py-10">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</p>';
             }
        }).catch(e => {
            console.error(e);
            feedDiv.innerHTML = '<p class="text-center text-red-400 py-10">‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ</p>';
        });
    }

    // --- SMART FEED ALGORITHM (HYBRID STATIC + REALTIME) ---
    // 1. Initial Load: Sort by Score (Time + Viral)
    // 2. New Posts: Append to Top
    // 3. Likes/Comments: Update inplace (No Jumping)

    function calculatePostScore(post) {
        // Score = Time (ms) + (Likes * 10 mins worth of ms) + (Comments * 15 mins)
        // This mixes recent and viral.
        const likes = post.likes ? Object.keys(post.likes).length : 0;
        const comments = post.comments ? Object.keys(post.comments).length : 0;
        return (post.timestamp || 0) + (likes * 600000) + (comments * 900000);
    }

    function renderInitialFeed() {
        const feedDiv = document.getElementById('news-feed');
        get(query(ref(db, 'posts'), limitToLast(100))).then(snapshot => {
            const data = snapshot.val();
            if(!data) { feedDiv.innerHTML = '<div class="p-4 text-center text-gray-400">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</div>'; return; }

            let postsArr = Object.entries(data).map(([key, val]) => ({ id: key, ...val }));
            
            // Randomize slightly for "Viral/Mixed" feel then Sort by Score
            // But user requested: "Mix viral and recent".
            // High score = Top.
            postsArr.sort((a, b) => calculatePostScore(b) - calculatePostScore(a));

            let html = '';
            postsArr.forEach(post => { html += createPostHTML(post, post.id); });
            feedDiv.innerHTML = html;
        });
    }

    function listenForFeedUpdates() {
        const feedDiv = document.getElementById('news-feed');
        // Listen for NEW posts only (timestamp > now) - practically handled by limitToLast(1) + check
        const postsRef = query(ref(db, 'posts'), limitToLast(1));
        
        onChildAdded(postsRef, (snapshot) => {
            const post = snapshot.val();
            const id = snapshot.key;
            // Avoid duplicates from initial load
            if(document.getElementById(`post-card-${id}`)) return; 

            // Prepend new post to top (Standard Feed Behavior)
            const html = createPostHTML(post, id);
            feedDiv.insertAdjacentHTML('afterbegin', html);
        });

        // Listen for Updates (Likes/Comments) - UPDATE IN PLACE, DO NOT RE-SORT
        onChildChanged(postsRef, (snapshot) => {
            const post = snapshot.val();
            const id = snapshot.key;
            // UPDATE ALL INSTANCES
            const cards = document.querySelectorAll(`[id="post-card-${id}"]`);
            if(cards.length === 0) return;

            // Update Like Count
            const likeCnts = document.querySelectorAll(`[id="like-cnt-${id}"]`);
            const likeIcons = document.querySelectorAll(`[id="like-icon-${id}"]`);
            const isLiked = post.likes && post.likes[window.currentUser.uid];
            const likeCount = post.likes ? Object.keys(post.likes).length : 0;

            likeCnts.forEach(el => el.innerText = likeCount);
            
            likeIcons.forEach(likeIcon => {
                 if(isLiked) { likeIcon.classList.add('fa-solid', 'text-green-600'); likeIcon.classList.remove('fa-regular'); }
                 else { likeIcon.classList.remove('fa-solid', 'text-green-600'); likeIcon.classList.add('fa-regular'); }
            });

            // Update Comment Count
            const comCnts = document.querySelectorAll(`[id="comment-cnt-${id}"]`);
            const comments = post.comments ? Object.entries(post.comments) : [];
            comCnts.forEach(el => el.innerText = comments.length);
        });
    }

    // --- OTHER CORE FUNCTIONS ---
    function loadDynamicSidebar() { onValue(ref(db, 'admin_settings/links'), (snap) => { const links = snap.val(); if(links) { if(links.help) document.getElementById('sidebar-help').onclick = () => { window.location.href = links.help; toggleSidebar(false); }; if(links.privacy) document.getElementById('sidebar-privacy').onclick = () => { window.location.href = links.privacy; toggleSidebar(false); }; } }); }
    window.loadVillagesForUnion = (unionName, targetId) => { const select = document.getElementById(targetId); select.innerHTML = '<option value="">‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...</option>'; select.disabled = true; if(!unionName) { select.innerHTML = '<option value="">‡¶Ü‡¶ó‡ßá ‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>'; return; } get(ref(db, `locations/${unionName}`)).then((snapshot) => { if(snapshot.exists()) populateVillageSelect(Object.values(snapshot.val()), select); else { const local = unionVillagesData[unionName] || []; if(local.length) populateVillageSelect(local, select); else select.innerHTML = '<option value="">‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</option>'; } }); }
    function populateVillageSelect(villages, selectElement) { let html = '<option value="">‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ/‡¶Æ‡¶π‡¶≤‡ßç‡¶≤‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>'; villages.sort().forEach(v => { html += `<option value="${v}">${v}</option>`; }); selectElement.innerHTML = html; selectElement.disabled = false; }
    
    // --- SERVICE CATEGORIES MERGE FIX ---
    function loadServiceCategories() {
        const defaultCats = { "directory": { title: "‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø", icon: "fa-address-book", color: "text-blue-600", bg: "bg-blue-50" }, "blood": { title: "‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶®", icon: "fa-droplet", color: "text-red-600", bg: "bg-red-50" }, "history_tourism": { title: "‡¶™‡¶∞‡ßç‡¶Ø‡¶ü‡¶®", icon: "fa-landmark", color: "text-purple-600", bg: "bg-purple-50" }, "transport": { title: "‡¶™‡¶∞‡¶ø‡¶¨‡¶π‡¶®", icon: "fa-bus", color: "text-teal-600", bg: "bg-teal-50" }, "education": { title: "‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ", icon: "fa-graduation-cap", color: "text-yellow-600", bg: "bg-yellow-50" }, "complaints": { title: "‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó", icon: "fa-box-archive", color: "text-red-600", bg: "bg-red-50" }, "market": { title: "‡¶π‡¶æ‡¶ü", icon: "fa-store", color: "text-orange-600", bg: "bg-orange-50" } };
        const grid = document.getElementById('services-grid');
        get(ref(db, 'services/categories')).then((snap) => { 
            // MERGE DEFAULT AND DB CATEGORIES
            const categories = { ...defaultCats, ...(snap.val() || {}) }; 
            let html = ''; 
            Object.entries(categories).forEach(([key, cat]) => { let onclick = ['directory', 'blood', 'complaints', 'market'].includes(key) ? `switchPage('${key}')` : `openDynamicCategory('${key}', '${cat.title}')`; html += `<div onclick="${onclick}" class="cursor-pointer group transform active:scale-95 transition"><div class="w-16 h-16 ${cat.bg} ${cat.color} rounded-2xl flex mx-auto items-center justify-center group-hover:bg-opacity-80 transition shadow-sm border border-gray-100"><i class="fa-solid ${cat.icon} text-2xl"></i></div><p class="text-xs mt-2 font-bold text-center text-gray-600">${cat.title}</p></div>`; }); grid.innerHTML = html; 
        });
    }
    
    window.openDynamicCategory = (catId, title) => { switchPage('dynamic-content'); document.getElementById('dynamic-content-title').innerText = title; const container = document.getElementById('dynamic-items-container'); container.innerHTML = '<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>'; get(ref(db, `services/data/${catId}`)).then((snap) => { if(snap.exists()) { const items = snap.val(); let html = ''; Object.values(items).forEach(item => { const imgHtml = item.image ? `<div class="h-32 bg-gray-200 rounded-t-xl overflow-hidden"><img src="${item.image}" class="w-full h-full object-cover"></div>` : ''; const actionBtn = item.phone ? `<a href="tel:${item.phone}" class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center shadow hover:bg-green-600 transition"><i class="fa-solid fa-phone"></i></a>` : ''; html += `<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-3">${imgHtml}<div class="p-4 flex justify-between items-center"><div><h3 class="font-bold text-gray-800 text-lg">${escapeHTML(item.title)}</h3><p class="text-sm text-gray-500 mt-1">${escapeHTML(item.details || '')}</p></div>${actionBtn}</div></div>`; }); container.innerHTML = html; } else { container.innerHTML = `<div class="text-center py-10"><i class="fa-regular fa-folder-open text-4xl text-gray-300 mb-3"></i><p class="text-gray-400">‡¶§‡¶•‡ßç‡¶Ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø</p></div>`; } }); }
    function loadSettingsData() { if(userDetails.settings) { document.getElementById('toggle-blood-alert').checked = userDetails.settings.bloodAlert !== false; document.getElementById('toggle-market-alert').checked = userDetails.settings.marketAlert !== false; } else { document.getElementById('toggle-blood-alert').checked = true; document.getElementById('toggle-market-alert').checked = true; } }
    window.updateSettings = (key, value) => { const updates = {}; updates[`users/${window.currentUser.uid}/settings/${key}`] = value; update(ref(db), updates).then(()=> showToast("‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá")); }
    function loadUsersLimited() { onValue(query(ref(db, 'users'), limitToLast(50)), (snap) => { allUsers = []; const data = snap.val(); if(data) { Object.values(data).forEach(u => { if(u.uid !== window.currentUser.uid) allUsers.push(u); }); updatePeopleTab(); filterUsers(); } }); }
    
    function updateUIWithUserData() {
        const badge = checkUserBadge(userDetails); const displayName = (userDetails.name || "‡¶Ö‡¶ú‡ßç‡¶û‡¶æ‡¶§") + (userDetails.nickname ? ` (${userDetails.nickname})` : "");
        let avatarHtml = `<i class="fa-solid fa-user"></i>`; if (userDetails.profile_pic) avatarHtml = `<img src="${userDetails.profile_pic}" class="w-full h-full object-cover">`;
        document.getElementById('sidebar-avatar-container').innerHTML = avatarHtml; document.getElementById('sidebar-name').innerHTML = displayName + badge; document.getElementById('sidebar-village').innerText = userDetails.village || "‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á";
        document.getElementById('profile-name').innerHTML = displayName + badge; document.getElementById('profile-union-badge').innerText = userDetails.union || "‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶®‡ßá‡¶á"; document.getElementById('profile-village-text').innerText = userDetails.village || "‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á";
        document.getElementById('profile-avatar-container').innerHTML = avatarHtml;
        if (userDetails.profile_pic) document.getElementById('my-comment-avatar-full').innerHTML = `<img src="${userDetails.profile_pic}" class="w-full h-full object-cover">`; else document.getElementById('my-comment-avatar-full').innerHTML = `<i class="fa-solid fa-user text-gray-400"></i>`;
        document.getElementById('profile-bio').innerText = userDetails.bio || "‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."; document.getElementById('profile-profession').innerText = userDetails.profession || "‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á"; document.getElementById('profile-location').innerText = userDetails.location || "‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á";
        document.getElementById('profile-phone').innerHTML = `${userDetails.phone || "‡¶´‡ßã‡¶® ‡¶®‡ßá‡¶á"}`; document.getElementById('profile-email').innerHTML = `${userDetails.email}`;
        document.getElementById('edit-name').value = userDetails.name || ""; document.getElementById('edit-nickname').value = userDetails.nickname || ""; document.getElementById('edit-profession').value = userDetails.profession || ""; document.getElementById('edit-location').value = userDetails.location || "";
        document.getElementById('edit-union').value = userDetails.union || ""; document.getElementById('edit-village').value = userDetails.village || ""; document.getElementById('edit-bio').value = userDetails.bio || "";
        if(userDetails.phone) document.getElementById('donor-phone').value = userDetails.phone;
        const tabVillage = document.getElementById('tab-feed-village'); if (userDetails.village && userDetails.village.trim() !== "") { tabVillage.style.display = 'block'; tabVillage.innerText = userDetails.village; } else { tabVillage.style.display = 'none'; if(currentFeedFilter === 'village') filterFeed('all'); }
    }

    window.saveProfileChanges = async () => {
        const name = document.getElementById('edit-name').value.trim(); const nickname = document.getElementById('edit-nickname').value.trim(); const prof = document.getElementById('edit-profession').value.trim(); const loc = document.getElementById('edit-location').value.trim(); const bio = document.getElementById('edit-bio').value.trim();
        const file = document.getElementById('edit-profile-img').files[0];
        if(!name) return showToast("‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï", 'error');
        const btn = document.getElementById('btn-save-profile'); const originalText = btn.innerText; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; btn.disabled = true;
        try { let profilePicUrl = userDetails.profile_pic || null; if (file) profilePicUrl = await uploadImageToImgBB(file); const updateData = { name, nickname, profession: prof, location: loc, bio }; if (profilePicUrl) updateData.profile_pic = profilePicUrl; await update(ref(db, 'users/' + window.currentUser.uid), updateData); showToast("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); toggleEditProfile(false); document.getElementById('edit-profile-img').value = ""; } catch (e) { showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + e.message, 'error'); } finally { btn.innerText = originalText; btn.disabled = false; }
    };

    window.handleRegister = () => { const name = document.getElementById('reg-name').value.trim(); const email = document.getElementById('reg-email').value.trim(); const phone = document.getElementById('reg-phone').value.trim(); const pass = document.getElementById('reg-pass').value; const union = document.getElementById('reg-union').value; const village = document.getElementById('reg-village').value; if(!name || !email || !phone || !pass || !union || !village) return showToast("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶®/‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!", 'error'); if(!/^01[3-9]\d{8}$/.test(phone)) return showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®", 'error'); const btn = document.getElementById('btn-reg-action'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...'; btn.disabled = true; createUserWithEmailAndPassword(auth, email, pass).then((cred) => { set(ref(db, 'users/' + cred.user.uid), { name, email, phone, union, village, role: 'user', uid: cred.user.uid, joinDate: new Date().toLocaleDateString(), isVerified: false }); }).catch((e) => { showToast(e.message, 'error'); btn.innerText = "‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®"; btn.disabled = false; }); };
    window.handleLogin = () => { const email = document.getElementById('login-email').value.trim(); const pass = document.getElementById('login-pass').value; const btn = document.getElementById('btn-login-action'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; btn.disabled = true; signInWithEmailAndPassword(auth, email, pass).catch((e) => { showToast("‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°", 'error'); btn.innerText = "‡¶≤‡¶ó‡¶á‡¶®"; btn.disabled = false; }); };
    window.handleForgotPass = () => { const email = document.getElementById('forgot-email').value.trim(); if(!email) return showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡¶®", 'error'); const btn = document.getElementById('btn-forgot-action'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; btn.disabled = true; sendPasswordResetEmail(auth, email).then(() => { showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); btn.innerText = "‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®"; btn.disabled = false; toggleAuth('login'); }).catch((error) => { showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + error.message, 'error'); btn.innerText = "‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®"; btn.disabled = false; }); };
    window.handleLogout = () => { if(confirm("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) signOut(auth); };

    window.selectPostColor = (color) => { document.getElementById('selected-post-color').value = color; const textArea = document.getElementById('post-text'); document.querySelectorAll('.post-color-dot').forEach(el => el.classList.remove('selected')); event.target.classList.add('selected'); if(color) { textArea.style.background = color; textArea.style.color = 'white'; textArea.style.fontWeight = 'bold'; textArea.style.textAlign = 'center'; textArea.style.fontSize = '20px'; textArea.style.paddingTop = '40px'; } else { textArea.style.background = 'white'; textArea.style.color = 'black'; textArea.style.fontWeight = 'normal'; textArea.style.textAlign = 'left'; textArea.style.fontSize = '18px'; textArea.style.paddingTop = '0px'; } };
    window.previewPostImage = (input) => { if(input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.getElementById('post-img-preview').src = e.target.result; document.getElementById('image-preview-area').classList.remove('hidden'); }; reader.readAsDataURL(input.files[0]); } }
    window.removePostImage = () => { document.getElementById('post-image-file').value = ""; document.getElementById('image-preview-area').classList.add('hidden'); document.getElementById('post-img-preview').src = ""; }

    window.submitPost = async () => {
        const text = document.getElementById('post-text').value.trim(); const file = document.getElementById('post-image-file').files[0]; const bgColor = document.getElementById('selected-post-color').value; const privacy = document.getElementById('post-privacy').value; const mobile = document.getElementById('post-mobile').value.trim(); const socialLink = document.getElementById('post-social-link').value.trim();
        if(!text && !file) return showToast("‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶õ‡¶¨‡¶ø ‡¶¶‡¶ø‡¶®!", 'error');
        const btn = document.getElementById('btn-post-submit'); const originalBtnText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; btn.disabled = true;
        try {
            let imgUrl = ""; if (file) imgUrl = await uploadImageToImgBB(file);
            const newPostData = { uid: window.currentUser.uid, author: userDetails.name || "Unknown", authorPic: userDetails.profile_pic || null, content: text, image: imgUrl, type: 'text', timestamp: Date.now(), likes: {}, comments: {}, repostCount: 0, bgColor: bgColor, privacy: privacy, union: userDetails.union || '', village: userDetails.village || '', authorRole: userDetails.role || 'user', authorVerified: !!(userDetails.isVerified), mobile: mobile || null, socialLink: socialLink || null };
            
            // Push to Firebase
            const snap = await push(ref(db, 'posts'), newPostData);
            
            // MANUAL PREPEND TO FEED FOR USER (Instantly visible at top)
            const feedDiv = document.getElementById('news-feed');
            const optimisticHtml = createPostHTML(newPostData, snap.key);
            // Insert after any pinned/skeleton items, essentially at the top of content
            feedDiv.insertAdjacentHTML('afterbegin', optimisticHtml);
            
            // Add visual cue
            const newCard = document.getElementById(`post-card-${snap.key}`);
            if(newCard) newCard.classList.add('new-post-highlight');

            document.getElementById('post-text').value = ""; document.getElementById('post-mobile').value = ""; document.getElementById('post-social-link').value = ""; selectPostColor(''); removePostImage(); togglePostModal(false); showToast("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            if(privacy !== 'only_me') notifyFriends(snap.key, userDetails.name);
        } catch (error) { console.error(error); showToast("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message, 'error'); } finally { btn.innerHTML = originalBtnText; btn.disabled = false; }
    };

    window.submitPoll = () => { const q = document.getElementById('poll-question').value.trim(); const o1 = document.getElementById('poll-opt-1').value.trim(); const o2 = document.getElementById('poll-opt-2').value.trim(); if(!q || !o1 || !o2) return showToast("‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶¶‡¶ø‡¶®", 'error'); const o3 = document.getElementById('poll-opt-3').value.trim(); const o4 = document.getElementById('poll-opt-4').value.trim(); const options = [{text: o1, votes: 0}, {text: o2, votes: 0}]; if(o3) options.push({text: o3, votes: 0}); if(o4) options.push({text: o4, votes: 0}); push(ref(db, 'posts'), { uid: window.currentUser.uid, author: userDetails.name, authorPic: userDetails.profile_pic || null, content: q, type: 'poll', options: options, timestamp: Date.now(), likes: {}, comments: {}, repostCount: 0, privacy: 'public', union: userDetails.union || '', village: userDetails.village || '', authorRole: userDetails.role || 'user', authorVerified: !!(userDetails.isVerified) }).then((snap) => { document.getElementById('poll-question').value = ""; document.getElementById('poll-opt-1').value = ""; document.getElementById('poll-opt-2').value = ""; togglePollModal(false); showToast("‡¶™‡ßã‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); notifyFriends(snap.key, userDetails.name); }); };
    function notifyFriends(postId, name) { get(ref(db, `users/${window.currentUser.uid}/friends`)).then((snapshot) => { if(snapshot.exists()) { snapshot.forEach((friendSnap) => { push(ref(db, `notifications/${friendSnap.key}`), { type: 'new_post', fromUid: window.currentUser.uid, fromName: name, postId: postId, timestamp: Date.now(), read: false }); }); } }); }
    window.votePoll = (postId, optionIdx) => { const voteRef = ref(db, `posts/${postId}/voters/${window.currentUser.uid}`); get(voteRef).then(snap => { if(snap.exists()) return showToast("‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶≠‡ßã‡¶ü ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®", 'error'); const optRef = ref(db, `posts/${postId}/options/${optionIdx}/votes`); runTransaction(optRef, (votes) => (votes || 0) + 1).then(() => { set(voteRef, optionIdx); showToast("‡¶≠‡ßã‡¶ü ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); }); }); };
    window.repost = (postId, text) => { const postRef = ref(db, `posts/${postId}/repostCount`); runTransaction(postRef, (c) => (c || 0) + 1); togglePostModal(true); document.getElementById('post-text').value = `[‡¶∞‡¶ø‡¶™‡ßã‡¶∏‡ßç‡¶ü] ${text}\n\n`; };
    window.toggleReadMore = (id) => { const moreSpan = document.getElementById(`more-${id}`); const btn = event.target; if(moreSpan.classList.contains('hidden')){ moreSpan.classList.remove('hidden'); btn.innerText = '‡¶Ü‡ßú‡¶æ‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®'; } else { moreSpan.classList.add('hidden'); btn.innerText = '‡¶Ü‡¶∞‡ßã ‡¶™‡ßú‡ßÅ‡¶®'; } };
    window.reportPost = (postId) => { if(confirm("‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) { push(ref(db, 'reports'), { postId, reporter: window.currentUser.uid, timestamp: Date.now() }); showToast("‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá"); } };
    window.openEditPostModal = (postId) => { const textElem = document.querySelector(`#post-card-${postId} .post-text-content`); const currentText = textElem ? textElem.innerText : ""; document.getElementById('edit-post-id').value = postId; document.getElementById('edit-post-text').value = currentText; document.getElementById('edit-post-modal').classList.remove('hidden-custom'); };
    window.submitEditPost = () => { const postId = document.getElementById('edit-post-id').value; const newText = document.getElementById('edit-post-text').value; if(!newText) return; update(ref(db, `posts/${postId}`), { content: newText }).then(() => { showToast("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá"); document.getElementById('edit-post-modal').classList.add('hidden-custom'); }); };
    window.openFullCommentModal = (postId) => { currentFullPostId = postId; document.getElementById('comment-full-modal').classList.remove('hidden-custom'); setTimeout(() => document.getElementById('comment-full-modal').classList.add('open'), 10); history.pushState({ page: 'comment-modal', postId }, "", "#comments"); loadFullComments(postId); };
    window.closeFullCommentModal = () => { document.getElementById('comment-full-modal').classList.remove('open'); setTimeout(() => { document.getElementById('comment-full-modal').classList.add('hidden-custom'); currentFullPostId = null; }, 300); };
    
    // Optimistic Comment with Notification
    window.submitFullComment = () => { 
        const input = document.getElementById('full-comment-input'); 
        const text = input.value.trim(); 
        if(!text || !currentFullPostId) return; 
        
        push(ref(db, `posts/${currentFullPostId}/comments`), { author: userDetails.name, authorUid: window.currentUser.uid, authorPic: userDetails.profile_pic || null, text: text, time: Date.now() }).then(() => { 
            input.value = "";
            // Notify Post Owner
             get(ref(db, `posts/${currentFullPostId}`)).then(postSnap => {
                const post = postSnap.val();
                if(post && post.uid !== window.currentUser.uid) {
                     push(ref(db, `notifications/${post.uid}`), {
                        type: 'comment',
                        fromUid: window.currentUser.uid,
                        fromName: userDetails.name,
                        postId: currentFullPostId,
                        timestamp: Date.now(),
                        read: false
                    });
                }
            });
        }); 
    };

    function loadFullComments(postId) { const container = document.getElementById('full-comments-list'); const countSpan = document.getElementById('full-comment-count'); container.innerHTML = '<div class="flex justify-center p-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div></div>'; onValue(ref(db, `posts/${postId}/comments`), (snap) => { if(currentFullPostId !== postId) return; const comments = snap.val(); if(comments) { const arr = Object.entries(comments).sort((a,b)=>a[1].time - b[1].time); countSpan.innerText = arr.length; let html = ''; arr.forEach(([cId, c]) => { const isMyComment = c.authorUid === window.currentUser.uid; const delBtn = isMyComment ? `<button onclick="deleteComment('${postId}','${cId}')" class="text-xs text-red-400 ml-2">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>` : ''; let commentAvatar = `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600 text-xs shrink-0">${escapeHTML(c.author).charAt(0)}</div>`; if (c.authorPic) commentAvatar = `<img src="${c.authorPic}" class="w-8 h-8 rounded-full object-cover shrink-0 border border-gray-100">`; html += `<div class="flex gap-2 mb-3">${commentAvatar}<div class="bg-gray-100 rounded-2xl px-3 py-2 relative group max-w-[85%]"><h4 class="font-bold text-xs text-gray-800">${escapeHTML(c.author)}</h4><p class="text-sm text-gray-700 leading-snug">${escapeHTML(c.text)}</p><div class="flex gap-2 mt-1"><span class="text-[10px] text-gray-400">${timeAgo(c.time)}</span>${delBtn}</div></div></div>`; }); container.innerHTML = html; container.scrollTop = container.scrollHeight; } else { container.innerHTML = '<p class="text-center text-gray-400 mt-10">‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á</p>'; countSpan.innerText = '0'; } }); }
    
    // Inline Comment with Notification
    window.submitInlineComment = (postId) => { 
        const input = document.getElementById(`inline-comment-input-${postId}`); 
        const text = input.value.trim(); 
        if(!text) return; 
        
        push(ref(db, `posts/${postId}/comments`), { author: userDetails.name, authorUid: window.currentUser.uid, authorPic: userDetails.profile_pic || null, text: text, time: Date.now() }).then(() => { 
            input.value = ""; 
            // Notify Post Owner
             get(ref(db, `posts/${postId}`)).then(postSnap => {
                const post = postSnap.val();
                if(post && post.uid !== window.currentUser.uid) {
                     push(ref(db, `notifications/${post.uid}`), {
                        type: 'comment',
                        fromUid: window.currentUser.uid,
                        fromName: userDetails.name,
                        postId: postId,
                        timestamp: Date.now(),
                        read: false
                    });
                }
            });
        }); 
    }

    window.deleteComment = (postId, commentId) => { if(confirm("‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) remove(ref(db, `posts/${postId}/comments/${commentId}`)); }
    window.togglePostMenu = (postId) => { const menu = document.getElementById(`post-menu-${postId}`); const isHidden = menu.classList.contains('hidden'); document.querySelectorAll('.post-menu-dropdown').forEach(el => el.classList.add('hidden')); if(isHidden) menu.classList.remove('hidden'); };
    window.hidePost = (postId) => { document.getElementById(`post-card-${postId}`).style.display = 'none'; };
    window.deletePost = (postId) => { if(confirm("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) remove(ref(db, `posts/${postId}`)).then(()=>showToast("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá")); };

    function createPostHTML(post, id) {
        let privacyIcon = '<i class="fa-solid fa-earth-americas text-[10px] text-gray-400"></i>';
        if (post.privacy === 'only_me') { if (post.uid !== window.currentUser.uid) return ''; privacyIcon = '<i class="fa-solid fa-lock text-[10px] text-gray-400"></i>'; } 
        else if (post.privacy === 'friends') { const isMe = post.uid === window.currentUser.uid; const isFriend = myFriends.includes(post.uid); if (!isMe && !isFriend) return ''; privacyIcon = '<i class="fa-solid fa-user-group text-[10px] text-gray-400"></i>'; }
        const initial = post.author ? escapeHTML(post.author).charAt(0).toUpperCase() : 'U';
        let avatarHtml = `<div onclick="openUserProfile('${post.uid}')" class="cursor-pointer w-10 h-10 bg-green-100 rounded-full flex items-center justify-center font-bold text-green-700 shadow-sm text-lg">${initial}</div>`;
        if (post.authorPic) avatarHtml = `<img onclick="openUserProfile('${post.uid}')" src="${post.authorPic}" class="cursor-pointer w-10 h-10 rounded-full object-cover shadow-sm">`;
        let myInlineAvatar = `<div class="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 shrink-0"><i class="fa-solid fa-user"></i></div>`;
        if(userDetails.profile_pic) myInlineAvatar = `<img src="${userDetails.profile_pic}" class="w-9 h-9 rounded-full object-cover shrink-0 border border-gray-100">`;
        const isLiked = post.likes && post.likes[window.currentUser.uid]; const likeCount = post.likes ? Object.keys(post.likes).length : 0; const repostCount = post.repostCount || 0; const comments = post.comments ? Object.entries(post.comments) : []; const commentCount = comments.length;
        
        // LIKE BUTTON GREEN
        const likeIconClass = isLiked ? 'fa-solid fa-thumbs-up text-green-600' : 'fa-regular fa-thumbs-up';
        const likeTextClass = isLiked ? 'font-bold text-green-600' : '';
        let badge = ""; if(post.authorRole === 'journalist') badge = `<i class="fa-solid fa-feather-pointed journalist-badge"></i>`; else if (post.authorVerified) badge = `<i class="fa-solid fa-circle-check verified-badge"></i>`;
        const cardClass = (post.authorRole === 'journalist') ? 'journalist-post' : '';
        let locationTag = ''; if(post.union) locationTag += `<span class="bg-gray-100 text-[10px] px-2 py-0.5 rounded-full text-gray-500 ml-2">${post.union}</span>`; if(post.village) locationTag += `<span class="bg-green-50 text-[10px] px-2 py-0.5 rounded-full text-green-600 ml-1 border border-green-100">${post.village}</span>`;
        let previewHTML = ''; comments.slice(-2).forEach(([cId, c]) => { previewHTML += `<div class="bg-gray-50 px-3 py-1.5 rounded-lg mt-1 text-xs border border-gray-100 truncate"><span class="font-bold text-gray-800 mr-1">${escapeHTML(c.author)}</span>${escapeHTML(c.text)}</div>`; });
        const showMoreBtn = commentCount > 0 ? `<button onclick="openFullCommentModal('${id}')" class="text-xs text-green-600 font-bold mt-2 hover:underline w-full text-left">‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (${commentCount})</button>` : '';
        let menuOptions = `<li onclick="reportPost('${id}')" class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-yellow-600"><i class="fa-solid fa-triangle-exclamation w-5"></i> ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</li><li onclick="hidePost('${id}')" class="px-4 py-2 hover:bg-gray-100 cursor-pointer"><i class="fa-regular fa-eye-slash w-5"></i> ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</li>`;
        if (post.uid === window.currentUser.uid) menuOptions = `<li onclick="openEditPostModal('${id}')" class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-blue-600"><i class="fa-solid fa-pen w-5"></i> ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</li><li onclick="deletePost('${id}')" class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-red-600"><i class="fa-solid fa-trash w-5"></i> ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</li>`;
        let actionButtons = ''; if(post.mobile || post.socialLink) { actionButtons = '<div class="grid grid-cols-2 gap-2 mt-3 mb-2">'; if(post.mobile) actionButtons += `<a href="tel:${post.mobile}" class="flex items-center justify-center gap-2 bg-green-50 text-green-700 py-2 rounded-lg font-bold text-sm hover:bg-green-100 transition border border-green-200"><i class="fa-solid fa-phone"></i> Call Now</a>`; else actionButtons += `<div></div>`; if(post.socialLink) actionButtons += `<a href="${post.socialLink}" target="_blank" class="flex items-center justify-center gap-2 bg-blue-50 text-blue-700 py-2 rounded-lg font-bold text-sm hover:bg-blue-100 transition border border-blue-200"><i class="fa-brands fa-whatsapp"></i> Message</a>`; else actionButtons += `<div></div>`; actionButtons += '</div>'; }
        let contentHTML = '';
        if(post.content) {
            if(post.bgColor && post.type === 'text') contentHTML = `<div class="colored-post-bg" style="background: ${post.bgColor};">${escapeHTML(post.content)}</div>`;
            else { const ytRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/; const ytMatch = post.content.match(ytRegex); let cleanText = escapeHTML(post.content).replace(ytRegex, ''); if(cleanText.length > 150) cleanText = `<span>${cleanText.substring(0, 150)}...</span><span id="more-${id}" class="hidden">${cleanText.substring(150)}</span> <button onclick="toggleReadMore('${id}')" class="text-blue-600 text-xs font-bold">‡¶Ü‡¶∞‡ßã ‡¶™‡ßú‡ßÅ‡¶®</button>`; contentHTML = `<p class="post-text-content text-[15px] text-gray-800 mb-2 whitespace-pre-line leading-relaxed font-normal">${cleanText}</p>`; if(ytMatch && ytMatch[1]) contentHTML += `<div class="video-container ${post.content.includes("shorts")?'portrait':''} mb-3 shadow-sm"><iframe id="yt-${id}" class="yt-player" src="https://www.youtube.com/embed/${ytMatch[1]}?enablejsapi=1&rel=0" frameborder="0" allowfullscreen></iframe></div>`; }
        }
        let imageHTML = ''; if(post.image && post.image.trim() !== '') imageHTML = `<div class="mb-3 w-full bg-gray-200 rounded-lg overflow-hidden border border-gray-200 relative min-h-[200px]"><img src="${post.image}" class="w-full h-full object-cover"></div>`;
        if(post.type === 'poll' && post.options) { let pollHTML = '<div class="space-y-2 mb-3">'; let totalVotes = 0; post.options.forEach(o => totalVotes += (o.votes || 0)); post.options.forEach((opt, idx) => { const percent = totalVotes === 0 ? 0 : Math.round((opt.votes || 0) / totalVotes * 100); pollHTML += `<div onclick="votePoll('${id}', ${idx})" class="poll-option relative w-full border rounded-lg h-10 overflow-hidden cursor-pointer hover:bg-gray-50"><div class="poll-fill absolute top-0 left-0 h-full bg-blue-100 z-0" style="width: ${percent}%"></div><div class="absolute inset-0 flex justify-between items-center px-3 z-10 pointer-events-none"><span class="text-sm font-semibold text-gray-700">${escapeHTML(opt.text)}</span><span class="text-xs font-bold text-gray-500">${percent}%</span></div></div>`; }); pollHTML += `<p class="text-xs text-right text-gray-400 mt-1 font-bold">${totalVotes} ‡¶≠‡ßã‡¶ü</p></div>`; contentHTML = `<h4 class="font-bold text-gray-800 mb-2">${escapeHTML(post.content)}</h4>${pollHTML}`; }
        let displayStyle = ""; if (currentFeedFilter === 'union' && post.union !== userDetails.union) displayStyle = "display: none;"; else if (currentFeedFilter === 'village') { if (!post.village || !userDetails.village || post.village.trim().toLowerCase() !== userDetails.village.trim().toLowerCase()) displayStyle = "display: none;"; }
        return `
        <div id="post-card-${id}" class="bg-white p-4 rounded-xl shadow-sm mb-3 border border-gray-100 relative max-w-lg mx-auto ${cardClass}" style="${displayStyle}" data-union="${post.union||''}" data-village="${post.village||''}">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3">${avatarHtml}<div><h4 onclick="openUserProfile('${post.uid}')" class="font-bold text-base text-gray-800 cursor-pointer hover:underline">${escapeHTML(post.author)}${badge}</h4><p class="text-[11px] text-gray-400 flex flex-wrap gap-1 items-center font-medium">${timeAgo(post.timestamp)} ${privacyIcon} ${locationTag}</p></div></div>
                <div class="relative"><button onclick="togglePostMenu('${id}')" class="w-8 h-8 rounded-full hover:bg-gray-100 text-gray-500 flex items-center justify-center transition"><i class="fa-solid fa-ellipsis-vertical text-lg"></i></button><div id="post-menu-${id}" class="post-menu-dropdown hidden absolute right-0 top-8 w-48 bg-white shadow-xl rounded-lg z-20 border border-gray-100 py-1 text-sm text-gray-700"><ul>${menuOptions}</ul></div></div>
            </div>
            ${contentHTML}${imageHTML}${actionButtons}
            <div class="grid grid-cols-3 border-t border-b border-gray-100 py-2 mt-2">
                <button id="like-btn-${id}" onclick="toggleLike('${id}')" class="flex items-center justify-center gap-2 hover:bg-gray-50 py-1.5 rounded transition text-gray-500"><i id="like-icon-${id}" class="${likeIconClass} text-lg"></i> <span id="like-cnt-${id}" class="text-sm ${likeTextClass}">${likeCount}</span></button>
                <button onclick="openFullCommentModal('${id}')" class="flex items-center justify-center gap-2 hover:bg-gray-50 py-1.5 rounded transition text-gray-500"><i class="fa-regular fa-comment text-lg"></i> <span id="comment-cnt-${id}" class="text-sm">${commentCount}</span></button>
                <button onclick="repost('${id}', '${post.type==='text'? escapeHTML(post.content).replace(/'/g, "\\'") : 'Shared a Poll'}')" class="flex items-center justify-center gap-2 hover:bg-gray-50 py-1.5 rounded transition text-gray-500"><i class="fa-solid fa-share text-lg"></i> <span class="text-sm">${repostCount}</span></button>
            </div>
            <div class="mt-2"><div id="comments-preview-${id}">${previewHTML}</div>${showMoreBtn}<div class="mt-3 flex gap-2 items-center">${myInlineAvatar}<input type="text" id="inline-comment-input-${id}" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶§‡¶æ‡¶Æ‡¶§..." class="flex-1 bg-gray-100 border-0 rounded-full px-4 py-2 text-sm focus:ring-1 focus:ring-green-500"><button onclick="submitInlineComment('${id}')" class="text-green-600 w-9 h-9 flex items-center justify-center bg-green-50 rounded-full hover:bg-green-100"><i class="fa-solid fa-paper-plane text-sm"></i></button></div></div>
        </div>`;
    }
    
    window.filterFeed = (type) => { currentFeedFilter = type; document.getElementById('tab-feed-all').classList.toggle('active', type === 'all'); document.getElementById('tab-feed-union').classList.toggle('active', type === 'union'); document.getElementById('tab-feed-village').classList.toggle('active', type === 'village'); const posts = document.querySelectorAll('[id^="post-card-"]'); posts.forEach(card => { const postUnion = card.getAttribute('data-union'); const postVillage = card.getAttribute('data-village'); if (type === 'union') { if (postUnion === userDetails.union) card.style.display = 'block'; else card.style.display = 'none'; } else if (type === 'village') { if (postVillage && userDetails.village && postVillage.trim().toLowerCase() === userDetails.village.trim().toLowerCase()) card.style.display = 'block'; else card.style.display = 'none'; } else card.style.display = 'block'; }); }
    
    // --- FRIEND REQUEST PROFILE PICTURE FIX ---
    function updatePeopleTab() {
        get(ref(db, `friend_requests/${window.currentUser.uid}`)).then(snap => { 
            const reqDiv = document.getElementById('friend-requests-list'); 
            const reqSec = document.getElementById('friend-requests-section'); 
            const navBadge = document.getElementById('nav-badge-people'); 
            
            if(snap.exists()) { 
                const requests = snap.val(); 
                const reqCount = Object.keys(requests).length; 
                if (reqCount > 0) { navBadge.innerText = reqCount; navBadge.classList.add('active'); } 
                else navBadge.classList.remove('active'); 
                reqSec.classList.remove('hidden'); 
                
                // Clear and rebuild asynchronously
                reqDiv.innerHTML = '';
                Object.values(requests).forEach(r => {
                    // Fetch user details for image
                    get(ref(db, `users/${r.fromUid}`)).then(uSnap => {
                        const uData = uSnap.val() || {};
                        let av = `<div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 font-bold"><i class="fa-solid fa-user-plus"></i></div>`;
                        if (uData.profile_pic) {
                            av = `<img src="${uData.profile_pic}" class="w-10 h-10 rounded-full object-cover">`;
                        } else if (uData.name) {
                            av = `<div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 font-bold">${uData.name.charAt(0)}</div>`;
                        }
                        
                        const html = `<div class="bg-white p-3 rounded-xl shadow-sm border border-yellow-100 flex justify-between items-center"><div class="flex items-center gap-3" onclick="openUserProfile('${r.fromUid}')">${av}<div><h4 class="font-bold text-gray-800 text-sm">${escapeHTML(r.fromName)}</h4></div></div><div class="flex gap-2"><button onclick="acceptRequest('${r.fromUid}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs">Confirm</button><button onclick="cancelRequest('${r.fromUid}', true)" class="bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs">Delete</button></div></div>`;
                        reqDiv.insertAdjacentHTML('beforeend', html);
                    });
                }); 
            } else { 
                reqSec.classList.add('hidden'); 
                navBadge.classList.remove('active'); 
            } 
        });
        const frPreviewDiv = document.getElementById('my-friends-preview-list'); if(myFriends.length > 0) { let html = ''; const friendsList = allUsers.filter(u => myFriends.includes(u.uid)).slice(0, 10); if(friendsList.length === 0) html = '<p class="col-span-2 text-center text-gray-400 text-xs py-2">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®...</p>'; else friendsList.forEach(u => { let av = `<div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-green-600 font-bold text-xs">${escapeHTML(u.name).charAt(0)}</div>`; if(u.profile_pic) av = `<img src="${u.profile_pic}" class="w-8 h-8 rounded-full object-cover">`; html += `<div onclick="openUserProfile('${u.uid}')" class="bg-green-50 p-2 rounded-lg border border-green-100 flex items-center gap-2 cursor-pointer">${av}<span class="text-xs font-bold text-gray-700 truncate">${escapeHTML(u.name).split(' ')[0]}</span></div>`; }); frPreviewDiv.innerHTML = html; } else frPreviewDiv.innerHTML = '<p class="col-span-2 text-center text-gray-400 text-xs">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶®‡ßá‡¶á</p>';
    }

    window.filterUsers = () => { const queryVal = document.getElementById('search-people').value.trim().toLowerCase(); const div = document.getElementById('users-list'); div.innerHTML = '<p class="text-center text-gray-400 mt-4">‡¶ñ‡ßÅ‡¶ú‡¶õ‡ßá...</p>'; if(!queryVal) { renderSuggestions(allUsers); return; } get(ref(db, 'users')).then((snap) => { if(snap.exists()) { const all = Object.values(snap.val()); const results = all.filter(u => u.uid !== window.currentUser.uid && u.name && u.name.toLowerCase().includes(queryVal)); if(results.length > 0) renderSuggestions(results); else div.innerHTML = '<p class="text-center text-gray-400 mt-4">‡¶ï‡¶æ‡¶â‡¶ï‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p>'; } else div.innerHTML = '<p class="text-center text-gray-400 mt-4">‡¶ï‡¶æ‡¶â‡¶ï‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p>'; }); };
    function renderSuggestions(users) { get(ref(db, `friend_requests/${window.currentUser.uid}`)).then(reqSnap => { const incomingRequests = reqSnap.exists() ? Object.keys(reqSnap.val()) : []; const div = document.getElementById('users-list'); const strangers = users.filter(u => !myFriends.includes(u.uid) && u.uid !== window.currentUser.uid && !incomingRequests.includes(u.uid)); if(strangers.length === 0) { div.innerHTML = '<p class="text-center text-gray-400 mt-4">‡¶ï‡¶æ‡¶â‡¶ï‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p>'; return; } let html = ''; strangers.slice(0, 50).forEach(u => { const badge = checkUserBadge(u); let avatar = `<div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">${u.name?escapeHTML(u.name).charAt(0):'U'}</div>`; if(u.profile_pic) avatar = `<img src="${u.profile_pic}" class="w-10 h-10 rounded-full object-cover">`; html += `<div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center"><div class="flex items-center gap-3" onclick="openUserProfile('${u.uid}')">${avatar}<div><h4 class="font-bold text-gray-800 text-sm">${escapeHTML(u.name)}${badge}</h4><p class="text-xs text-gray-500">${escapeHTML(u.profession) || '‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø'}</p></div></div><button id="btn-req-${u.uid}" onclick="toggleFriendRequest('${u.uid}')" class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold hover:bg-blue-100 transition min-w-[80px]">Add</button></div>`; checkRequestStatus(u.uid); }); div.innerHTML = html; }); }
    window.toggleFriendRequest = (toUid) => { const btn = document.getElementById(`btn-req-${toUid}`); const isCancelMode = btn.innerText.includes('Cancel'); btn.disabled = true; btn.innerText = "..."; if (isCancelMode) { remove(ref(db, `friend_requests/${toUid}/${window.currentUser.uid}`)).then(() => { showToast("‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); btn.classList.remove('bg-gray-200', 'text-gray-600'); btn.classList.add('bg-blue-50', 'text-blue-600'); btn.innerHTML = 'Add'; btn.disabled = false; }).catch(e => { showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + e.message, 'error'); btn.disabled = false; }); } else { set(ref(db, `friend_requests/${toUid}/${window.currentUser.uid}`), { fromName: userDetails.name, fromUid: window.currentUser.uid, timestamp: Date.now() }).then(() => { showToast("‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); btn.classList.remove('bg-blue-50', 'text-blue-600'); btn.classList.add('bg-gray-200', 'text-gray-600'); btn.innerHTML = 'Cancel'; btn.disabled = false; }).catch(e => { showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + e.message, 'error'); btn.disabled = false; }); } };
    window.checkRequestStatus = (targetUid) => { get(ref(db, `friend_requests/${targetUid}/${window.currentUser.uid}`)).then((snapshot) => { const btn = document.getElementById(`btn-req-${targetUid}`); if (!btn) return; if (snapshot.exists()) { btn.classList.remove('bg-blue-50', 'text-blue-600'); btn.classList.add('bg-gray-200', 'text-gray-600'); btn.innerHTML = 'Cancel'; } else btn.innerHTML = 'Add'; }); }
    window.unfriend = (uid) => { if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶Ü‡¶®‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) { const updates = {}; updates[`users/${window.currentUser.uid}/friends/${uid}`] = null; updates[`users/${uid}/friends/${window.currentUser.uid}`] = null; update(ref(db), updates).then(() => { showToast("‡¶Ü‡¶®‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); if(currentChatUser && currentChatUser.uid === uid) closeChat(); get(ref(db, `users/${window.currentUser.uid}/friends`)).then((snap) => { myFriends = snap.exists() ? Object.keys(snap.val()) : []; updatePeopleTab(); }); }); } };
    function loadQuickChatFriends() { const div = document.getElementById('quick-chat-friends'); if(myFriends.length === 0) { div.innerHTML = '<span class="text-xs text-gray-400">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶®‡ßá‡¶á</span>'; return; } let tempHtml = ''; const friendsToLoad = myFriends.slice(0, 15); let loaded = 0; friendsToLoad.forEach(uid => { get(ref(db, `users/${uid}`)).then(uSnap => { const u = uSnap.val(); if(u) { let av = `<div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-700 font-bold text-lg relative">${escapeHTML(u.name).charAt(0)}<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div></div>`; if(u.profile_pic) av = `<div class="w-12 h-12 relative"><img src="${u.profile_pic}" class="w-full h-full rounded-full object-cover"><div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div></div>`; tempHtml += `<div onclick="startChat('${u.uid}', '${escapeHTML(u.name)}')" class="flex flex-col items-center cursor-pointer min-w-[50px]">${av}<span class="text-[10px] text-gray-600 mt-1 truncate w-14 text-center font-bold">${escapeHTML(u.name).split(' ')[0]}</span></div>`; } loaded++; if(loaded === friendsToLoad.length) div.innerHTML = tempHtml; }); }); }
    window.openDirectoryCategory = (category, title) => { switchPage('directory-list'); document.getElementById('directory-list-title').innerText = title; const container = document.getElementById('directory-items-container'); container.innerHTML = '<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>'; onValue(ref(db, `directory/${category}`), (snap) => { const data = snap.val(); if(data) { let html = ''; Object.values(data).forEach(item => { html += `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-blue-50 rounded-full text-blue-600 flex items-center justify-center text-xl"><i class="fa-solid fa-user-tie"></i></div><div><h4 class="font-bold text-gray-800 text-lg">${escapeHTML(item.name)}</h4><p class="text-sm text-gray-500">${escapeHTML(item.details) || title}</p><p class="text-xs text-gray-400 mt-1"><i class="fa-solid fa-location-dot"></i> ${escapeHTML(item.address) || '‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶®‡ßá‡¶á'}</p></div></div><div class="flex gap-2"><a href="tel:${item.phone}" class="bg-green-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow hover:bg-green-600"><i class="fa-solid fa-phone"></i></a></div></div>`; }); container.innerHTML = html; } else { container.innerHTML = `<div class="text-center py-10"><i class="fa-regular fa-folder-open text-4xl text-gray-300 mb-3"></i><p class="text-gray-400">‡¶è‡¶á ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p></div>`; } }); }
    window.openUserProfile = (uid) => { if(uid === window.currentUser.uid) { switchPage('profile'); return; } const nameEl = document.getElementById('view-profile-name'); if(!nameEl) return; switchPage('view-profile'); history.pushState({ page: 'view-profile', uid }, "", "#profile-view"); document.getElementById('view-profile-name').innerText = "‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá..."; document.getElementById('view-profile-avatar-container').innerHTML = "..."; document.getElementById('view-profile-union-badge').innerText = "..."; document.getElementById('view-profile-village-text').innerText = "..."; document.getElementById('view-profile-posts-feed').innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>'; document.getElementById('view-profile-actions').innerHTML = ''; document.getElementById('view-profile-phone').innerHTML = '---'; document.getElementById('btn-view-friends-other').setAttribute('onclick', `showAllFriends('${uid}')`); get(ref(db, 'users/' + uid)).then(snap => { const user = snap.val(); if(user) { const badge = checkUserBadge(user); let avatarHtml = `<span class="text-5xl">${user.name ? escapeHTML(user.name).charAt(0) : 'U'}</span>`; if(user.profile_pic) avatarHtml = `<img src="${user.profile_pic}" class="w-full h-full object-cover">`; document.getElementById('view-profile-avatar-container').innerHTML = avatarHtml; document.getElementById('view-profile-name').innerHTML = (escapeHTML(user.name) || "‡¶Ö‡¶ú‡ßç‡¶û‡¶æ‡¶§") + badge; document.getElementById('view-profile-union-badge').innerText = user.union || "‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶®‡ßá‡¶á"; document.getElementById('view-profile-village-text').innerText = user.village || "‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á"; document.getElementById('view-profile-profession').innerText = escapeHTML(user.profession) || "‡¶™‡ßá‡¶∂‡¶æ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á"; document.getElementById('view-profile-location').innerText = escapeHTML(user.location) || "‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á"; document.getElementById('view-profile-bio').innerText = escapeHTML(user.bio) || "‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á"; if(user.privacy_hide_contact) document.getElementById('view-profile-phone').innerText = "‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º"; else document.getElementById('view-profile-phone').innerText = user.phone || "‡¶´‡ßã‡¶® ‡¶®‡ßá‡¶á"; checkFriendshipStatus(uid, user.name); loadProfilePosts(uid, 'view-profile-posts-feed'); loadFriendsPreview(uid, 'other'); } else { showToast("‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!", 'error'); switchPage('home'); } }).catch(err => { console.error(err); showToast("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá", 'error'); switchPage('home'); }); };
    window.loadFriendsPreview = (uid, mode) => { const container = document.getElementById(mode === 'me' ? 'profile-friends-preview-me' : 'profile-friends-preview-other'); const countSpan = document.getElementById(mode === 'me' ? 'friends-count-me' : 'friends-count-other'); container.innerHTML = '<p class="col-span-3 text-center text-xs text-gray-400">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>'; get(ref(db, `users/${uid}/friends`)).then(snap => { if(snap.exists()) { const friends = Object.keys(snap.val()); countSpan.innerText = `${friends.length} ‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ`; let html = ''; let loadedCount = 0; if(friends.length === 0) { container.innerHTML = '<p class="col-span-3 text-center text-xs text-gray-400 py-2">‡¶è‡¶ñ‡¶®‡ßã ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶®‡ßá‡¶á</p>'; return; } friends.slice(0, 6).forEach(friendUid => { get(ref(db, `users/${friendUid}`)).then(uSnap => { const uData = uSnap.val(); if(uData){ let av = `<span class="text-2xl">${escapeHTML(uData.name).charAt(0)}</span>`; if(uData.profile_pic) av = `<img src="${uData.profile_pic}" class="w-full h-full object-cover">`; html += `<div onclick="openUserProfile('${friendUid}')" class="flex flex-col items-center cursor-pointer"><div class="w-full aspect-square bg-gray-100 rounded-lg flex items-center justify-center text-gray-500 font-bold mb-1 border border-gray-200 overflow-hidden shadow-sm">${av}</div><p class="text-[11px] font-semibold text-gray-800 truncate w-full leading-tight mt-0.5">${escapeHTML(uData.name).split(' ')[0]}</p></div>`; } loadedCount++; if(loadedCount === Math.min(friends.length, 6)) container.innerHTML = html; }); }); } else { container.innerHTML = '<p class="col-span-3 text-center text-xs text-gray-400 py-2">‡¶è‡¶ñ‡¶®‡ßã ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶®‡ßá‡¶á</p>'; countSpan.innerText = `0 ‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ`; } }); };
    window.showAllFriends = (uid) => { const targetUid = uid === 'me' ? window.currentUser.uid : uid; switchPage('friends-list'); const container = document.getElementById('all-friends-container'); container.innerHTML = '<div class="flex justify-center pt-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div></div>'; get(ref(db, `users/${targetUid}/friends`)).then(snap => { if(snap.exists()) { const friends = Object.keys(snap.val()); let html = ''; let count = 0; friends.forEach(fUid => { get(ref(db, `users/${fUid}`)).then(uSnap => { const u = uSnap.val(); if(u) { let av = `<div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold">${u.name?escapeHTML(u.name).charAt(0):'U'}</div>`; if(u.profile_pic) av = `<img src="${u.profile_pic}" class="w-10 h-10 rounded-full object-cover">`; html += `<div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer" onclick="openUserProfile('${fUid}')"><div class="flex items-center gap-3">${av}<div><h4 class="font-bold text-gray-800 text-sm">${escapeHTML(u.name)}</h4><p class="text-xs text-gray-500">${escapeHTML(u.profession) || '‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø'}</p></div></div></div>`; } count++; if(count === friends.length) container.innerHTML = html; }); }); } else container.innerHTML = '<p class="text-center text-gray-400 mt-10">‡¶ï‡ßã‡¶®‡ßã ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶®‡ßá‡¶á</p>'; }); };
    function checkFriendshipStatus(targetUid, targetName) { const actionDiv = document.getElementById('view-profile-actions'); actionDiv.innerHTML = '<button class="w-full bg-gray-200 py-2 rounded-lg text-sm font-bold">Checking...</button>'; get(ref(db, `users/${window.currentUser.uid}/friends/${targetUid}`)).then(snap => { if(snap.exists()) { actionDiv.innerHTML = `<button onclick="startChat('${targetUid}', '${escapeHTML(targetName)}')" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold text-sm shadow hover:bg-blue-700 flex items-center justify-center gap-2"><i class="fa-brands fa-facebook-messenger"></i> ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</button><button onclick="unfriend('${targetUid}')" class="w-12 bg-red-100 text-red-600 py-2 rounded-lg font-bold text-sm hover:bg-red-200 flex items-center justify-center"><i class="fa-solid fa-user-xmark"></i></button>`; } else { get(ref(db, `friend_requests/${targetUid}/${window.currentUser.uid}`)).then(reqSnap => { if(reqSnap.exists()) { actionDiv.innerHTML = `<button onclick="toggleFriendRequest('${targetUid}')" class="flex-1 bg-gray-200 text-gray-600 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2">Cancel Request</button>`; } else { get(ref(db, `friend_requests/${window.currentUser.uid}/${targetUid}`)).then(incomingSnap => { if(incomingSnap.exists()) { actionDiv.innerHTML = `<button onclick="acceptRequest('${targetUid}')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold text-sm shadow hover:bg-green-700 flex items-center justify-center gap-2">Confirm</button><button onclick="cancelRequest('${targetUid}', true)" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-bold text-sm hover:bg-gray-300 flex items-center justify-center gap-2">Delete</button>`; } else { actionDiv.innerHTML = `<button onclick="sendFriendRequest('${targetUid}')" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold text-sm shadow hover:bg-blue-700 flex items-center justify-center gap-2"><i class="fa-solid fa-user-plus"></i> ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°</button><button onclick="startChat('${targetUid}', '${escapeHTML(targetName)}')" class="flex-1 bg-gray-200 text-black py-2 rounded-lg font-bold text-sm hover:bg-gray-300 flex items-center justify-center gap-2"><i class="fa-brands fa-facebook-messenger"></i> ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</button>`; } }); } }); } }); }
    window.sendFriendRequest = (toUid) => { set(ref(db, `friend_requests/${toUid}/${window.currentUser.uid}`), { fromName: userDetails.name, fromUid: window.currentUser.uid, timestamp: Date.now() }).then(() => { showToast("‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); checkFriendshipStatus(toUid, "User"); }); };
    function listenForFriendRequests(uid) { onValue(ref(db, `friend_requests/${uid}`), (snap) => { updatePeopleTab(); }); }
    
    // --- UPDATED NOTIFICATION SYSTEM (Read, Types, Single Post) ---
    function listenForNotifications(uid) { 
        const list = document.getElementById('notifications-list'); 
        onValue(ref(db, `notifications/${uid}`), (notifSnap) => { 
            const notifs = notifSnap.val() || {}; 
            let html = ''; 
            let unreadCount = 0; 
            Object.entries(notifs).reverse().forEach(([key, n]) => { 
                if(!n.read) unreadCount++; 
                const bgClass = n.read ? 'bg-white' : 'bg-blue-50';
                
                if(n.type === 'new_post' || n.type === 'like' || n.type === 'comment') { 
                    let icon = 'fa-rss', color = 'text-blue-600', bg = 'bg-blue-100', text = '‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®';
                    if (n.type === 'like') { icon = 'fa-thumbs-up'; color = 'text-green-600'; bg = 'bg-green-100'; text = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá ‡¶≤‡¶æ‡¶á‡¶ï ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®'; }
                    if (n.type === 'comment') { icon = 'fa-comment'; color = 'text-purple-600'; bg = 'bg-purple-100'; text = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®'; }

                    html += `<div class="${bgClass} p-3 rounded-xl shadow-sm border-l-4 border-blue-400 flex justify-between items-center mb-3 cursor-pointer" onclick="handleNotificationClick('${key}', '${n.postId}', '${n.type}')"><div class="flex items-center gap-3"><div class="w-10 h-10 ${bg} rounded-full flex items-center justify-center ${color} font-bold"><i class="fa-solid ${icon}"></i></div><div><h4 class="font-bold text-gray-800 text-sm">${escapeHTML(n.fromName)}</h4><p class="text-xs text-gray-500">${text}</p><p class="text-[10px] text-gray-400">${timeAgo(n.timestamp)}</p></div></div></div>`; 
                } 
                if(n.type === 'blood_req') { 
                    html += `<div class="${bgClass} p-3 rounded-xl shadow-sm border-l-4 border-red-600 flex justify-between items-center mb-3"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600 font-bold"><i class="fa-solid fa-droplet"></i></div><div><h4 class="font-bold text-red-800 text-sm">‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶∞‡¶ï‡ßç‡¶§ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®! (${n.group})</h4><p class="text-xs text-gray-600">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó: ${n.contact}</p><p class="text-[10px] text-gray-400">${timeAgo(n.timestamp)}</p></div></div><a href="tel:${n.contact}" class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white"><i class="fa-solid fa-phone"></i></a></div>`; 
                } 
            }); 
            if(!html) html = '<p class="text-center text-gray-400 mt-10">‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶®‡ßá‡¶á</p>'; 
            list.innerHTML = html; 
            const headerBadge = document.getElementById('header-badge-notice'); 
            if(unreadCount > 0) { headerBadge.innerText = unreadCount; headerBadge.classList.add('active'); } 
            else { headerBadge.classList.remove('active'); } 
        }); 
    }

    window.handleNotificationClick = (notifId, postId, type) => {
        // Mark as read
        update(ref(db, `notifications/${window.currentUser.uid}/${notifId}`), { read: true });
        
        // Action
        if (type === 'new_post') {
            openSinglePostModal(postId);
        } else if (type === 'like' || type === 'comment') {
            // Also open post modal to see the interaction
            openSinglePostModal(postId);
        }
    };

    window.openSinglePostModal = (postId) => {
        const modal = document.getElementById('single-post-modal');
        const content = document.getElementById('single-post-content');
        modal.classList.remove('hidden-custom');
        content.innerHTML = '<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div></div>';
        
        get(ref(db, `posts/${postId}`)).then(snap => {
            if(snap.exists()) {
                content.innerHTML = createPostHTML(snap.val(), postId);
            } else {
                content.innerHTML = '<p class="text-center text-gray-400 mt-10">‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶ü‡¶ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p>';
            }
        });
    };

    window.acceptRequest = (fromUid) => { const updates = {}; updates[`users/${window.currentUser.uid}/friends/${fromUid}`] = true; updates[`users/${fromUid}/friends/${window.currentUser.uid}`] = true; updates[`friend_requests/${window.currentUser.uid}/${fromUid}`] = null; update(ref(db), updates).then(() => { showToast("‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶™‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); get(ref(db, `users/${window.currentUser.uid}/friends`)).then((snap) => { myFriends = snap.exists() ? Object.keys(snap.val()) : []; updatePeopleTab(); loadQuickChatFriends(); }); if(document.getElementById('page-view-profile').classList.contains('hidden') === false) { checkFriendshipStatus(fromUid, "User"); } }); };
    window.cancelRequest = (fromUid, isDelete) => { const path = isDelete ? `friend_requests/${window.currentUser.uid}/${fromUid}` : `friend_requests/${fromUid}/${window.currentUser.uid}`; remove(ref(db, path)).then(() => { showToast("‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü/‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); if(document.getElementById('page-view-profile').classList.contains('hidden') === false) { checkFriendshipStatus(fromUid, "User"); } if(!isDelete) { const btn = document.getElementById(`btn-req-${fromUid}`); if(btn) { btn.classList.remove('bg-gray-200', 'text-gray-600'); btn.classList.add('bg-blue-50', 'text-blue-600'); btn.innerHTML = 'Add'; btn.disabled = false; } } }); };
    window.startChat = (uid, name) => { currentChatUser = { uid, name }; switchPage('messages'); document.getElementById('chat-list-view').classList.add('hidden-custom'); document.getElementById('chat-conversation-view').classList.remove('hidden-custom'); document.getElementById('chat-header-name').innerText = escapeHTML(name); document.getElementById('chat-header-img').innerText = escapeHTML(name).charAt(0); history.pushState({ page: 'chat-conversation', uid }, "", "#chat"); loadMessages(uid); };
    window.closeChat = () => { document.getElementById('chat-list-view').classList.remove('hidden-custom'); document.getElementById('chat-conversation-view').classList.add('hidden-custom'); currentChatUser = null; };
    function getChatId(uid1, uid2) { return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`; }
    function loadChatList(uid) { onValue(ref(db, `user_chats/${uid}`), (snap) => { const list = snap.val(); const container = document.getElementById('chat-list-container'); if(list) { let html = ''; Object.entries(list).sort((a,b)=>b[1].timestamp - a[1].timestamp).forEach(([peerUid, info]) => { if(!info || !info.name) return; let av = `<div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center font-bold text-green-700 text-xl">${escapeHTML(info.name).charAt(0)}</div>`; html += `<div onclick="startChat('${peerUid}', '${escapeHTML(info.name)}')" class="p-4 border-b bg-white hover:bg-gray-50 cursor-pointer flex items-center gap-3">${av}<div class="flex-1"><div class="flex justify-between"><h4 class="font-bold text-gray-800 text-base">${escapeHTML(info.name)}</h4><span class="text-[10px] text-gray-400">${timeAgo(info.timestamp)}</span></div><p class="text-sm text-gray-500 truncate">${escapeHTML(info.lastMessage)}</p></div></div>`; }); container.innerHTML = html; } else container.innerHTML = '<p class="text-center text-gray-400 mt-10 text-sm">‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡¶∏‡ßá‡¶∂‡¶® ‡¶®‡ßá‡¶á</p>'; }); }
    function loadMessages(otherUid) { const chatId = getChatId(window.currentUser.uid, otherUid); const div = document.getElementById('messages-container'); div.innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶•‡ßã‡¶™‡¶ï‡¶•‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>'; const messagesQuery = query(ref(db, `chats/${chatId}`), limitToLast(50)); onValue(messagesQuery, (snap) => { const msgs = snap.val(); if(msgs) { let html = ''; Object.values(msgs).forEach(m => { const isMe = m.sender === window.currentUser.uid; html += `<div class="flex ${isMe ? 'justify-end' : 'justify-start'} mb-2"><div class="px-4 py-2 max-w-[70%] text-sm ${isMe ? 'chat-bubble-me' : 'chat-bubble-other'}">${escapeHTML(m.text)}</div></div>`; }); div.innerHTML = html; requestAnimationFrame(() => { div.scrollTop = div.scrollHeight; }); } }); }
    window.sendMsg = () => { if(!currentChatUser) return; const input = document.getElementById('msg-input'); const text = input.value.trim(); if(!text) return; const chatId = getChatId(window.currentUser.uid, currentChatUser.uid); const ts = Date.now(); push(ref(db, `chats/${chatId}`), { sender: window.currentUser.uid, text: text, timestamp: ts }); const myUpdate = { name: currentChatUser.name, lastMessage: "You: " + text, timestamp: ts }; const peerUpdate = { name: userDetails.name, lastMessage: text, timestamp: ts }; update(ref(db, `user_chats/${window.currentUser.uid}/${currentChatUser.uid}`), myUpdate); update(ref(db, `user_chats/${currentChatUser.uid}/${window.currentUser.uid}`), peerUpdate); input.value = ""; };
    onValue(ref(db, 'notices'), (snapshot) => { const data = snapshot.val(); if(data) { const notice = Object.values(data).pop(); document.getElementById('live-notices').innerHTML = `<div class="bg-orange-50 p-4 m-3 rounded-xl border-l-4 border-orange-500 flex items-start gap-3 shadow-sm"><i class="fa-solid fa-bullhorn text-orange-600 mt-1"></i><div><h3 class="font-bold text-orange-900 text-sm">${escapeHTML(notice.title)}</h3><p class="text-xs text-orange-800 line-clamp-2 mt-1">${escapeHTML(notice.description)}</p></div></div>`; } });
    window.submitProduct = async () => { const title = document.getElementById('sell-title').value.trim(); const price = document.getElementById('sell-price').value.trim(); const desc = document.getElementById('sell-desc').value.trim(); const file = document.getElementById('sell-image-file').files[0]; if(!title) return; const btn = document.getElementById('btn-sell-submit'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; btn.disabled = true; let imgUrl = ""; try { if (file) imgUrl = await uploadImageToImgBB(file); push(ref(db, 'market_items'), { uid: window.currentUser.uid, seller: userDetails.name, title, price, desc, image: imgUrl, time: Date.now() }).then(() => { toggleSellModal(false); document.getElementById('sell-title').value = ""; showToast("‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); }); } catch(e) { console.error(e); showToast("‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶°‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + e.message, 'error'); } finally { btn.innerText = "‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡¶ø‡¶®"; btn.disabled = false; } };
    onValue(ref(db, 'market_items'), (snap) => { const div = document.getElementById('market-list'); const data = snap.val(); globalMarketItems = []; if(data) { globalMarketItems = Object.values(data); let html = ''; globalMarketItems.reverse().forEach(item => { const imgTag = item.image ? `<img src="${item.image}" class="h-full w-full object-cover">` : `<i class="fa-solid fa-image text-3xl"></i>`; html += `<div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex flex-col justify-between"><div><div class="h-24 bg-gray-100 rounded-lg mb-2 flex items-center justify-center text-gray-300 overflow-hidden">${imgTag}</div><h3 class="font-bold text-sm text-gray-800 line-clamp-1">${escapeHTML(item.title)}</h3><p class="text-orange-600 font-bold text-sm">‡ß≥ ${escapeHTML(item.price)}</p><p class="text-[10px] text-gray-500 line-clamp-2 mt-1">${escapeHTML(item.desc)}</p></div><div class="mt-2 pt-2 border-t flex justify-between items-center"><span class="text-[10px] text-gray-400">${escapeHTML(item.seller).split(' ')[0]}</span><button class="bg-green-500 text-white px-2 py-1 rounded text-xs"><i class="fa-solid fa-phone"></i></button></div></div>`; }); div.innerHTML = html; } else div.innerHTML = '<p class="col-span-2 text-center text-gray-400 py-10">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á</p>'; });
    window.submitDonor = () => { const bloodGroup = document.getElementById('donor-blood-group').value; const phone = document.getElementById('donor-phone').value; const lastDate = document.getElementById('donor-last-date').value; if(!bloodGroup || !phone) return showToast("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®!", 'error'); set(ref(db, 'donors/' + window.currentUser.uid), { name: userDetails.name, bloodGroup, phone, lastDate, uid: window.currentUser.uid, union: userDetails.union || '', village: userDetails.village || '' }).then(() => { showToast("‡¶Ü‡¶™‡¶®‡¶ø ‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡¶®!"); toggleDonorModal(false); }); };
    window.sendEmergencyBloodRequest = () => { const group = document.getElementById('req-blood-group').value; const location = document.getElementById('req-location').value.trim(); const contact = document.getElementById('req-contact').value.trim(); if(!group || !contact) return showToast("‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï", 'error'); const btn = document.getElementById('btn-blood-req'); const originalText = btn.innerText; btn.innerText = "‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá..."; btn.disabled = true; const donorsRef = ref(db, 'donors'); get(donorsRef).then((snapshot) => { const data = snapshot.val(); let count = 0; if(data) { Object.values(data).forEach(donor => { if(donor.bloodGroup === group) { push(ref(db, `notifications/${donor.uid}`), { type: 'blood_req', group: group, location: location, contact: contact, timestamp: Date.now(), read: false }); count++; } }); } showToast(`${count} ‡¶ú‡¶® ‡¶°‡ßã‡¶®‡¶æ‡¶∞‡¶ï‡ßá ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!`); toggleBloodRequestModal(false); btn.innerText = originalText; btn.disabled = false; }).catch(e => { showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + e.message, 'error'); btn.innerText = originalText; btn.disabled = false; }); }
    onValue(ref(db, 'donors'), (snapshot) => { allDonors = []; const data = snapshot.val(); if(data) { allDonors = Object.values(data); filterDonors(); } else document.getElementById('donor-list').innerHTML = '<div class="text-center p-6 text-gray-400">‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶®‡ßá‡¶á</div>'; });
    window.filterDonors = () => { const bgFilter = document.getElementById('blood-filter').value; const unionFilter = document.getElementById('blood-union-filter').value; const listDiv = document.getElementById('donor-list'); const filtered = allDonors.filter(d => { const bgMatch = bgFilter === 'all' || d.bloodGroup === bgFilter; const unionMatch = unionFilter === 'all' || d.union === unionFilter; return bgMatch && unionMatch; }); if(filtered.length === 0) { listDiv.innerHTML = '<div class="text-center p-6 text-gray-400">‡¶è‡¶á ‡¶∂‡¶∞‡ßç‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶®‡ßá‡¶á</div>'; return; } let html = ''; filtered.forEach(donor => { html += `<div class="bg-white p-4 rounded-xl shadow-sm border border-red-50 flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600 font-bold text-xs border border-red-200">${escapeHTML(donor.bloodGroup)}</div><div><p class="font-bold text-gray-800 text-sm">${escapeHTML(donor.name)}</p><p class="text-[10px] text-gray-500 mt-0.5"><i class="fa-solid fa-location-dot mr-1"></i>${escapeHTML(donor.union || 'Unknown')}</p><p class="text-[10px] text-gray-500 mt-0.5"><i class="fa-regular fa-calendar mr-1"></i>‡¶∂‡ßá‡¶∑ ‡¶¶‡¶æ‡¶®: ${escapeHTML(donor.lastDate)}</p></div></div><a href="tel:${donor.phone}" class="bg-green-500 text-white w-9 h-9 rounded-full flex items-center justify-center shadow hover:bg-green-600"><i class="fa-solid fa-phone text-sm"></i></a></div>`; }); listDiv.innerHTML = html; };
    window.submitComplaint = () => { const type = document.getElementById('complaint-type').value; const submitTo = document.getElementById('complaint-to').value; const text = document.getElementById('complaint-text').value.trim(); const isAnon = document.getElementById('complaint-anon').checked; if(!text) return showToast("‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®", 'error'); const complaintData = { uid: window.currentUser.uid, authorName: isAnon ? "‡¶®‡¶æ‡¶Æ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡ßá ‡¶Ö‡¶®‡¶ø‡¶ö‡ßç‡¶õ‡ßÅ‡¶ï" : userDetails.name, type: type, submitTo: submitTo, text: text, timestamp: Date.now(), status: 'Pending', union: userDetails.union || 'Unknown', village: userDetails.village || 'Unknown' }; push(ref(db, 'complaints'), complaintData).then(() => { showToast("‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); document.getElementById('complaint-text').value = ""; document.getElementById('complaint-anon').checked = false; }).catch(e => showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + e.message, 'error')); };
    window.loadMyComplaints = () => { const listDiv = document.getElementById('my-complaints-list'); onValue(query(ref(db, 'complaints'), orderByChild('uid'), startAt(window.currentUser.uid), endAt(window.currentUser.uid)), (snap) => { const data = snap.val(); if(data) { let html = ''; Object.values(data).sort((a,b)=>b.timestamp - a.timestamp).forEach(c => { let statusColor = 'text-yellow-600 bg-yellow-100'; let statusText = '‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'; if(c.status === 'Processing') { statusColor = 'text-blue-600 bg-blue-100'; statusText = '‡¶ï‡¶æ‡¶ú ‡¶ö‡¶≤‡¶õ‡ßá'; } if(c.status === 'Resolved') { statusColor = 'text-green-600 bg-green-100'; statusText = '‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá'; } html += `<div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100"><div class="flex justify-between items-start mb-1"><span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded">To: ${c.submitTo}</span><span class="text-[10px] font-bold px-2 py-0.5 rounded ${statusColor}">${statusText}</span></div><p class="text-sm text-gray-800 mt-2">${escapeHTML(c.text)}</p><p class="text-[10px] text-gray-400 mt-2 text-right">${timeAgo(c.timestamp)}</p></div>`; }); listDiv.innerHTML = html; } else { listDiv.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶®‡ßá‡¶á</p>'; } }); };
    window.submitVerification = async () => { const nid = document.getElementById('verify-nid').value.trim(); const docFile = document.getElementById('verify-doc-img').files[0]; const userFile = document.getElementById('verify-user-img').files[0]; if(!nid || !docFile || !userFile) return showToast("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶ì ‡¶õ‡¶¨‡¶ø ‡¶¶‡¶ø‡¶®!", 'error'); const btn = document.getElementById('btn-verify-submit'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; btn.disabled = true; try { const docUrl = await uploadImageToImgBB(docFile); const userUrl = await uploadImageToImgBB(userFile); await set(ref(db, 'verification_requests/' + window.currentUser.uid), { uid: window.currentUser.uid, name: userDetails.name, nid: nid, docImage: docUrl, userImage: userUrl, timestamp: Date.now(), status: 'pending' }); showToast("‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶¨‡ßá‡¶®‡•§"); document.getElementById('verification-modal').classList.add('hidden-custom'); } catch(e) { console.error(e); showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + e.message, 'error'); } finally { btn.innerHTML = "‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®"; btn.disabled = false; } }
    window.togglePrivacy = (checked) => { update(ref(db, 'users/' + window.currentUser.uid), { privacy_hide_contact: checked }).then(() => showToast("‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá")); };
    window.changeFontSize = (size) => { const body = document.getElementById('body-main'); body.classList.remove('text-small', 'text-large'); if(size === 'small') body.classList.add('text-small'); if(size === 'large') body.classList.add('text-large'); localStorage.setItem('fontSize', size); };
    window.handleDeleteAccount = () => { const confirmDelete = prompt("‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá 'DELETE' ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:"); if (confirmDelete === 'DELETE') { update(ref(db, 'users/' + window.currentUser.uid), { deleted: true, email: 'deleted', phone: 'deleted' }).then(() => { deleteUser(window.currentUser).then(() => { alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); window.location.reload(); }).catch(e => showToast("Login again to delete: " + e.message, 'error')); }); } };
    window.toggleGlobalSearch = (open) => { const modal = document.getElementById('search-modal'); if(open) { modal.classList.remove('hidden-custom'); setTimeout(()=>modal.classList.add('open'), 10); document.getElementById('global-search-input').focus(); } else { modal.classList.remove('open'); setTimeout(()=>modal.classList.add('hidden-custom'), 300); } }
    window.handleGlobalSearch = (queryVal) => { const container = document.getElementById('global-search-results'); const q = queryVal.toLowerCase().trim(); if(q.length < 1) { container.innerHTML = '<div class="text-center mt-20 text-gray-400"><i class="fa-solid fa-magnifying-glass text-4xl mb-3 opacity-30"></i><p>‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</p></div>'; return; } let html = ''; const matchedUsers = allUsers.filter(u => u.name.toLowerCase().includes(q)); if(matchedUsers.length > 0) { html += `<h4 class="font-bold text-xs text-gray-500 mb-2 mt-2">‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑</h4>`; matchedUsers.slice(0, 3).forEach(u => { const badge = checkUserBadge(u); html += `<div onclick="openUserProfile('${u.uid}'); toggleGlobalSearch(false)" class="bg-white p-3 rounded-lg shadow-sm flex items-center gap-3 cursor-pointer"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-xs">${u.name.charAt(0)}</div><span class="text-sm font-bold text-gray-800">${u.name}${badge}</span></div>`; }); } const matchedMarket = globalMarketItems.filter(i => i.title.toLowerCase().includes(q)); if(matchedMarket.length > 0) { html += `<h4 class="font-bold text-xs text-gray-500 mb-2 mt-4">‡¶π‡¶æ‡¶ü / ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞</h4>`; matchedMarket.slice(0, 3).forEach(i => { html += `<div onclick="switchPage('market'); toggleGlobalSearch(false)" class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center cursor-pointer"><span class="text-sm font-bold text-gray-800">${i.title}</span><span class="text-xs text-orange-600 font-bold">‡ß≥ ${i.price}</span></div>`; }); } let dirMatches = []; Object.entries(globalDirectory).forEach(([cat, items]) => { Object.values(items).forEach(item => { if(item.name.toLowerCase().includes(q)) dirMatches.push(item); }); }); if(dirMatches.length > 0) { html += `<h4 class="font-bold text-xs text-gray-500 mb-2 mt-4">‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø</h4>`; dirMatches.slice(0, 3).forEach(i => { html += `<div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center"><span class="text-sm font-bold text-gray-800">${i.name}</span><a href="tel:${i.phone}" class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs"><i class="fa-solid fa-phone"></i></a></div>`; }); } if(html === '') container.innerHTML = '<div class="text-center mt-10 text-gray-400"><p>‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p></div>'; else container.innerHTML = html; }
</script>

<script>
    function toggleAuth(v){ const login = document.getElementById('login-form'); const reg = document.getElementById('register-form'); const forgot = document.getElementById('forgot-form'); login.classList.add('hidden-custom'); reg.classList.add('hidden-custom'); forgot.classList.add('hidden-custom'); if(v === 'login') login.classList.remove('hidden-custom'); else if(v === 'register') reg.classList.remove('hidden-custom'); else if(v === 'forgot') forgot.classList.remove('hidden-custom'); }
    
    // Updated togglePostModal to inject user data
    function togglePostModal(s){ 
        const m = document.getElementById('post-modal'); 
        if(s) { 
            m.classList.remove('hidden-custom'); 
            history.pushState({modal: 'post'}, null, "#create-post"); 
            // Inject User Data dynamically
            if(window.currentUser) {
                const nameEl = document.getElementById('sidebar-name'); // Getting name from sidebar since we don't have direct access to userDetails here easily without global
                const userImgEl = document.getElementById('sidebar-avatar-container');
                if(nameEl) document.getElementById('post-modal-user-name').innerText = nameEl.innerText;
                if(userImgEl) document.getElementById('post-modal-user-img').innerHTML = userImgEl.innerHTML;
            }
        } else { 
            m.classList.add('hidden-custom'); 
            if(history.state && history.state.modal) history.back(); 
        } 
    }
    
    function togglePollModal(s){ const m = document.getElementById('poll-modal'); if(s) { m.classList.remove('hidden-custom'); history.pushState({modal: 'poll'}, null, "#create-poll"); } else { m.classList.add('hidden-custom'); if(history.state && history.state.modal) history.back(); } }
    function toggleDonorModal(s){ document.getElementById('donor-modal').classList[s?'remove':'add']('hidden-custom'); }
    function toggleBloodRequestModal(s){ document.getElementById('modal-blood-request').classList[s?'remove':'add']('hidden-custom'); }
    function toggleEditProfile(s){ document.getElementById('edit-profile-modal').classList[s?'remove':'add']('hidden-custom'); }
    function toggleSellModal(s){ document.getElementById('sell-modal').classList[s?'remove':'add']('hidden-custom'); }
    function toggleSidebar(open) { const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebar-overlay'); if(open) { sb.classList.add('open'); ov.classList.remove('hidden-custom'); setTimeout(()=>ov.classList.add('open'), 10); } else { sb.classList.remove('open'); ov.classList.remove('open'); setTimeout(()=>ov.classList.add('hidden-custom'), 300); } }
    let fabOpen = false; function toggleFab() { fabOpen = !fabOpen; const opts = document.getElementById('fab-options'); const main = document.getElementById('main-fab'); if(fabOpen) { opts.classList.add('show'); main.classList.add('rotate'); } else { opts.classList.remove('show'); main.classList.remove('rotate'); } }
    function switchPage(id, addHistory = true){ document.querySelectorAll('.post-menu-dropdown').forEach(el => el.classList.add('hidden')); const pages = ['home','services','market','blood','directory','directory-list','profile','people','messages','notifications','view-profile','friends-list', 'complaints', 'settings', 'dynamic-content']; pages.forEach(p => { const el = document.getElementById('page-'+p); if(el) el.classList.add('hidden'); document.getElementById('btn-'+p)?.classList.remove('nav-active','text-green-600'); document.getElementById('btn-'+p)?.classList.add('text-gray-500'); }); const targetPage = document.getElementById('page-'+id); if(targetPage) targetPage.classList.remove('hidden'); const btn = document.getElementById('btn-'+id); if(btn) { btn.classList.add('nav-active','text-green-600'); btn.classList.remove('text-gray-500'); } window.scrollTo(0,0); if(id === 'profile') { if(typeof window.loadProfilePosts === 'function' && window.currentUser) { window.loadProfilePosts(window.currentUser.uid, 'my-posts-feed'); } } if(id === 'notifications') { document.getElementById('nav-badge-notice').classList.remove('active'); document.getElementById('header-badge-notice').classList.remove('active'); } if(addHistory) { history.pushState({ page: id }, "", `#${id}`); } }
    window.onpopstate = function(event) { 
        if(document.getElementById('post-modal') && !document.getElementById('post-modal').classList.contains('hidden-custom')) { document.getElementById('post-modal').classList.add('hidden-custom'); return; } 
        if(document.getElementById('poll-modal') && !document.getElementById('poll-modal').classList.contains('hidden-custom')) { document.getElementById('poll-modal').classList.add('hidden-custom'); return; } 
        if(document.getElementById('search-modal') && document.getElementById('search-modal').classList.contains('open')) { toggleGlobalSearch(false); return; } 
        if(document.getElementById('single-post-modal') && !document.getElementById('single-post-modal').classList.contains('hidden-custom')) { document.getElementById('single-post-modal').classList.add('hidden-custom'); return; }
        if (event.state && event.state.page) { 
            if(event.state.page === 'comment-modal') { closeFullCommentModal(); history.back(); } 
            else if (event.state.page === 'chat-conversation') { closeChat(); } 
            else { switchPage(event.state.page, false); } 
        } else { switchPage('home', false); } 
    };
    window.addEventListener('click', function(e){ if(!e.target.closest('.relative')) document.querySelectorAll('.post-menu-dropdown').forEach(el => el.classList.add('hidden')); });
</script>

</body>
</html>