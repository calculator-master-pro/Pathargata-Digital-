<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ - ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶¨‡¶æ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Font: Hind Siliguri -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- CryptoJS for Encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        /* Base Font Size & Copy Protection */
        body { 
            font-family: 'Hind Siliguri', sans-serif; 
            background-color: #f0f2f5; 
            font-size: 16px; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
            -webkit-user-select: none; 
            -ms-user-select: none; 
            user-select: none; 
        }
        
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        .app-container { max-width: 480px; margin: 0 auto; background: #ffffff; min-height: 100vh; position: relative; padding-bottom: calc(75px + env(safe-area-inset-bottom)); }
        
        /* Nav Buttons */
        .nav-active { color: #16a34a; border-top: 2px solid #16a34a; }
        .nav-btn { color: #65676b; position: relative; transition: all 0.2s ease-in-out; }
        .nav-btn:active { transform: scale(0.9); }
        .nav-btn i { font-size: 1.6rem; margin-bottom: 2px; transition: transform 0.5s ease; }
        .nav-btn p { font-size: 0.75rem; font-weight: 600; }

        .hidden-custom { display: none !important; }
        
        input:focus, select:focus, textarea:focus { outline: 2px solid #16a34a; border-color: transparent; }

        button, .cursor-pointer { transition: transform 0.1s ease, background-color 0.2s ease; }
        button:active { transform: scale(0.96); }

        /* Sidebar Animation */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-100%); }
        #sidebar.open { transform: translateX(0); }
        .sidebar-overlay { transition: opacity 0.3s; opacity: 0; pointer-events: none; }
        .sidebar-overlay.open { opacity: 1; pointer-events: auto; }
        
        .sidebar-item { border-radius: 0 50px 50px 0; margin-right: 15px; position: relative; overflow: hidden; }
        .sidebar-item:active { background-color: #f0fdf4; }
        
        /* Chat Bubbles */
        .chat-bubble-me { background: #16a34a; color: white; border-radius: 18px 18px 0 18px; word-wrap: break-word; font-size: 15px; }
        .chat-bubble-other { background: #e4e6eb; color: black; border-radius: 18px 18px 18px 0; word-wrap: break-word; font-size: 15px; }

        .post-color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .post-color-dot:hover, .post-color-dot.selected { transform: scale(1.2); border-color: #333; }
        .colored-post-bg { display: flex; align-items: center; justify-content: center; min-height: 250px; text-align: center; font-size: 1.6rem; font-weight: bold; color: white; padding: 20px; border-radius: 8px; margin-bottom: 10px; background-size: cover; background-position: center; }

        .post-menu-dropdown { transform-origin: top right; transition: transform 0.1s ease-out, opacity 0.1s ease-out; }
        .cover-photo-gradient { background: linear-gradient(135deg, #16a34a 0%, #0d9488 100%); background-size: cover; background-position: center; }

        /* FAB Animation */
        .fab-options { transition: all 0.3s ease-in-out; opacity: 0; transform: translateY(20px); pointer-events: none; }
        .fab-options.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-btn { transition: transform 0.3s; }
        .fab-btn.rotate { transform: rotate(45deg); background-color: #ef4444; border-color: #ef4444; }
        
        /* FAB Scroll Hiding Animation */
        #fab-container { transition: transform 0.3s ease-in-out; }
        #fab-container.scroll-hidden { transform: translateY(200%); }

        /* Toast */
        #toast-container { position: fixed; bottom: calc(90px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 300; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: rgba(0, 0, 0, 0.85); color: white; padding: 12px 20px; border-radius: 50px; text-align: center; font-size: 15px; animation: fadeUp 0.3s ease-out; box-shadow: 0 4px 6px rgba(0,0,0,0.1); backdrop-filter: blur(4px); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Badge Style */
        .badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 10px; font-weight: bold; padding: 2px 5px; border-radius: 10px; border: 2px solid white; display: none; min-width: 18px; text-align: center; z-index: 10; }
        .badge.active { display: block; }
        
        .nav-badge { position: absolute; top: -2px; right: 20%; background: #ef4444; color: white; font-size: 10px; font-weight: bold; padding: 1px 5px; border-radius: 10px; border: 2px solid white; display: none; }
        
        /* Modal Transitions */
        #comment-full-modal { transition: transform 0.3s ease-in-out; transform: translateY(100%); }
        #comment-full-modal.open { transform: translateY(0); }
        #search-modal { transition: opacity 0.3s; opacity: 0; pointer-events: none; }
        #search-modal.open { opacity: 1; pointer-events: auto; }
        #tag-friends-modal, #feeling-modal { transition: transform 0.3s ease-in-out; transform: translateY(100%); }
        #tag-friends-modal.open, #feeling-modal.open { transform: translateY(0); }
        
        /* Image Viewer Modal */
        #image-viewer-modal { transition: opacity 0.3s; opacity: 0; pointer-events: none; }
        #image-viewer-modal.open { opacity: 1; pointer-events: auto; }

        .poll-option { transition: all 0.2s; }
        .poll-fill { transition: width 0.5s ease-out; }
        
        .skeleton { background: #e1e4e8; border-radius: 4px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        .verified-badge { color: #1d9bf0; margin-left: 4px; font-size: 0.95em; }
        .journalist-badge { color: #8b5cf6; margin-left: 4px; font-size: 0.95em; }
        .journalist-post { border: 2px solid #ddd6fe !important; background-color: #faf5ff; }

        body.text-large { font-size: 120%; }
        body.text-small { font-size: 90%; }
        
        @keyframes emergency-pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .btn-emergency { animation: emergency-pulse 2s infinite; }

        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.75rem; background: #000; }
        .video-container iframe, .video-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .video-container.portrait { padding-bottom: 177.77%; }

        .feed-tab { border-bottom: 3px solid transparent; transition: all 0.3s; font-size: 14px; }
        .feed-tab.active { border-bottom-color: #16a34a; color: #16a34a; font-weight: bold; }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-12px); } 100% { transform: translateY(0px); } }
        @keyframes soft-pulse { 0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(22, 163, 74, 0); } 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }
        .logo-animate { animation: float 3s ease-in-out infinite, soft-pulse 2s infinite; }
        
        /* New Post Highlight Animation */
        @keyframes highlight-fade { 0% { background-color: #dcfce7; } 100% { background-color: white; } }
        .new-post-highlight { animation: highlight-fade 3s ease-out forwards; }
        
        /* Monetization Styles */
        .monetization-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        .monetization-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: rotate 10s linear infinite;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .criteria-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .criteria-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .criteria-check { background: #16a34a; color: white; }
        .criteria-cross { background: #334155; color: #94a3b8; }
        
        /* Post Image Grid */
        .post-images-grid-1 { grid-template-columns: 1fr; }
        .post-images-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .post-images-grid-2 img { height: 250px; object-fit: cover; }

        /* Plan Card Selected Style */
        .plan-card { transition: all 0.2s; border: 2px solid transparent; }
        .plan-card.selected { border-color: #16a34a; background-color: #f0fdf4; }
        .payment-method.selected { border-color: #16a34a; background-color: #f0fdf4; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

    </style>
</head>
<body id="body-main">

<!-- ‡¶ü‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
<div id="toast-container"></div>

<!-- ‡ßß. ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
<div id="auth-screen" class="fixed inset-0 bg-white z-[200] flex flex-col items-center justify-center p-6 overflow-y-auto">
    <div class="text-center mb-8">
        <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 logo-animate border-4 border-white shadow-xl">
            <i class="fa-solid fa-map-location-dot text-green-600 text-5xl"></i>
        </div>
        <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤</h1>
        <p class="text-gray-500 mt-1 font-medium">‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶∏‡ßá‡¶¨‡¶æ</p>
    </div>
    <div id="login-form" class="w-full max-w-sm">
        <h2 class="text-xl font-bold mb-6 text-green-700 border-l-4 border-green-600 pl-3">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
        <input type="email" id="login-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full bg-gray-50 border border-gray-200 p-3.5 rounded-xl mb-3 focus:bg-white transition-all text-base">
        <div class="relative w-full mb-2">
            <input type="password" id="login-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="w-full bg-gray-50 border border-gray-200 p-3.5 rounded-xl focus:bg-white pr-10 transition-all text-base">
            <i onclick="togglePassword('login-pass', this)" class="fa-regular fa-eye absolute right-3 top-4 text-gray-500 cursor-pointer text-lg"></i>
        </div>
        <div class="text-right mb-6">
            <span onclick="toggleAuth('forgot')" class="text-sm text-gray-500 hover:text-green-600 cursor-pointer font-medium">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®?</span>
        </div>
        <button onclick="handleLogin()" id="btn-login-action" class="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl hover:bg-green-700 shadow-lg transition active:scale-95 flex justify-center items-center gap-2 text-lg">‡¶≤‡¶ó‡¶á‡¶®</button>
        <p class="mt-8 text-center text-sm text-gray-600">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? <span onclick="toggleAuth('register')" class="text-green-600 font-bold cursor-pointer hover:underline">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span></p>
    </div>
    <div id="register-form" class="w-full max-w-sm hidden-custom">
        <h2 class="text-xl font-bold mb-6 text-green-700 border-l-4 border-green-600 pl-3">‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</h2>
        <div class="space-y-4">
            <div class="flex flex-col items-center mb-2">
                <label class="relative cursor-pointer w-24 h-24 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center hover:bg-gray-50 overflow-hidden">
                    <img id="reg-img-preview" class="w-full h-full object-cover hidden">
                    <div id="reg-img-placeholder" class="text-center text-gray-400 text-xs">
                        <i class="fa-solid fa-camera text-2xl mb-1"></i><br>‡¶õ‡¶¨‡¶ø ‡¶¶‡¶ø‡¶®
                    </div>
                    <input type="file" id="reg-profile-pic" accept="image/*" class="hidden" onchange="previewRegImage(this)">
                </label>
                <p class="text-[10px] text-gray-500 mt-1">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶õ‡¶¨‡¶ø (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</p>
            </div>
            <input type="text" id="reg-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ/English)" maxlength="20" oninput="this.value = this.value.replace(/[^a-zA-Z\u0980-\u09FF\s]/g, '')" class="w-full bg-gray-50 border p-3.5 rounded-xl text-base">
            <p class="text-[10px] text-gray-500 ml-1">‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß®‡ß¶ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)</p>
            
            <input type="email" id="reg-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full bg-gray-50 border p-3.5 rounded-xl text-base">
            <input type="tel" id="reg-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ (‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü)" class="w-full bg-gray-50 border p-3.5 rounded-xl text-base">
            <div class="relative">
                <label class="text-xs text-gray-500 ml-1 block mb-1 font-bold">‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® *</label>
                <select id="reg-union" onchange="loadVillagesForUnion(this.value, 'reg-village')" class="w-full bg-gray-50 border p-3.5 rounded-xl text-base">
                    <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    <option value="Patharghata Union Sadar">‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶® (‡¶∏‡¶¶‡¶∞)</option>
                    <option value="Char Duani Union">‡¶ö‡¶∞‡¶¶‡ßÅ‡¶Ø‡¶º‡¶æ‡¶®‡ßÄ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                    <option value="Kakchira Union">‡¶ï‡¶æ‡¶ï‡¶ö‡¶ø‡¶∞‡¶æ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                    <option value="Kalmegha Union">‡¶ï‡¶æ‡¶≤‡¶Æ‡ßá‡¶ò‡¶æ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                    <option value="Kathaltoli Union">‡¶ï‡¶æ‡¶Å‡¶†‡¶æ‡¶≤‡¶§‡¶≤‡ßÄ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                    <option value="Nachnapara Union">‡¶®‡¶æ‡¶ö‡¶®‡¶æ‡¶™‡¶æ‡¶°‡¶º‡¶æ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                    <option value="Raihanpur Union">‡¶∞‡¶æ‡¶Ø‡¶º‡¶π‡¶æ‡¶®‡¶™‡ßÅ‡¶∞ ‡¶á‡¶â‡¶®‡¶ø‡¶Ø‡¶º‡¶®</option>
                </select>
            </div>
            <div>
                 <label class="text-xs text-gray-500 ml-1 block mb-1 font-bold">‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ/‡¶Æ‡¶π‡¶≤‡ßç‡¶≤‡¶æ *</label>
                 <select id="reg-village" class="w-full bg-gray-50 border p-3.5 rounded-xl text-base disabled:bg-gray-100" disabled>
                     <option value="">‡¶Ü‡¶ó‡ßá ‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                 </select>
            </div>
            <div class="flex gap-3">
                <div class="w-1/2"><label class="text-xs text-gray-500 ml-1 block mb-1 font-bold">‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label><input type="date" id="reg-dob" class="w-full bg-gray-50 border p-2.5 rounded-xl text-sm"></div>
                <div class="w-1/2"><label class="text-xs text-gray-500 ml-1 block mb-1 font-bold">‡¶≤‡¶ø‡¶ô‡ßç‡¶ó</label><select id="reg-gender" class="w-full bg-gray-50 border p-3 rounded-xl text-sm"><option value="Male">‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑</option><option value="Female">‡¶Æ‡¶π‡¶ø‡¶≤‡¶æ</option></select></div>
            </div>
            <div class="relative w-full">
                <input type="password" id="reg-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ)" class="w-full bg-gray-50 border p-3.5 rounded-xl pr-10 text-base">
                <i onclick="togglePassword('reg-pass', this)" class="fa-regular fa-eye absolute right-3 top-4 text-gray-500 cursor-pointer"></i>
            </div>
            
            <!-- Privacy Policy Checkbox -->
            <div class="flex items-start gap-2 pt-1">
                <input type="checkbox" id="reg-privacy-agree" class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500 mt-0.5">
                <label for="reg-privacy-agree" class="text-sm text-gray-600">
                    ‡¶Ü‡¶Æ‡¶ø <a href="#" id="reg-privacy-link" target="_blank" class="text-green-600 font-bold hover:underline">‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶ì ‡¶®‡ßÄ‡¶§‡¶ø‡¶Æ‡¶æ‡¶≤‡¶æ (Privacy Policy)</a> ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶è‡¶ï‡¶Æ‡¶§‡•§
                </label>
            </div>
        </div>
        <button onclick="handleRegister()" id="btn-reg-action" class="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl hover:bg-green-700 mt-6 shadow-lg transition active:scale-95 flex justify-center items-center gap-2 text-lg">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <p class="mt-8 text-center text-sm text-gray-600">‡¶Ü‡¶ó‡ßá‡¶á ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <span onclick="toggleAuth('login')" class="text-green-600 font-bold cursor-pointer hover:underline">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span></p>
    </div>
    <div id="forgot-form" class="w-full max-w-sm hidden-custom">
        <h2 class="text-xl font-bold mb-6 text-orange-600 border-l-4 border-orange-500 pl-3">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</h2>
        <p class="text-sm text-gray-500 mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡¶®, ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßã‡•§</p>
        <input type="email" id="forgot-email" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full bg-gray-50 border border-gray-200 p-3.5 rounded-xl mb-6 focus:bg-white text-base">
        <button onclick="handleForgotPass()" id="btn-forgot-action" class="w-full bg-orange-500 text-white font-bold py-3.5 rounded-xl hover:bg-orange-600 shadow-lg transition active:scale-95 flex justify-center items-center gap-2 text-lg">‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
        <p class="mt-8 text-center text-sm text-gray-600"><span onclick="toggleAuth('login')" class="text-green-600 font-bold cursor-pointer hover:underline">‡¶≤‡¶ó‡¶á‡¶®‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</span></p>
    </div>
</div>

<!-- ‡ß®. ‡¶∏‡ßç‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
<div id="splash-screen" class="fixed inset-0 bg-green-600 z-[150] flex flex-col items-center justify-center text-white transition-opacity duration-500">
    <i class="fa-solid fa-map-location-dot text-7xl mb-6 logo-animate"></i>
    <h2 class="text-3xl font-bold">‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤</h2>
    <p class="text-sm opacity-90 mt-1">‡¶π‡¶æ‡¶§‡ßá‡¶∞ ‡¶Æ‡ßÅ‡¶†‡ßã‡ßü ‡¶∏‡¶¨ ‡¶∏‡ßá‡¶¨‡¶æ</p>
    <div class="animate-spin rounded-full h-8 w-8 border-4 border-white border-t-transparent mt-8"></div>
</div>

<!-- ‡ß©. ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶®‡ßÅ (‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶°) -->
<div id="sidebar-overlay" onclick="toggleSidebar(false)" class="sidebar-overlay fixed inset-0 bg-black bg-opacity-40 z-[140] backdrop-blur-sm"></div>
<div id="sidebar" class="fixed top-0 left-0 bottom-0 w-80 bg-white z-[145] shadow-2xl flex flex-col rounded-r-2xl overflow-hidden">
    <div class="bg-gradient-to-br from-green-600 to-teal-700 text-white pt-10 pb-6 px-6 relative">
        <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fa-solid fa-tree text-8xl"></i></div>
        <div class="relative z-10 flex flex-col items-start pt-safe">
            <div id="sidebar-avatar-container" class="w-16 h-16 rounded-full border-4 border-white/30 bg-white text-green-600 flex items-center justify-center text-2xl shadow-lg mb-3 overflow-hidden"><i class="fa-solid fa-user"></i></div>
            <h3 id="sidebar-name" class="font-bold text-xl truncate tracking-wide">‡¶®‡¶æ‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</h3>
            <p id="sidebar-village" class="text-sm opacity-90 font-light tracking-wider bg-white/20 px-2 py-0.5 rounded-full inline-block mt-1">---</p>
        </div>
    </div>
    <div class="flex-1 overflow-y-auto py-4 bg-white">
        <ul class="space-y-2">
            <li onclick="switchPage('profile'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-green-700 hover:bg-green-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-green-50 flex items-center justify-center text-green-600 text-lg"><i class="fa-solid fa-user"></i></div> <span class="font-bold text-base">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</span></li>
            <li onclick="switchPage('monetization'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-yellow-600 hover:bg-yellow-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-600 text-lg"><i class="fa-solid fa-sack-dollar"></i></div> <span class="font-bold text-base">‡¶Æ‡¶®‡¶ø‡¶ü‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®</span></li>
            <li onclick="openDynamicCategory('history_tourism', '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶™‡¶∞‡ßç‡¶Ø‡¶ü‡¶®'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-purple-700 hover:bg-purple-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 text-lg"><i class="fa-solid fa-landmark"></i></div> <span class="font-bold text-base">‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶™‡¶∞‡ßç‡¶Ø‡¶ü‡¶®</span></li>
            <li onclick="switchPage('directory'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-blue-700 hover:bg-blue-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 text-lg"><i class="fa-solid fa-address-book"></i></div> <span class="font-bold text-base">‡¶™‡ßç‡¶∞‡¶∂‡¶æ‡¶∏‡¶®‡¶ø‡¶ï ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø</span></li>
            <li onclick="switchPage('market'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-orange-700 hover:bg-orange-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-orange-50 flex items-center justify-center text-orange-600 text-lg"><i class="fa-solid fa-store"></i></div> <span class="font-bold text-base">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü</span></li>
            <li onclick="switchPage('complaints'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-red-700 hover:bg-red-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-red-50 flex items-center justify-center text-red-600 text-lg"><i class="fa-solid fa-box-archive"></i></div> <span class="font-bold text-base">‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ï‡ßç‡¶∏</span></li>
            
            <!-- New Features: Verification Updated -->
            <li onclick="switchPage('verification'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-blue-500 hover:bg-blue-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 text-lg"><i class="fa-solid fa-certificate"></i></div> <span class="font-bold text-base">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</span></li>
            <li onclick="handleInvite(); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-pink-600 hover:bg-pink-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-pink-50 flex items-center justify-center text-pink-600 text-lg"><i class="fa-solid fa-share-nodes"></i></div> <span class="font-bold text-base">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶Ü‡¶Æ‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£</span></li>
            <li onclick="openRules(); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-teal-600 hover:bg-teal-50 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 text-lg"><i class="fa-solid fa-scale-balanced"></i></div> <span class="font-bold text-base">‡¶∞‡ßÅ‡¶≤‡¶∏ ‡¶ì ‡¶®‡ßÄ‡¶§‡¶ø‡¶Æ‡¶æ‡¶≤‡¶æ</span></li>

            <li onclick="switchPage('settings'); toggleSidebar(false)" class="sidebar-item px-6 py-3.5 cursor-pointer flex items-center gap-4 text-gray-700 hover:text-gray-900 hover:bg-gray-100 transition-all duration-300"><div class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 text-lg"><i class="fa-solid fa-gear"></i></div> <span class="font-bold text-base">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</span></li>
            
            <div class="border-t mx-6 my-2 border-gray-100"></div>
            <li id="sidebar-help" onclick="alert('‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó: help@patharghata.com'); toggleSidebar(false)" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-4 text-gray-500 hover:bg-gray-50 transition-all"><i class="fa-solid fa-circle-question w-6 text-center"></i> <span class="text-sm font-medium">Help & Support</span></li>
        </ul>
    </div>
    <div class="p-5 border-t bg-gray-50 pb-safe">
        <button onclick="handleLogout()" class="w-full bg-white border border-red-200 text-red-500 py-3.5 rounded-xl font-bold hover:bg-red-50 hover:border-red-300 hover:text-red-600 flex items-center justify-center gap-2 transition shadow-sm text-base"><i class="fa-solid fa-right-from-bracket"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
    </div>
</div>

<!-- ‡ß™. ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶∏‡¶Æ‡ßÇ‡¶π -->

<!-- FULL SCREEN IMAGE VIEWER MODAL -->
<div id="image-viewer-modal" class="fixed inset-0 bg-black bg-opacity-95 z-[300] hidden-custom flex items-center justify-center" onclick="closeImageViewer()">
    <button class="absolute top-5 right-5 text-white w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center hover:bg-gray-700 z-10">
        <i class="fa-solid fa-xmark text-xl"></i>
    </button>
    <img id="full-image-view" class="max-w-full max-h-screen object-contain p-2 transition-transform duration-300">
</div>

<!-- Tag Friends Modal -->
<div id="tag-friends-modal" class="fixed inset-0 bg-white z-[210] flex flex-col hidden-custom">
    <div class="flex items-center gap-3 p-4 border-b bg-white shadow-sm z-10 pt-safe sticky top-0">
        <button onclick="closeTagModal()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600"><i class="fa-solid fa-arrow-left text-xl"></i></button>
        <h3 class="font-bold text-gray-800 text-lg">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <button onclick="saveTags()" class="ml-auto bg-green-600 text-white px-4 py-1.5 rounded-full text-sm font-bold">‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</button>
    </div>
    <div id="tag-friends-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50 pb-20">
        <p class="text-center text-gray-400 mt-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>
</div>

<!-- Feeling Modal -->
<div id="feeling-modal" class="fixed inset-0 bg-white z-[210] flex flex-col hidden-custom">
    <div class="flex items-center gap-3 p-4 border-b bg-white shadow-sm z-10 pt-safe sticky top-0">
        <button onclick="closeFeelingModal()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600"><i class="fa-solid fa-arrow-left text-xl"></i></button>
        <h3 class="font-bold text-gray-800 text-lg">‡¶Ö‡¶®‡ßÅ‡¶≠‡ßÇ‡¶§‡¶ø / ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠‡¶ø‡¶ü‡¶ø</h3>
    </div>
    <div class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-3 bg-gray-50 pb-20">
        <div onclick="selectFeeling('Happy', 'üòÑ')" class="bg-white p-3 rounded-xl border flex items-center gap-3 cursor-pointer hover:bg-green-50"><span class="text-2xl">üòÑ</span> <span class="font-bold text-gray-700">Happy</span></div>
        <div onclick="selectFeeling('Sad', 'üòî')" class="bg-white p-3 rounded-xl border flex items-center gap-3 cursor-pointer hover:bg-red-50"><span class="text-2xl">üòî</span> <span class="font-bold text-gray-700">Sad</span></div>
        <div onclick="selectFeeling('Loved', 'ü•∞')" class="bg-white p-3 rounded-xl border flex items-center gap-3 cursor-pointer hover:bg-pink-50"><span class="text-2xl">ü•∞</span> <span class="font-bold text-gray-700">Loved</span></div>
        <div onclick="selectFeeling('Excited', 'ü§©')" class="bg-white p-3 rounded-xl border flex items-center gap-3 cursor-pointer hover:bg-yellow-50"><span class="text-2xl">ü§©</span> <span class="font-bold text-gray-700">Excited</span></div>
        <div onclick="selectFeeling('Angry', 'üò°')" class="bg-white p-3 rounded-xl border flex items-center gap-3 cursor-pointer hover:bg-red-50"><span class="text-2xl">üò°</span> <span class="font-bold text-gray-700">Angry</span></div>
        <div onclick="selectFeeling('Celebrating', 'üéâ')" class="bg-white p-3 rounded-xl border flex items-center gap-3 cursor-pointer hover:bg-blue-50"><span class="text-2xl">üéâ</span> <span class="font-bold text-gray-700">Celebrating</span></div>
    </div>
</div>

<div id="search-modal" class="fixed inset-0 bg-white z-[190] flex flex-col">
    <div class="flex items-center gap-3 p-4 border-b bg-white shadow-sm z-10 pt-safe sticky top-0">
        <button onclick="toggleGlobalSearch(false)" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600"><i class="fa-solid fa-arrow-left text-xl"></i></button>
        <div class="flex-1 relative">
            <input type="text" id="global-search-input" onkeyup="debouncedGlobalSearch(this.value)" placeholder="‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑, ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶¨‡¶æ ‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶ú‡ßÅ‡¶®..." class="w-full bg-gray-100 py-3 pl-4 pr-10 rounded-full text-base focus:bg-white focus:ring-1 focus:ring-green-500 border-0">
            <i class="fa-solid fa-search absolute right-4 top-3.5 text-gray-400 text-lg"></i>
        </div>
    </div>
    <div id="global-search-results" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 pb-20">
        <div class="text-center mt-20 text-gray-400"><i class="fa-solid fa-magnifying-glass text-4xl mb-3 opacity-30"></i><p>‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</p></div>
    </div>
</div>

<div id="comment-full-modal" class="fixed inset-0 bg-white z-[180] flex flex-col hidden-custom">
    <div class="flex items-center justify-between p-4 border-b bg-white shadow-sm z-10 sticky top-0 pt-safe">
        <div class="flex items-center gap-2"><button onclick="closeFullCommentModal()" class="w-9 h-9 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button><h3 class="font-bold text-gray-800 text-lg">‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h3></div>
        <span id="full-comment-count" class="text-sm bg-gray-100 px-3 py-1 rounded-full font-bold text-gray-600">0</span>
    </div>
    <div id="full-comments-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 pb-20"></div>
    <div class="p-3 border-t bg-white flex gap-2 items-center sticky bottom-0 w-full pb-safe">
        <div id="my-comment-avatar-full" class="w-9 h-9 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center border border-gray-100 shrink-0"><i class="fa-solid fa-user text-gray-400"></i></div>
        <input type="text" id="full-comment-input" onkeydown="handleEnter(event, 'full-comment')" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶§‡¶æ‡¶Æ‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="flex-1 bg-gray-100 rounded-full px-5 py-3 text-sm border-0 focus:ring-1 focus:ring-green-500">
        <button onclick="submitFullComment()" class="text-green-600 text-xl p-2 hover:bg-gray-100 rounded-full w-10 h-10 flex items-center justify-center shadow-sm border border-gray-100"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<!-- SINGLE POST MODAL -->
<div id="single-post-modal" class="fixed inset-0 bg-white z-[180] flex flex-col hidden-custom">
    <div class="flex items-center gap-2 p-4 border-b bg-white shadow-sm z-10 sticky top-0 pt-safe">
        <button onclick="document.getElementById('single-post-modal').classList.add('hidden-custom')" class="w-9 h-9 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
        <h3 class="font-bold text-gray-800 text-lg">‡¶™‡ßã‡¶∏‡ßç‡¶ü</h3>
    </div>
    <div id="single-post-content" class="flex-1 overflow-y-auto p-4 bg-gray-100 pb-20">
        <!-- Post content injected here -->
    </div>
</div>

<!-- UPDATED PROFESSIONAL POST MODAL -->
<div id="post-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center hidden-custom p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-[500px] rounded-2xl shadow-2xl transform transition-all scale-100 overflow-hidden relative">
        <!-- Header -->
        <div class="flex justify-between items-center px-4 py-3 border-b bg-white relative z-10">
            <h3 class="font-bold text-lg text-gray-800 text-center flex-1">‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <button onclick="togglePostModal(false)" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition absolute right-3">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
        </div>
        
        <div class="max-h-[80vh] overflow-y-auto">
            <!-- User Info & Privacy -->
            <div class="px-4 py-3 flex items-center gap-3">
                <div id="post-modal-user-img" class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center border border-gray-100">
                    <i class="fa-solid fa-user text-gray-400 text-xl"></i>
                </div>
                <div>
                    <h4 id="post-modal-user-name" class="font-bold text-gray-800 text-base leading-tight">User Name</h4>
                    <select id="post-privacy" class="mt-1 bg-gray-100 text-xs font-semibold text-gray-600 px-2 py-1 rounded-md border-0 focus:ring-0 cursor-pointer">
                        <option value="public">üåç Public</option>
                        <option value="friends">üë• Friends</option>
                        <option value="only_me">üîí Only Me</option>
                    </select>
                </div>
            </div>

            <!-- Text Area -->
            <div class="px-4">
                <textarea id="post-text" class="w-full min-h-[150px] text-lg lg:text-xl placeholder-gray-500 border-none focus:ring-0 resize-none p-0" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶®‡ßá ‡¶ï‡ßÄ ‡¶Ü‡¶õ‡ßá? (‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡¶ø‡¶®)"></textarea>
            </div>

            <!-- Background Color Options -->
            <div class="px-4 py-2" id="color-picker-wrapper">
                 <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide" id="color-picker-container">
                    <div onclick="selectPostColor('')" class="post-color-dot bg-white border-gray-300 shadow-sm shrink-0" title="Default"></div>
                    <div onclick="selectPostColor('linear-gradient(to right, #ff5f6d, #ffc371)')" class="post-color-dot shrink-0" style="background: linear-gradient(to right, #ff5f6d, #ffc371);"></div>
                    <div onclick="selectPostColor('linear-gradient(to right, #2193b0, #6dd5ed)')" class="post-color-dot shrink-0" style="background: linear-gradient(to right, #2193b0, #6dd5ed);"></div>
                    <div onclick="selectPostColor('linear-gradient(to right, #cc2b5e, #753a88)')" class="post-color-dot shrink-0" style="background: linear-gradient(to right, #cc2b5e, #753a88);"></div>
                    <div onclick="selectPostColor('linear-gradient(to right, #000000, #434343)')" class="post-color-dot shrink-0" style="background: linear-gradient(to right, #000000, #434343);"></div>
                    <div onclick="selectPostColor('linear-gradient(to right, #11998e, #38ef7d)')" class="post-color-dot shrink-0" style="background: linear-gradient(to right, #11998e, #38ef7d);"></div>
                </div>
                <input type="hidden" id="selected-post-color" value="">
            </div>

            <!-- Image/Video Preview Area -->
            <div id="image-preview-area" class="px-4 mb-2 hidden">
                <div class="relative rounded-xl overflow-hidden border border-gray-200" id="preview-container-inner">
                    <!-- Image or Video will be injected here -->
                    <div id="preview-grid" class="w-full"></div>
                    <button onclick="removePostImage()" class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-md text-gray-700 hover:text-red-500 z-10">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>

            <!-- Add to Post Options -->
            <div class="px-4 pb-2">
                <div class="border border-gray-300 rounded-lg p-3 flex justify-between items-center shadow-sm">
                    <span class="text-sm font-semibold text-gray-700">Add to your post</span>
                    <div class="flex gap-4">
                        <div onclick="document.getElementById('post-image-file').click()" class="cursor-pointer text-green-500 hover:bg-green-50 p-1.5 rounded-full transition" title="Photo">
                            <i class="fa-solid fa-images text-2xl"></i>
                        </div>
                        <div onclick="openTagModal()" class="cursor-pointer text-blue-500 hover:bg-blue-50 p-1.5 rounded-full transition" title="Tag People">
                            <i class="fa-solid fa-user-tag text-xl"></i>
                        </div>
                        <div onclick="openFeelingModal()" class="cursor-pointer text-yellow-500 hover:bg-yellow-50 p-1.5 rounded-full transition" title="Feeling/Activity">
                            <i class="fa-regular fa-face-smile text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Extra Fields (Collapsible or just small) -->
            <div class="px-4 py-2 flex gap-2">
                <input type="tel" id="post-mobile" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ (‡¶ï‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶®)" class="w-1/2 bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm focus:bg-white">
                <input type="url" id="post-social-link" placeholder="‡¶∏‡ßã‡¶∂‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï (WhatsApp)" class="w-1/2 bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm focus:bg-white">
            </div>

            <!-- Hidden File Input (Updated for Multiple Images) -->
            <input type="file" id="post-image-file" accept="image/*" class="hidden" multiple onchange="previewPostImage(this)">

            <!-- Submit Button -->
            <div class="p-4">
                <button onclick="submitPost()" id="btn-post-submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-green-700 transition active:scale-[0.98] disabled:opacity-70 disabled:cursor-not-allowed text-lg">
                    ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>
</div>

<div id="edit-post-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[110] flex items-center justify-center hidden-custom p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl">
        <h3 class="font-bold text-lg text-gray-700 mb-4">‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <input type="hidden" id="edit-post-id">
        <textarea id="edit-post-text" class="w-full h-32 p-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white resize-none text-base"></textarea>
        <div class="flex gap-2 mt-4"><button onclick="document.getElementById('edit-post-modal').classList.add('hidden-custom')" class="flex-1 bg-gray-200 text-gray-700 font-bold py-2.5 rounded-lg">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button><button onclick="submitEditPost()" class="flex-1 bg-green-600 text-white font-bold py-2.5 rounded-lg">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
    </div>
</div>

<div id="poll-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center hidden-custom p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl transform transition-all scale-100">
        <div class="flex justify-between items-center mb-4 border-b pb-3"><h3 class="font-bold text-lg text-gray-700">‡¶™‡ßã‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3><button onclick="togglePollModal(false)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-red-100 hover:text-red-500 transition"><i class="fa-solid fa-xmark"></i></button></div>
        <div class="space-y-3">
            <input type="text" id="poll-question" placeholder="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∏‡ßá‡¶∞‡¶æ ‡¶ñ‡ßá‡¶≤‡¶æ ‡¶ï‡ßã‡¶®‡¶ü‡¶ø?)" class="w-full bg-gray-50 border p-3 rounded-lg text-sm font-bold">
            <input type="text" id="poll-opt-1" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ßß" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
            <input type="text" id="poll-opt-2" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ß®" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
            <input type="text" id="poll-opt-3" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ß© (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
            <input type="text" id="poll-opt-4" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡ß™ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
        </div>
        <button onclick="submitPoll()" class="w-full bg-blue-600 text-white font-bold py-3 mt-4 rounded-lg shadow hover:bg-blue-700 transition flex justify-center items-center gap-2"><i class="fa-solid fa-square-poll-vertical"></i> ‡¶™‡ßã‡¶≤ ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<div id="sell-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center hidden-custom p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl relative">
        <button onclick="toggleSellModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">‡¶™‡¶£‡ßç‡¶Ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <div class="space-y-3">
            <input type="text" id="sell-title" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
            <input type="number" id="sell-price" placeholder="‡¶¶‡¶æ‡¶Æ (‡¶ü‡¶æ‡¶ï‡¶æ)" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm">
            <textarea id="sell-desc" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞..." rows="3" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></textarea>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø</label><input type="file" id="sell-image-file" accept="image/*" class="w-full bg-gray-50 border border-gray-200 p-2 rounded-lg text-sm file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:bg-orange-50 file:text-orange-700"></div>
        </div>
        <button onclick="submitProduct()" id="btn-sell-submit" class="w-full bg-orange-500 text-white font-bold py-3 mt-4 rounded-lg shadow hover:bg-orange-600 transition flex justify-center items-center gap-2">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡¶ø‡¶®</button>
    </div>
</div>

<div id="donor-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[100] flex items-center justify-center hidden-custom p-4">
    <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl relative">
        <button onclick="toggleDonorModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        <h3 class="text-xl font-bold text-red-600 mb-1 text-center">‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶§‡¶æ ‡¶π‡ßã‡¶®</h3>
        <p class="text-xs text-gray-500 text-center mb-6">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶ï‡ßç‡¶§‡ßá ‡¶¨‡¶æ‡¶Å‡¶ö‡¶¨‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶æ‡¶£ ‚ù§Ô∏è</p>
        <div class="space-y-4">
            <div><label class="block text-xs font-bold text-gray-600 mb-1">‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™</label><select id="donor-blood-group" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm"><option value="">‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="O+">O+</option><option value="O-">O-</option><option value="AB+">AB+</option><option value="AB-">AB-</option></select></div>
            <div><label class="block text-xs font-bold text-gray-600 mb-1">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label><input type="tel" id="donor-phone" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm" placeholder="017XXXXXXXX"></div>
            <div><label class="block text-xs font-bold text-gray-600 mb-1">‡¶∂‡ßá‡¶∑ ‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label><input type="date" id="donor-last-date" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm"></div>
        </div>
        <button onclick="submitDonor()" class="w-full bg-red-600 text-white font-bold py-3 mt-6 rounded-lg shadow-lg hover:bg-red-700 transition">‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶®</button>
    </div>
</div>

<div id="modal-blood-request" class="fixed inset-0 bg-black bg-opacity-80 z-[105] flex items-center justify-center hidden-custom p-4">
    <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl relative">
        <button onclick="toggleBloodRequestModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        <div class="text-center mb-5"><div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-2 animate-pulse"><i class="fa-solid fa-bell text-red-600 text-3xl"></i></div><h3 class="text-xl font-bold text-red-600">‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</h3><p class="text-xs text-red-500">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶°‡ßã‡¶®‡¶æ‡¶∞‡¶ï‡ßá ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá</p></div>
        <div class="space-y-3">
             <select id="req-blood-group" class="w-full border-2 border-red-200 p-2.5 rounded-lg bg-red-50 text-sm font-bold text-red-800"><option value="">‡¶ï‡ßã‡¶® ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™‡ßá‡¶∞ ‡¶∞‡¶ï‡ßç‡¶§ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®?</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="O+">O+</option><option value="O-">O-</option><option value="AB+">AB+</option><option value="AB-">AB-</option></select>
            <input type="text" id="req-location" placeholder="‡¶π‡¶æ‡¶∏‡¶™‡¶æ‡¶§‡¶æ‡¶≤ ‡¶¨‡¶æ ‡¶∏‡ßç‡¶•‡¶æ‡¶®" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm">
            <input type="tel" id="req-contact" placeholder="‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm">
        </div>
        <button onclick="sendEmergencyBloodRequest()" id="btn-blood-req" class="w-full bg-red-600 text-white font-bold py-3 mt-6 rounded-lg shadow-lg hover:bg-red-700 transition btn-emergency">‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
    </div>
</div>

<!-- EMERGENCY ALERT MODAL -->
<div id="emergency-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[106] flex items-center justify-center hidden-custom p-4">
    <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl relative border-2 border-red-500">
        <button onclick="document.getElementById('emergency-modal').classList.add('hidden-custom')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        <div class="text-center mb-5">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-2 animate-pulse">
                <i class="fa-solid fa-triangle-exclamation text-red-600 text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-red-600">‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü</h3>
            <p class="text-xs text-red-500">‡¶¨‡¶ø‡¶™‡¶¶ ‡¶∏‡¶Ç‡¶ï‡ßá‡¶§ ‡¶¨‡¶æ ‡¶π‡¶æ‡¶∞‡¶æ‡¶®‡ßã ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶™‡ßç‡¶§‡¶ø</p>
        </div>
        <div class="space-y-3">
            <select id="emergency-type" class="w-full border-2 border-red-200 p-2.5 rounded-lg bg-red-50 text-sm font-bold text-gray-800">
                <option value="Danger">‡¶¨‡¶ø‡¶™‡¶¶ ‡¶∏‡¶Ç‡¶ï‡ßá‡¶§</option>
                <option value="Lost">‡¶π‡¶æ‡¶∞‡¶æ‡¶®‡ßã ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶™‡ßç‡¶§‡¶ø</option>
                <option value="Found">‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡¶ø‡ßü‡ßá‡¶õ‡ßá</option>
                <option value="Help">‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</option>
            </select>
            <input type="text" id="emergency-title" placeholder="‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ (‡¶ï‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá?)" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm">
            <textarea id="emergency-desc" rows="3" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶ì ‡¶∏‡ßç‡¶•‡¶æ‡¶®..." class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm"></textarea>
            <input type="tel" id="emergency-contact" placeholder="‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" class="w-full border p-2.5 rounded-lg bg-gray-50 text-sm">
        </div>
        <button onclick="submitEmergencyAlert()" class="w-full bg-red-600 text-white font-bold py-3 mt-6 rounded-lg shadow-lg hover:bg-red-700 transition btn-emergency">‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[160] flex items-center justify-center hidden-custom p-4">
    <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl relative max-h-[85vh] overflow-y-auto">
        <button onclick="toggleEditProfile(false)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        <h3 class="text-lg font-bold text-gray-800 mb-5 border-b pb-2">‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <div class="space-y-4">
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶õ‡¶¨‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label><input type="file" id="edit-profile-img" accept="image/*" class="w-full bg-gray-50 border p-2 rounded-lg text-sm file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶®‡¶æ‡¶Æ</label><input type="text" id="edit-name" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶°‡¶æ‡¶ï ‡¶®‡¶æ‡¶Æ (Nickname)</label><input type="text" id="edit-nickname" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∞‡¶æ‡¶®‡¶æ" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® (‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶®‡ßü)</label><input type="text" id="edit-union" disabled class="w-full bg-gray-100 border p-2.5 rounded-lg text-sm text-gray-500 cursor-not-allowed"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ/‡¶Æ‡¶π‡¶≤‡ßç‡¶≤‡¶æ (‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶®‡ßü)</label><input type="text" id="edit-village" disabled class="w-full bg-gray-100 border p-2.5 rounded-lg text-sm text-gray-500 cursor-not-allowed"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶™‡ßá‡¶∂‡¶æ</label><input type="text" id="edit-profession" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï, ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡ßü‡ßÄ" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label><input type="text" id="edit-location" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></div>
            <div><label class="text-xs font-bold text-gray-500 block mb-1">‡¶¨‡¶æ‡ßü‡ßã (‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß´‡ß¶ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)</label><textarea id="edit-bio" maxlength="50" rows="2" placeholder="‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="w-full bg-gray-50 border p-2.5 rounded-lg text-sm"></textarea></div>
        </div>
        <button onclick="saveProfileChanges()" id="btn-save-profile" class="w-full bg-green-600 text-white font-bold py-3 mt-6 rounded-lg shadow hover:bg-green-700 transition flex justify-center items-center gap-2">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<!-- ‡ß´. ‡¶Æ‡ßá‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
<div class="app-container hidden-custom" id="main-app">
    <header class="bg-white text-gray-800 p-4 sticky top-0 z-40 flex justify-between items-center shadow-sm border-b pt-safe">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar(true)" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center hover:bg-gray-200 transition"><i class="fa-solid fa-bars text-xl"></i></button>
            <h1 id="app-header-title" class="text-xl font-bold text-green-600">‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤</h1>
        </div>
        <div class="flex items-center gap-3">
             <button onclick="toggleGlobalSearch(true)" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-600 hover:bg-gray-200"><i class="fa-solid fa-magnifying-glass text-xl"></i></button>
             <div onclick="switchPage('notifications')" class="cursor-pointer relative">
                <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 border border-gray-200 hover:bg-gray-200"><i class="fa-regular fa-bell text-xl"></i></div>
                <span id="header-badge-notice" class="badge">0</span>
            </div>
        </div>
    </header>

    <main id="content-pages">
        
        <div id="page-home" class="p-0 animate-fade">
            <div id="live-notices"></div> 
            <div class="bg-white border-b sticky top-[68px] z-30">
                <div class="flex">
                    <div onclick="filterFeed('all')" id="tab-feed-all" class="flex-1 text-center py-3.5 text-xs font-bold text-gray-500 cursor-pointer feed-tab active uppercase">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ</div>
                    <div onclick="filterFeed('union')" id="tab-feed-union" class="flex-1 text-center py-3.5 text-xs font-bold text-gray-500 cursor-pointer feed-tab uppercase">‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶®</div>
                    <div onclick="filterFeed('village')" id="tab-feed-village" class="flex-1 text-center py-3.5 text-xs font-bold text-gray-500 cursor-pointer feed-tab uppercase" style="display: none;">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</div>
                </div>
            </div>
            <div class="bg-gray-100 pb-20">
                <div id="news-feed" class="px-0 space-y-3 min-h-[300px] mt-2">
                    <!-- Initial Loader Skeleton -->
                    <div class="flex flex-col gap-3 p-4" id="initial-feed-skeleton">
                        <div class="h-40 w-full skeleton"></div>
                        <div class="h-40 w-full skeleton"></div>
                    </div>
                </div>
                <!-- Pagination / Load More Controls -->
                <div id="feed-loader-area" class="pb-10 pt-2 text-center hidden">
                     <button id="btn-load-more" onclick="loadMorePosts()" class="btn-load-more hidden"><i class="fa-solid fa-arrow-down"></i> ‡¶Ü‡¶∞‡ßã ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                     <div id="loader-spinner" class="py-4"><i class="fa-solid fa-circle-notch fa-spin text-green-600 text-2xl"></i></div>
                     <!-- Invisible element for Intersection Observer -->
                     <div id="scroll-sentinel" style="height: 10px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <div id="page-services" class="hidden p-4 min-h-screen bg-gray-50 pb-20">
             <div class="bg-white p-3 sticky top-20 z-30 shadow-sm flex items-center gap-2 mb-4 rounded-xl">
                <button onclick="switchPage('home')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                <h2 class="font-bold text-lg text-gray-800">‡¶∏‡¶ï‡¶≤ ‡¶∏‡ßá‡¶¨‡¶æ</h2>
            </div>
            <div id="services-grid" class="grid grid-cols-2 gap-4 p-4 bg-white mb-2 shadow-sm rounded-xl"><p class="col-span-2 text-center text-gray-400 py-4">‡¶∏‡ßá‡¶¨‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>
        
        <!-- MONETIZATION PAGE -->
        <div id="page-monetization" class="hidden p-4 min-h-screen bg-gray-50 pb-20">
             <div class="bg-white p-3 sticky top-0 z-30 shadow-sm flex items-center gap-2 mb-4 rounded-xl pt-safe">
                <button onclick="switchPage('home')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                <h2 class="font-bold text-lg text-gray-800">‡¶Æ‡¶®‡¶ø‡¶ü‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®</h2>
            </div>
            
            <div class="monetization-card relative z-10">
                <div class="relative z-10">
                    <h1 class="text-2xl font-extrabold mb-1">‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡ßá‡¶ü‡¶∞</h1>
                    <p class="text-gray-300 text-sm mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                    <div class="flex gap-4 mb-4">
                        <div class="text-center">
                            <h3 class="text-xl font-bold">0</h3>
                            <p class="text-xs text-gray-400">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡ßü</p>
                        </div>
                        <div class="w-[1px] bg-gray-600"></div>
                        <div class="text-center">
                            <h3 class="text-xl font-bold">Pending</h3>
                            <p class="text-xs text-gray-400">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</p>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="font-bold text-gray-700 mb-4 border-l-4 border-yellow-500 pl-3">‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡¶§‡¶æ ‡¶∏‡¶Æ‡ßÇ‡¶π (Criteria)</h3>
            
            <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                <!-- Updated Criteria: 2000 Friends -->
                <div class="criteria-item">
                    <div>
                        <h4 class="font-bold text-sm text-gray-800">‡ß®‡ß¶‡ß¶‡ß¶ ‡¶´‡¶≤‡ßã‡ßü‡¶æ‡¶∞/‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</h4>
                        <p class="text-xs text-gray-500 mt-1">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ß®‡ß¶‡ß¶‡ß¶ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá</p>
                    </div>
                    <div id="crit-follower-icon" class="criteria-icon criteria-cross"><i class="fa-solid fa-xmark"></i></div>
                </div>
                
                <div class="criteria-item">
                    <div>
                        <h4 class="font-bold text-sm text-gray-800">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</h4>
                        <p class="text-xs text-gray-500 mt-1">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶° ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá</p>
                    </div>
                    <div id="crit-verified-icon" class="criteria-icon criteria-cross"><i class="fa-solid fa-xmark"></i></div>
                </div>

                <div class="criteria-item">
                    <div>
                        <h4 class="font-bold text-sm text-gray-800">‡ßß‡ß¶‡¶ü‡¶ø ‡¶™‡ßã‡¶∏‡ßç‡¶ü</h4>
                        <p class="text-xs text-gray-500 mt-1">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ßß‡ß¶‡¶ü‡¶ø ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá</p>
                    </div>
                    <div id="crit-post-icon" class="criteria-icon criteria-cross"><i class="fa-solid fa-xmark"></i></div>
                </div>
            </div>

            <button onclick="applyForMonetization()" id="btn-monetization-apply" class="w-full bg-gradient-to-r from-yellow-500 to-orange-600 text-white font-bold py-4 rounded-xl shadow-lg hover:from-yellow-600 hover:to-orange-700 transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <p class="text-center text-xs text-gray-400 mt-4">‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø</p>
        </div>

        <div id="page-dynamic-content" class="hidden p-4 bg-gray-50 min-h-screen pb-20">
            <button onclick="switchPage('services')" class="mb-4 text-gray-500 text-sm font-bold"><i class="fa-solid fa-arrow-left"></i> ‡¶∏‡¶ï‡¶≤ ‡¶∏‡ßá‡¶¨‡¶æ</button>
            <h2 id="dynamic-content-title" class="text-xl font-bold mb-5 border-l-4 border-blue-500 pl-3 text-gray-700">...</h2>
            <div id="dynamic-items-container" class="space-y-3"><p class="text-center text-gray-400 mt-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>

        <div id="page-notifications" class="hidden p-4 min-h-screen bg-gray-50 pb-20">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-yellow-500 pl-3">‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</h2>
            <div id="notifications-list" class="space-y-3"><p class="text-center text-gray-400 mt-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            <div class="text-center mt-6">
                <button id="btn-load-more-notif" onclick="loadNotifications(false)" class="hidden bg-white border px-4 py-2 rounded-full text-sm font-bold text-gray-600 shadow-sm">‡¶Ü‡¶∞‡ßã ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
            </div>
        </div>
        
        <div id="page-people" class="hidden p-0 min-h-screen bg-gray-50 pb-20">
            <div class="bg-white p-4 sticky top-16 z-30 shadow-sm border-b">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-bold text-gray-800">‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑ ‡¶ñ‡ßÅ‡¶ú‡ßÅ‡¶®</h2>
                </div>
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400 text-lg"></i>
                    <div class="flex gap-2">
                         <input type="text" id="search-people" onkeyup="debouncedPeopleSearch(this.value)" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶ú‡ßÅ‡¶®..." class="w-full bg-gray-100 p-3 pl-12 rounded-full text-base focus:bg-white border border-transparent focus:border-green-200">
                    </div>
                </div>
            </div>
            
            <div class="p-4 space-y-6">
                <div id="friend-requests-section" class="hidden">
                     <h3 class="font-bold text-gray-700 mb-2 border-l-4 border-yellow-500 pl-2 text-sm">‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü</h3>
                     <div id="friend-requests-list" class="space-y-2"></div>
                </div>
                <div>
                     <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-gray-700 border-l-4 border-green-500 pl-2 text-sm">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</h3><button onclick="switchPage('friends-list')" class="text-xs text-green-600 font-bold hover:underline">‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button></div>
                     <div id="my-friends-preview-list" class="grid grid-cols-2 gap-2"><p class="col-span-2 text-center text-gray-400 text-xs py-2">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
                </div>
                <div>
                     <h3 class="font-bold text-gray-700 mb-2 border-l-4 border-blue-500 pl-2 text-sm">‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶® / ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü</h3>
                     <div id="users-list" class="space-y-4"><p class="text-center text-gray-400 text-sm">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...</p></div>
                </div>
            </div>
        </div>

        <div id="page-messages" class="hidden p-0 min-h-screen bg-white pb-20">
            <div id="chat-list-view" class="h-full">
                <div class="p-4 border-b"><h2 class="text-xl font-bold text-gray-800">‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</h2></div>
                <div class="px-4 py-3 border-b bg-gray-50 overflow-x-auto whitespace-nowrap"><h4 class="text-xs font-bold text-gray-500 mb-2">Active Friends</h4><div id="quick-chat-friends" class="flex gap-4"><p class="text-xs text-gray-400">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div></div>
                <div id="chat-list-container" class="space-y-0"><p class="text-center text-gray-400 mt-10 text-sm">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            </div>
            <div id="chat-conversation-view" class="hidden hidden-custom fixed inset-0 z-[200] bg-white flex flex-col">
                <div class="bg-white p-3 border-b flex items-center gap-3 sticky top-0 z-20 shadow-sm pt-safe">
                    <button onclick="closeChat()" class="text-gray-500 w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-700 font-bold border border-green-200 overflow-hidden" id="chat-header-img">U</div>
                    <h3 onclick="openUserProfile(currentChatUser.uid)" class="font-bold text-gray-800 cursor-pointer text-lg" id="chat-header-name">User</h3>
                </div>
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#f0f2f5] pb-24"></div>
                <div class="bg-white p-3 border-t flex gap-2 items-center fixed bottom-0 w-full pb-safe z-50">
                    <input type="file" id="chat-img-input" accept="image/*" class="hidden" onchange="handleChatImageSelect()">
                    <i class="fa-solid fa-image text-xl text-gray-500 p-2 cursor-pointer hover:bg-gray-100 rounded-full" onclick="document.getElementById('chat-img-input').click()"></i>
                    <input type="text" id="msg-input" onkeydown="handleEnter(event, 'chat')" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="flex-1 bg-gray-100 rounded-full px-5 py-3 text-sm border-0 focus:ring-1 focus:ring-green-500">
                    <button onclick="sendMsg()" id="btn-chat-send" class="text-green-600 text-xl p-2 hover:bg-gray-100 rounded-full w-12 h-12 flex items-center justify-center"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="page-market" class="hidden p-4 bg-gray-100 min-h-screen pb-20">
             <div class="flex items-center mb-5 sticky top-20 z-30 bg-gray-100 py-2 gap-3">
                 <button onclick="switchPage('services')" class="text-gray-500 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                 <h2 class="text-xl font-bold text-gray-800 border-l-4 border-orange-500 pl-3 flex-1">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü</h2>
                 <button onclick="toggleSellModal(true)" class="bg-orange-500 text-white px-5 py-2.5 rounded-full text-sm font-bold shadow hover:bg-orange-600 flex items-center gap-2 transform active:scale-95 transition"><i class="fa-solid fa-plus"></i> ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
             </div>
             <div id="market-list" class="grid grid-cols-2 gap-3"><p class="col-span-2 text-center text-gray-400 py-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>

        <div id="page-profile" class="hidden bg-[#f0f2f5] min-h-screen pb-20 z-0">
            <div class="relative bg-white shadow-sm pb-4 mb-3">
                <div id="profile-cover" class="h-48 w-full cover-photo-gradient relative overflow-hidden">
                    <img id="profile-cover-img" class="w-full h-full object-cover hidden">
                    <button onclick="document.getElementById('cover-upload').click()" class="absolute bottom-3 right-3 bg-white p-2 rounded-full shadow-md text-gray-700 hover:text-green-600 active:scale-95 transition z-10">
                        <i class="fa-solid fa-camera"></i>
                    </button>
                    <input type="file" id="cover-upload" class="hidden" accept="image/*" onchange="handleCoverPhotoUpload(this)">
                </div>
                <div class="px-4">
                    <div class="relative -mt-24 mb-3 flex flex-col items-center">
                         <div class="w-40 h-40 rounded-full p-1.5 bg-white shadow-md z-10">
                            <div id="profile-avatar-container" class="w-full h-full bg-gray-200 rounded-full flex items-center justify-center text-gray-400 text-5xl overflow-hidden border-4 border-white"><i class="fa-solid fa-user"></i></div>
                         </div>
                    </div>
                    <div class="text-center">
                        <h2 id="profile-name" class="text-2xl font-bold text-gray-900 flex items-center justify-center gap-1">...</h2>
                        <span id="profile-union-badge" class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mt-1 mb-1 font-bold">---</span>
                        <p id="profile-village-badge" class="text-sm text-gray-500"><i class="fa-solid fa-location-dot"></i> <span id="profile-village-text">...</span></p>
                        <p id="profile-bio" class="text-sm text-gray-600 mt-2 max-w-xs mx-auto italic">...</p>
                    </div>
                    <div class="flex gap-3 mt-6 border-b pb-4">
                        <button onclick="toggleEditProfile(true)" class="flex-1 bg-gray-100 text-gray-800 py-2.5 rounded-lg font-bold text-sm hover:bg-gray-200 flex items-center justify-center gap-2 transition"><i class="fa-solid fa-pen"></i> ‡¶è‡¶°‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</button>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 shadow-sm mb-3">
                <h3 class="font-bold text-lg text-gray-800 mb-3">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-briefcase w-6 text-center text-gray-400 text-lg"></i><span class="text-base">‡¶™‡ßá‡¶∂‡¶æ: <strong id="profile-profession" class="text-gray-800 ml-1">---</strong></span></div>
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-location-dot w-6 text-center text-gray-400 text-lg"></i><span class="text-base">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: <strong id="profile-location" class="text-gray-800 ml-1">---</strong></span></div>
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-phone w-6 text-center text-gray-400 text-lg"></i><span class="text-base" id="profile-phone">---</span></div>
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-envelope w-6 text-center text-gray-400 text-lg"></i><span class="text-base" id="profile-email">---</span></div>
                </div>
            </div>
            <div class="bg-white p-4 shadow-sm mb-3">
                <div class="flex justify-between items-center mb-3">
                    <div><h3 class="font-bold text-lg text-gray-800">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¨‡¶æ‡¶®‡ßç‡¶ß‡¶¨</h3><p class="text-sm text-gray-500" id="friends-count-me">0 ‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</p></div>
                    <button onclick="showAllFriends('me')" class="text-green-600 text-sm font-bold hover:bg-gray-100 px-3 py-1.5 rounded transition">‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                </div>
                <div id="profile-friends-preview-me" class="grid grid-cols-3 gap-2"><p class="col-span-3 text-center text-sm text-gray-400 py-4">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            </div>
            <div class="px-0">
                <div class="bg-white p-3 mb-2 shadow-sm flex items-center gap-2"><h3 class="font-bold text-gray-700 text-lg">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h3></div>
                <div id="my-posts-feed" class="space-y-3 pb-10"><p class="text-center text-gray-400 text-sm py-6">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            </div>
        </div>

        <div id="page-view-profile" class="hidden bg-[#f0f2f5] min-h-screen pb-20 z-50 absolute top-0 left-0 w-full">
             <div class="bg-white p-2 sticky top-0 z-30 shadow-sm flex items-center gap-2 pt-safe">
                <button onclick="switchPage('home')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                <h2 class="font-bold text-lg text-gray-800" id="view-profile-header-name">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</h2>
            </div>
            <div class="relative bg-white shadow-sm pb-4 mb-3">
                <div class="h-48 w-full bg-gradient-to-r from-blue-500 to-indigo-600 relative overflow-hidden">
                    <img id="view-profile-cover-img" class="w-full h-full object-cover hidden">
                </div>
                <div class="px-4">
                    <div class="relative -mt-24 mb-3 flex flex-col items-center">
                         <div class="w-40 h-40 rounded-full p-1.5 bg-white shadow-md z-10">
                            <div class="w-full h-full bg-gray-200 rounded-full flex items-center justify-center text-blue-600 text-5xl overflow-hidden font-bold border-4 border-white" id="view-profile-avatar-container"><span id="view-profile-initial">U</span></div>
                         </div>
                    </div>
                    <div class="text-center">
                        <h2 id="view-profile-name" class="text-2xl font-bold text-gray-900 flex items-center justify-center gap-1">...</h2>
                        <span id="view-profile-union-badge" class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mt-1 mb-1 font-bold">---</span>
                         <p class="text-sm text-gray-500"><i class="fa-solid fa-location-dot"></i> <span id="view-profile-village-text">...</span></p>
                        <p id="view-profile-bio" class="text-sm text-gray-600 mt-2 max-w-xs mx-auto italic">---</p>
                    </div>
                    <div id="view-profile-actions" class="flex gap-3 mt-6 border-b pb-4 px-2"></div>
                </div>
            </div>
            <div class="bg-white p-4 shadow-sm mb-3">
                <h3 class="font-bold text-lg text-gray-800 mb-3">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-briefcase w-6 text-center text-gray-400 text-lg"></i><span class="text-base">‡¶™‡ßá‡¶∂‡¶æ: <strong id="view-profile-profession" class="text-gray-800 ml-1">---</strong></span></div>
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-location-dot w-6 text-center text-gray-400 text-lg"></i><span class="text-base">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: <strong id="view-profile-location" class="text-gray-800 ml-1">---</strong></span></div>
                    <div class="flex items-center gap-3 text-gray-600"><i class="fa-solid fa-phone w-6 text-center text-gray-400 text-lg"></i><span class="text-base" id="view-profile-phone">---</span></div>
                </div>
            </div>
            <div class="bg-white p-4 shadow-sm mb-3">
                <div class="flex justify-between items-center mb-3">
                    <div><h3 class="font-bold text-lg text-gray-800">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¨‡¶æ‡¶®‡ßç‡¶ß‡¶¨</h3><p class="text-sm text-gray-500" id="friends-count-other">0 ‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</p></div>
                    <button id="btn-view-friends-other" class="text-blue-600 text-sm font-bold hover:bg-gray-100 px-3 py-1.5 rounded transition">‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                </div>
                <div id="profile-friends-preview-other" class="grid grid-cols-3 gap-2"><p class="col-span-3 text-center text-sm text-gray-400 py-4">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            </div>
            <div class="px-0">
                <div class="bg-white p-3 mb-2 shadow-sm border-t border-b border-gray-100"><h3 id="view-profile-posts-title" class="font-bold text-gray-700 text-lg">‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h3></div>
                <div id="view-profile-posts-feed" class="space-y-3 pb-10"><p class="text-center text-gray-400 text-sm">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            </div>
        </div>
        
        <div id="page-friends-list" class="hidden p-4 min-h-screen bg-gray-50 pb-20">
            <button onclick="window.history.back()" class="mb-4 text-gray-500 font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            <h2 class="text-xl font-bold mb-5 border-l-4 border-green-500 pl-3 text-gray-700">‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</h2>
            <div id="all-friends-container" class="grid grid-cols-1 gap-3"><p class="text-center text-gray-400 mt-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>

        <div id="page-blood" class="hidden p-4 bg-gray-50 min-h-screen">
            <button onclick="switchPage('services')" class="mb-4 text-gray-500 font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-6 text-center text-white mb-6 shadow-lg relative overflow-hidden">
                <i class="fa-solid fa-heart-pulse absolute -right-6 -bottom-6 text-9xl opacity-20"></i>
                <h2 class="text-2xl font-bold mb-2">‡¶∞‡¶ï‡ßç‡¶§ ‡¶¶‡¶ø‡¶®, ‡¶ú‡ßÄ‡¶¨‡¶® ‡¶¨‡¶æ‡¶Å‡¶ö‡¶æ‡¶®</h2>
                <div class="flex gap-2 justify-center mt-4">
                     <button onclick="toggleDonorModal(true)" class="bg-white text-red-600 px-5 py-2.5 rounded-full font-bold shadow-md text-sm hover:bg-red-50 transition transform hover:scale-105 active:scale-95">‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶π‡¶®</button>
                     <button onclick="toggleBloodRequestModal(true)" class="bg-red-800 text-white px-5 py-2.5 rounded-full font-bold shadow-md text-sm border border-red-400 animate-pulse hover:bg-red-900 transition transform hover:scale-105 active:scale-95">‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</button>
                </div>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm mb-4">
                <h3 class="font-bold text-gray-700 border-l-4 border-red-500 pl-3 mb-3">‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</h3>
                <div class="flex gap-2">
                    <select id="blood-filter" onchange="filterDonors()" class="w-1/2 text-sm bg-gray-50 border p-2.5 rounded-lg"><option value="all">‡¶∏‡¶ï‡¶≤ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="O+">O+</option><option value="O-">O-</option><option value="AB+">AB+</option><option value="AB-">AB-</option></select>
                    <select id="blood-union-filter" onchange="filterDonors()" class="w-1/2 text-sm bg-gray-50 border p-2.5 rounded-lg"><option value="all">‡¶∏‡¶ï‡¶≤ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ</option><option value="Char Duani Union">‡¶ö‡¶∞‡¶¶‡ßÅ‡¶Ø‡¶º‡¶æ‡¶®‡ßÄ</option><option value="Kakchira Union">‡¶ï‡¶æ‡¶ï‡¶ö‡¶ø‡¶∞‡¶æ</option><option value="Kalmegha Union">‡¶ï‡¶æ‡¶≤‡¶Æ‡ßá‡¶ò‡¶æ</option><option value="Kathaltoli Union">‡¶ï‡¶æ‡¶Å‡¶†‡¶æ‡¶≤‡¶§‡¶≤‡ßÄ</option><option value="Nachnapara Union">‡¶®‡¶æ‡¶ö‡¶®‡¶æ‡¶™‡¶æ‡¶°‡¶º‡¶æ</option><option value="Patharghata Union Sadar">‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ (‡¶∏‡¶¶‡¶∞)</option><option value="Raihanpur Union">‡¶∞‡¶æ‡¶Ø‡¶º‡¶π‡¶æ‡¶®‡¶™‡ßÅ‡¶∞</option></select>
                </div>
            </div>
            <div id="donor-list" class="space-y-3 pb-20"><p class="text-center text-gray-400 text-sm py-4">‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>
        
        <!-- NEW EMERGENCY ALERT PAGE -->
        <div id="page-emergency" class="hidden p-4 bg-gray-50 min-h-screen pb-20">
            <button onclick="switchPage('services')" class="mb-4 text-gray-500 font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-xl font-bold text-red-600 border-l-4 border-red-500 pl-3">‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü</h2>
                <button onclick="document.getElementById('emergency-modal').classList.remove('hidden-custom')" class="bg-red-600 text-white px-4 py-2 rounded-full text-xs font-bold shadow hover:bg-red-700 animate-pulse">
                    <i class="fa-solid fa-bullhorn mr-1"></i> ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶¶‡¶ø‡¶®
                </button>
            </div>
            <div id="emergency-list" class="space-y-3">
                <p class="text-center text-gray-400 py-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
            </div>
        </div>

        <div id="page-directory" class="hidden p-4 bg-gray-50 min-h-screen pb-20">
            <button onclick="switchPage('services')" class="mb-4 text-gray-500 font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            <h2 class="text-xl font-bold mb-5 border-l-4 border-blue-500 pl-3 text-gray-700">‡¶™‡ßç‡¶∞‡¶∂‡¶æ‡¶∏‡¶®‡¶ø‡¶ï ‡¶ì ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø</h2>
            <h4 class="font-bold text-gray-500 text-sm mb-3">‡¶™‡ßç‡¶∞‡¶∂‡¶æ‡¶∏‡¶®</h4>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div onclick="openDirectoryCategory('uno', '‡¶á‡¶â‡¶è‡¶®‡¶ì ‡¶Ö‡¶´‡¶ø‡¶∏')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-blue-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-building-flag text-3xl text-blue-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶á‡¶â‡¶è‡¶®‡¶ì</span></div>
                 <div onclick="openDirectoryCategory('acland', '‡¶≠‡ßÇ‡¶Æ‡¶ø ‡¶Ö‡¶´‡¶ø‡¶∏')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-green-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-file-contract text-3xl text-green-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶≠‡ßÇ‡¶Æ‡¶ø ‡¶Ö‡¶´‡¶ø‡¶∏</span></div>
                <div onclick="openDirectoryCategory('police', '‡¶•‡¶æ‡¶®‡¶æ ‡¶™‡ßÅ‡¶≤‡¶ø‡¶∂')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-indigo-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-shield-halved text-3xl text-indigo-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶•‡¶æ‡¶®‡¶æ</span></div>
            </div>
            <h4 class="font-bold text-gray-500 text-sm mb-3">‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ</h4>
            <div class="grid grid-cols-3 gap-3 mb-4">
                 <div onclick="openDirectoryCategory('health', '‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶ï‡¶Æ‡¶™‡ßç‡¶≤‡ßá‡¶ï‡ßç‡¶∏')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-red-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-hospital text-3xl text-red-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶π‡¶æ‡¶∏‡¶™‡¶æ‡¶§‡¶æ‡¶≤</span></div>
                <div onclick="openDirectoryCategory('electricity', '‡¶™‡¶≤‡ßç‡¶≤‡ßÄ ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-yellow-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-bolt text-3xl text-yellow-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé</span></div>
                <div onclick="openDirectoryCategory('fire', '‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-orange-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-fire-extinguisher text-3xl text-orange-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞</span></div>
            </div>
             <h4 class="font-bold text-gray-500 text-sm mb-3">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</h4>
            <div class="grid grid-cols-3 gap-3">
                <div onclick="openDirectoryCategory('doctor', '‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-blue-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-user-doctor text-3xl text-blue-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞</span></div>
                <div onclick="openDirectoryCategory('ambulance', '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶¨‡ßÅ‡¶≤‡ßá‡¶®‡ßç‡¶∏')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-red-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-truck-medical text-3xl text-red-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶¨‡ßÅ‡¶≤‡ßá‡¶®‡ßç‡¶∏</span></div>
                 <div onclick="openDirectoryCategory('union', '‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶™‡¶∞‡¶ø‡¶∑‡¶¶')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-teal-50 transition border border-gray-100 transform active:scale-95"><i class="fa-solid fa-building-columns text-3xl text-teal-600 mb-2"></i><span class="text-xs font-bold text-gray-600 text-center">‡¶á‡¶â‡¶™‡¶ø</span></div>
            </div>
        </div>

        <div id="page-directory-list" class="hidden p-4 bg-gray-50 min-h-screen pb-20">
            <button onclick="switchPage('directory')" class="mb-4 text-gray-500 font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> ‡¶∏‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</button>
            <h2 id="directory-list-title" class="text-xl font-bold mb-5 border-l-4 border-blue-500 pl-3 text-gray-700">‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
            <div id="directory-items-container" class="space-y-3"><p class="text-center text-gray-400 mt-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
        </div>

        <div id="page-complaints" class="hidden p-4 bg-gray-50 min-h-screen pb-20">
            <button onclick="switchPage('services')" class="mb-4 text-gray-500 font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            <h2 class="text-xl font-bold mb-5 border-l-4 border-red-500 pl-3 text-gray-700">‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ï‡ßç‡¶∏</h2>
            <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                <h3 class="font-bold text-gray-800 mb-3 text-base">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <div class="space-y-3">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">‡¶ï‡¶æ‡¶ï‡ßá ‡¶ú‡¶æ‡¶®‡¶æ‡¶¨‡ßá‡¶®?</label><select id="complaint-to" class="w-full bg-gray-50 border p-3 rounded-lg text-sm"><option value="UNO">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶π‡ßÄ ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ (UNO)</option><option value="OC">‡¶•‡¶æ‡¶®‡¶æ ‡¶™‡ßÅ‡¶≤‡¶ø‡¶∂ (OC)</option><option value="Chairman">‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶ö‡ßá‡ßü‡¶æ‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®</option><option value="ViceChairman">‡¶≠‡¶æ‡¶á‡¶∏ ‡¶ö‡ßá‡ßü‡¶æ‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®</option><option value="General">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">‡¶¨‡¶ø‡¶∑‡ßü</label><select id="complaint-type" class="w-full bg-gray-50 border p-3 rounded-lg text-sm"><option value="Road">‡¶∞‡¶æ‡¶∏‡ßç‡¶§‡¶æ‡¶ò‡¶æ‡¶ü ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶æ‡¶∞</option><option value="Water">‡¶™‡¶æ‡¶®‡¶ø ‡¶ì ‡¶™‡ßü‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∂‡¶®</option><option value="Dispute">‡¶™‡¶æ‡¶∞‡¶ø‡¶¨‡¶æ‡¶∞‡¶ø‡¶ï/‡¶ú‡¶Æ‡¶ø ‡¶¨‡¶ø‡¶∞‡ßã‡¶ß</option><option value="Corruption">‡¶Ö‡¶®‡¶ø‡ßü‡¶Æ ‡¶ì ‡¶¶‡ßÅ‡¶∞‡ßç‡¶®‡ßÄ‡¶§‡¶ø</option><option value="Other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option></select></div>
                    <textarea id="complaint-text" rows="3" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="w-full bg-gray-50 border p-3 rounded-lg text-sm"></textarea>
                    <div class="flex items-center gap-2"><input type="checkbox" id="complaint-anon" class="w-5 h-5 text-green-600 rounded"><label for="complaint-anon" class="text-sm text-gray-600 font-medium">‡¶®‡¶æ‡¶Æ ‡¶ó‡ßã‡¶™‡¶® ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶® (Anonymous)</label></div>
                    <button onclick="submitComplaint()" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow hover:bg-red-700 text-base mt-2">‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
                </div>
            </div>
            <div><h3 class="font-bold text-gray-700 mb-3 text-sm">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó‡¶∏‡¶Æ‡ßÇ‡¶π</h3><div id="my-complaints-list" class="space-y-3"><p class="text-center text-gray-400 text-xs py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶®‡ßá‡¶á</p></div></div>
        </div>

        <div id="page-settings" class="hidden p-0 bg-gray-100 min-h-screen pb-20">
             <div class="bg-white p-4 sticky top-0 z-30 shadow-sm border-b pt-safe flex items-center gap-2">
                <button onclick="switchPage('home')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                <h2 class="text-xl font-bold text-gray-800">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h2>
            </div>
            <div class="p-4 space-y-4">
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-3 bg-gray-50 border-b font-bold text-gray-700 text-sm">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</div>
                    <div class="p-4 space-y-4">
                        <div onclick="toggleEditProfile(true)" class="flex items-center justify-between cursor-pointer hover:bg-gray-50 p-2 rounded transition"><span class="text-base text-gray-700">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶è‡¶°‡¶ø‡¶ü</span><i class="fa-solid fa-pen-to-square text-gray-400 text-lg"></i></div>
                        <div class="flex items-center justify-between p-2"><span class="text-base text-gray-700">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤/‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶ó‡ßã‡¶™‡¶® ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®</span><input type="checkbox" onchange="togglePrivacy(this.checked)" id="setting-privacy-toggle" class="w-6 h-6 text-green-600 rounded"></div>
                        <div onclick="toggleAuth('forgot'); handleLogout()" class="flex items-center justify-between cursor-pointer hover:bg-gray-50 p-2 rounded transition"><span class="text-base text-gray-700">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</span><i class="fa-solid fa-key text-gray-400 text-lg"></i></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-3 bg-gray-50 border-b font-bold text-gray-700 text-sm">‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</div>
                    <div class="p-4 space-y-4">
                        <div class="flex items-center justify-between p-2"><span class="text-base text-gray-700">‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü</span><input type="checkbox" id="toggle-blood-alert" onchange="updateSettings('bloodAlert', this.checked)" class="w-6 h-6 text-green-600 rounded"></div>
                        <div class="flex items-center justify-between p-2"><span class="text-base text-gray-700">‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶¶‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</span><input type="checkbox" id="toggle-market-alert" onchange="updateSettings('marketAlert', this.checked)" class="w-6 h-6 text-green-600 rounded"></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-3 bg-gray-50 border-b font-bold text-gray-700 text-sm">‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá</div>
                    <div class="p-4 flex gap-4"><button onclick="changeFontSize('small')" class="flex-1 border py-2.5 rounded hover:bg-gray-50 text-sm font-medium">‡¶õ‡ßã‡¶ü</button><button onclick="changeFontSize('normal')" class="flex-1 border py-2.5 rounded hover:bg-gray-50 text-base font-bold bg-gray-100">‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï</button><button onclick="changeFontSize('large')" class="flex-1 border py-2.5 rounded hover:bg-gray-50 text-lg font-medium">‡¶¨‡ßú</button></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-red-100">
                    <div class="p-3 bg-red-50 border-b font-bold text-red-700 text-sm">‡¶°‡ßá‡¶û‡ßç‡¶ú‡¶æ‡¶∞ ‡¶ú‡ßã‡¶®</div>
                    <div class="p-4"><button onclick="handleDeleteAccount()" class="w-full border border-red-500 text-red-600 py-3 rounded-lg font-bold text-base hover:bg-red-50 transition">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
                </div>
                 <div class="text-center text-xs text-gray-400 mt-4">‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶® ‡ß©.‡ßÆ.‡ß¶ | ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü: help@patharghata.com</div>
            </div>
        </div>

        <!-- NEW FULL SCREEN VERIFICATION PAGE -->
        <div id="page-verification" class="hidden p-0 min-h-screen bg-gray-50 pb-20">
            <div class="bg-white p-4 sticky top-0 z-30 shadow-sm border-b pt-safe flex items-center gap-2">
                <button onclick="switchPage('home')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fa-solid fa-arrow-left text-lg"></i></button>
                <h2 class="text-xl font-bold text-gray-800">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</h2>
            </div>
            
            <div class="p-4" id="verification-content-area">
                <!-- Status Banner (Dynamic) -->
                <div id="verify-status-banner" class="hidden mb-6"></div>

                <!-- Main Form (Hidden if Pending/Verified) -->
                <div id="verify-form-container">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-blue-100 mb-6 text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600 text-3xl">
                            <i class="fa-solid fa-shield-halved"></i>
                        </div>
                        <h3 class="font-bold text-xl text-gray-800">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶° ‡¶π‡ßã‡¶®</h3>
                        <p class="text-sm text-gray-500 mt-1">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶¨‡ßç‡¶≤‡ßÅ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶æ‡¶∏‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø‡¶§‡¶æ ‡¶¨‡¶æ‡ßú‡¶æ‡¶®‡•§</p>
                    </div>

                    <h4 class="font-bold text-gray-700 mb-3 border-l-4 border-blue-500 pl-3">‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
                    <div id="verification-plans-container" class="space-y-3 mb-6">
                        <p class="text-center text-sm text-gray-400">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
                    </div>
                    <input type="hidden" id="selected-plan-id">

                    <!-- Payment Section -->
                    <div id="verification-payment-section" class="hidden bg-white p-4 rounded-xl shadow-sm mb-6">
                        <h4 class="font-bold text-sm text-gray-700 mb-3">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°:</h4>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <div onclick="selectPaymentMethod('Bkash')" class="payment-method border p-2 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 transition" id="pay-bkash">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR7-3pW0rX1C7s7s7s7s7s7s7s7s7s7s7s7s7s&s" alt="Bkash" class="h-8 object-contain">
                                <span class="text-xs font-bold mt-1">Bkash</span>
                            </div>
                            <div onclick="selectPaymentMethod('Nagad')" class="payment-method border p-2 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 transition" id="pay-nagad">
                                <img src="https://downloadr2.apkmirror.com/wp-content/uploads/2019/07/5d26305f8c679.png" alt="Nagad" class="h-8 object-contain">
                                <span class="text-xs font-bold mt-1">Nagad</span>
                            </div>
                            <div onclick="selectPaymentMethod('Rocket')" class="payment-method border p-2 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 transition" id="pay-rocket">
                                <img src="https://seeklogo.com/images/D/dutch-bangla-rocket-logo-B4D1CC458D-seeklogo.com.png" alt="Rocket" class="h-8 object-contain">
                                <span class="text-xs font-bold mt-1">Rocket</span>
                            </div>
                        </div>
                        <input type="hidden" id="selected-payment-method">
                        
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 mb-4">
                            <p class="text-xs text-gray-600">‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá <span id="admin-number" class="font-bold text-gray-900 text-sm">...</span> ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá Send Money ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                        </div>

                        <div class="space-y-3">
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">‡¶∏‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
                                <input type="tel" id="verify-payment-number" placeholder="‡¶Ø‡ßá ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®" class="w-full bg-gray-50 border p-3 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">Transaction ID</label>
                                <input type="text" id="verify-trx-id" placeholder="TrxID (Example: 9H7D...)" class="w-full bg-gray-50 border p-3 rounded-lg text-sm uppercase">
                            </div>
                        </div>
                    </div>

                    <!-- Documents Section -->
                    <div id="verification-docs-section" class="hidden bg-white p-4 rounded-xl shadow-sm mb-6">
                         <h4 class="font-bold text-sm text-gray-700 mb-3">‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü ‡¶ï‡¶æ‡¶ó‡¶ú‡¶™‡¶§‡ßç‡¶∞:</h4>
                         <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">NID / ‡¶ú‡¶®‡ßç‡¶Æ ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
                                <input type="text" id="verify-nid" placeholder="‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®" class="w-full bg-gray-50 border p-3 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø (NID/Birth Certificate)</label>
                                <input type="file" id="verify-doc-img" accept="image/*" class="w-full bg-gray-50 border border-gray-200 p-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶¶‡ßç‡¶Ø ‡¶§‡ßã‡¶≤‡¶æ ‡¶õ‡¶¨‡¶ø</label>
                                <input type="file" id="verify-user-img" accept="image/*" class="w-full bg-gray-50 border border-gray-200 p-2 rounded-lg text-sm">
                            </div>
                        </div>
                    </div>

                    <button onclick="submitVerification()" id="btn-verify-submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition flex justify-center items-center gap-2 text-lg disabled:opacity-50 disabled:cursor-not-allowed hidden">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-2 z-50 text-gray-500 max-w-[480px] mx-auto shadow-[0_-5px_15px_rgba(0,0,0,0.05)] pb-safe">
        <div onclick="handleHomeClick()" class="nav-btn w-1/5 text-center cursor-pointer nav-active py-1" id="btn-home"><i class="fa-solid fa-house mb-1"></i><p>‡¶π‡ßã‡¶Æ</p></div>
        <div onclick="switchPage('services')" class="nav-btn w-1/5 text-center cursor-pointer py-1" id="btn-services"><i class="fa-solid fa-layer-group mb-1"></i><p>‡¶∏‡ßá‡¶¨‡¶æ</p></div>
        <div onclick="switchPage('messages')" class="nav-btn w-1/5 text-center cursor-pointer py-1" id="btn-messages"><i class="fa-solid fa-comments mb-1"></i><p>‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</p></div>
        <div onclick="switchPage('people')" class="nav-btn w-1/5 text-center cursor-pointer py-1" id="btn-people"><i class="fa-solid fa-users mb-1"></i><p>‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑</p><span id="nav-badge-people" class="nav-badge">0</span></div>
        <div onclick="switchPage('profile')" class="nav-btn w-1/5 text-center cursor-pointer py-1" id="btn-profile"><i class="fa-solid fa-user mb-1"></i><p>‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</p></div>
    </nav>

    <div class="fixed bottom-24 right-5 z-40 flex flex-col items-center gap-4 pb-safe transition-all duration-300" id="fab-container">
        <div id="fab-options" class="fab-options flex flex-col gap-3">
            <button onclick="togglePostModal(true); toggleFab()" class="bg-white text-gray-700 w-14 h-14 rounded-full shadow-lg flex items-center justify-center border border-gray-100 hover:bg-gray-50"><i class="fa-solid fa-pen text-xl"></i></button>
            <button onclick="togglePollModal(true); toggleFab()" class="bg-white text-blue-600 w-14 h-14 rounded-full shadow-lg flex items-center justify-center border border-gray-100 hover:bg-blue-50"><i class="fa-solid fa-square-poll-vertical text-xl"></i></button>
        </div>
        <div onclick="toggleFab()" id="main-fab" class="fab-btn bg-green-600 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-2xl cursor-pointer hover:bg-green-700 border-2 border-white"><i class="fa-solid fa-plus"></i></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, onChildAdded, onChildChanged, get, update, remove, query, limitToLast, runTransaction, startAt, endAt, orderByChild, orderByKey, equalTo, limitToFirst } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

     // --- CONFIGURATION ---
    const APP_CONFIG = {
        firebase: { apiKey: "AIzaSyBfI-THOXOvhyL7LumZVKixtTVwF94CjsI", authDomain: "pathargata-digital-comnity-ltd.firebasestorage.app", databaseURL: "https://pathargata-digital-comnity-ltd-default-rtdb.firebaseio.com", projectId: "pathargata-digital-comnity-ltd", storageBucket: "pathargata-digital-comnity-ltd.firebasestorage.app", messagingSenderId: "991014085926", appId: "1:991014085926:android:b249e489d8424433ed4de7" },
        locations: { "Patharghata Union Sadar": ["‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ", "‡¶ó‡¶π‡¶∞‡¶™‡ßÅ‡¶∞", "‡¶®‡¶ø‡¶ú‡¶≤‡¶æ‡¶†‡¶ø‡¶Æ‡¶æ‡¶∞‡¶æ", "‡¶π‡¶æ‡¶§‡ßá‡¶Æ‡¶™‡ßÅ‡¶∞", "‡¶¨‡ßú‡¶á‡¶§‡¶≤‡¶æ", "‡¶¨‡ßú ‡¶ü‡ßá‡¶Ç‡¶∞‡¶æ", "‡¶ï‡ßã‡ßú‡¶æ‡¶≤‡¶ø‡ßü‡¶æ", "‡¶∞‡ßÅ‡¶π‡¶ø‡¶§‡¶æ", "‡¶™‡¶¶‡ßç‡¶Æ‡¶æ", "‡¶π‡¶æ‡ßú‡¶ø‡¶ü‡¶æ‡¶®‡¶æ", "‡¶¨‡¶æ‡¶¶‡ßÅ‡¶∞‡¶§‡¶≤‡¶æ", "‡¶ö‡¶∞‡¶≤‡¶æ‡¶†‡¶ø‡¶Æ‡¶æ‡¶∞‡¶æ"], "Char Duani Union": ["‡¶ö‡¶∞‡¶¶‡ßÅ‡¶Ø‡¶º‡¶æ‡¶®‡ßÄ", "‡¶¶‡¶ï‡ßç‡¶∑‡¶ø‡¶£ ‡¶ö‡¶∞‡¶¶‡ßÅ‡¶Ø‡¶º‡¶æ‡¶®‡ßÄ", "‡¶Æ‡¶†‡ßá‡¶∞ ‡¶ñ‡¶æ‡¶≤", "‡¶π‡ßã‡¶ó‡¶≤‡¶æ‡¶™‡¶æ‡¶∂‡¶æ", "‡¶ó‡¶æ‡¶¨‡¶¨‡¶æ‡¶°‡¶º‡¶ø‡¶Ø‡¶º‡¶æ"], "Kakchira Union": ["‡¶ï‡¶æ‡¶ï‡¶ö‡¶ø‡¶∞‡¶æ", "‡¶ú‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶ò‡¶æ‡¶ü‡¶æ", "‡¶∞‡ßÇ‡¶™‡¶ß‡¶®", "‡¶¨‡¶æ‡¶á‡¶≤‡¶æ‡¶ö‡¶æ‡¶∞‡¶æ"], "Kalmegha Union": ["‡¶ï‡¶æ‡¶≤‡¶Æ‡ßá‡¶ò‡¶æ", "‡¶ò‡ßÅ‡¶ü‡¶æ‡¶¨‡¶æ‡¶õ‡¶æ", "‡¶ï‡ßÅ‡¶™‡¶¶‡ßã‡¶®", "‡¶™‡¶∂‡ßç‡¶ö‡¶ø‡¶Æ ‡¶ï‡¶æ‡¶≤‡¶Æ‡ßá‡¶ò‡¶æ"], "Kathaltoli Union": ["‡¶ï‡¶æ‡¶Å‡¶†‡¶æ‡¶≤‡¶§‡¶≤‡ßÄ", "‡¶§‡¶æ‡¶≤‡¶§‡¶≤‡ßÄ", "‡¶∏‡¶æ‡¶™‡¶≤‡ßá‡¶ú‡¶æ", "‡¶ï‡¶∞‡ßÅ‡¶£‡¶æ"], "Nachnapara Union": ["‡¶®‡¶æ‡¶ö‡¶®‡¶æ‡¶™‡¶æ‡¶°‡¶º‡¶æ", "‡¶ú‡ßç‡¶û‡¶æ‡¶®‡¶™‡¶æ‡¶°‡¶º‡¶æ", "‡¶¨‡¶æ‡¶Å‡¶∂‡¶§‡¶≤‡¶æ", "‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï‡¶ñ‡¶æ‡¶≤‡ßÄ"], "Raihanpur Union": ["‡¶∞‡¶æ‡¶Ø‡¶º‡¶π‡¶æ‡¶®‡¶™‡ßÅ‡¶∞", "‡¶∂‡¶§‡¶ï‡¶∞", "‡¶≤‡ßá‡¶Æ‡ßÅ‡¶Ø‡¶º‡¶æ", "‡¶π‡¶∞‡¶ø‡¶£‡¶ò‡¶æ‡¶ü‡¶æ"] },
        services: { "directory": { title: "‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø", icon: "fa-address-book", color: "text-blue-600", bg: "bg-blue-50" }, "blood": { title: "‡¶∞‡¶ï‡ßç‡¶§‡¶¶‡¶æ‡¶®", icon: "fa-droplet", color: "text-red-600", bg: "bg-red-50" }, "emergency": { title: "‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü", icon: "fa-triangle-exclamation", color: "text-red-600", bg: "bg-red-50" }, "history_tourism": { title: "‡¶™‡¶∞‡ßç‡¶Ø‡¶ü‡¶®", icon: "fa-landmark", color: "text-purple-600", bg: "bg-purple-50" }, "transport": { title: "‡¶™‡¶∞‡¶ø‡¶¨‡¶π‡¶®", icon: "fa-bus", color: "text-teal-600", bg: "bg-teal-50" }, "education": { title: "‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ", icon: "fa-graduation-cap", color: "text-yellow-600", bg: "bg-yellow-50" }, "complaints": { title: "‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó", icon: "fa-box-archive", color: "text-red-600", bg: "bg-red-50" }, "market": { title: "‡¶π‡¶æ‡¶ü", icon: "fa-store", color: "text-orange-600", bg: "bg-orange-50" } }
    };

    const app = initializeApp(APP_CONFIG.firebase);
    const db = getDatabase(app);
    const auth = getAuth(app);
    
    window.currentUser = null;
    let userDetails = {}, allUsers = [], myFriends = [], currentChatUser = null, allDonors = [], currentFullPostId = null, globalMarketItems = [], globalDirectory = {};
    let allAds = []; // Store fetched ads
    
    // --- CACHING & GLOBALS (Optimized) ---
    const userCache = {}; // Cache to store user profiles and avoid re-fetching
    let currentFeedFilter = 'all';
    let lastLoadedPostKey = null;
    let isFeedLoading = false;
    let hasMorePosts = true;
    let feedObserver = null;
    let lastScrollTop = 0; // For scroll direction detection
    
    // Profile Pagination Globals
    let profilePostsFullList = [];
    let currentProfileRenderCount = 0;
    let isProfileRendering = false;
    let currentProfileViewMode = '';
    
    // Notification Pagination Variables
    let lastNotifKey = null;
    let hasMoreNotifs = true;
    
    // Global variables for new features
    window.selectedImages = [];
    window.taggedUsers = [];
    window.selectedFeeling = null;
    
    // --- ENCRYPTION HELPERS (Simple AES) ---
    const SECRET_KEY = "PatharghataDigitalSecretKey"; 
    window.encryptMsg = (text) => { return CryptoJS.AES.encrypt(text, SECRET_KEY).toString(); };
    window.decryptMsg = (cipherText) => { 
        try {
            const bytes = CryptoJS.AES.decrypt(cipherText, SECRET_KEY);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);
            return originalText || cipherText; // Return original if decryption fails (backward compatibility)
        } catch(e) { return cipherText; }
    };

    // --- HELPER FUNCTIONS ---
    window.escapeHTML = (str) => { if (!str) return ""; return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
    window.showToast = (msg, type = 'success') => { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = 'toast'; toast.innerText = msg; toast.style.borderLeft = type === 'error' ? "4px solid #ef4444" : "4px solid #22c55e"; container.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; setTimeout(()=> toast.remove(), 300); }, 3000); }
    window.togglePassword = (id, icon) => { const input = document.getElementById(id); if (input.type === "password") { input.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); } else { input.type = "password"; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); } };
    function timeAgo(timestamp) { const seconds = Math.floor((Date.now() - timestamp) / 1000); if (seconds < 60) return "‡¶è‡¶á‡¶Æ‡¶æ‡¶§‡ßç‡¶∞"; const minutes = Math.floor(seconds / 60); if (minutes < 60) return minutes + " ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶Ü‡¶ó‡ßá"; const hours = Math.floor(minutes / 60); if (hours < 24) return hours + " ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ‡¶Ü‡¶ó‡ßá"; const days = Math.floor(hours / 24); if (days < 30) return days + " ‡¶¶‡¶ø‡¶® ‡¶Ü‡¶ó‡ßá"; const months = Math.floor(days / 30); if (months < 12) return months + " ‡¶Æ‡¶æ‡¶∏ ‡¶Ü‡¶ó‡ßá"; return Math.floor(months / 12) + " ‡¶¨‡¶õ‡¶∞ ‡¶Ü‡¶ó‡ßá"; }
    function checkUserBadge(user) { if (!user) return ""; const role = user.role ? user.role.toLowerCase() : ''; if (role === 'journalist') return `<i class="fa-solid fa-feather-pointed journalist-badge"></i>`; if (user.isVerified || ['chairman', 'member', 'admin', 'doctor', 'uno', 'oc'].includes(role)) return `<i class="fa-solid fa-circle-check verified-badge"></i>`; return ""; }
    
    // --- UPDATED CLOUDINARY UPLOAD (NO VIDEO FOR USER) ---
    async function uploadMediaToCloudinary(file) {
        if (file.type.startsWith('video/')) {
            alert("‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡¶®‡ßç‡¶ß‡•§ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            throw new Error("Video upload not allowed for users");
        }
        let fileToUpload = file;
        if (file.type.startsWith('image/')) {
            try { fileToUpload = await resizeImage(file); } catch (e) { console.warn("Image resize failed, uploading original", e); }
        }
        const formData = new FormData();
        formData.append('file', fileToUpload);
        formData.append('upload_preset', 'Pathargata digital');
        try {
            const res = await fetch('https://api.cloudinary.com/v1_1/dl1auoanl/auto/upload', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            return { url: data.secure_url, type: data.resource_type };
        } catch (error) { console.error("Cloudinary Upload Error:", error); throw error; }
    }

    // Helper: Resize Image using Canvas
    function resizeImage(file, maxWidth = 800) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height;
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => { if (blob) resolve(new File([blob], file.name, { type: 'image/jpeg' })); else reject(new Error("Canvas blob error")); }, 'image/jpeg', 0.7);
                }; img.onerror = reject;
            }; reader.onerror = reject;
        });
    }
    
    // Helper to fetch user data with Caching
    async function getUserData(uid) {
        if (userCache[uid]) return userCache[uid];
        try { const snap = await get(ref(db, 'users/' + uid)); const val = snap.val(); if (val) userCache[uid] = val; return val; } catch (e) { console.error("Error fetching user", uid, e); return null; }
    }

    // --- DEBOUNCE UTILITY ---
    function debounce(func, wait) {
        let timeout;
        return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
    }
    
    // --- KEYBOARD HANDLER ---
    window.handleEnter = (e, type, param) => {
        if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if(type === 'chat') sendMsg(); else if(type === 'comment') submitInlineComment(param); else if(type === 'full-comment') submitFullComment(); }
    }

    // --- ADS HELPER FUNCTIONS ---
    function loadAds() {
        onValue(ref(db, 'ads'), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                allAds = Object.values(data);
            }
        });
    }

    function createAdHTML(ad) {
        return `<div class="bg-white p-3 rounded-xl shadow-sm mb-3 border border-orange-100 relative max-w-lg mx-auto">
           <div class="flex justify-between items-center mb-2">
               <span class="bg-orange-100 text-orange-600 text-[10px] font-bold px-2 py-0.5 rounded">SPONSORED</span>
               <i class="fa-solid fa-bullhorn text-orange-300"></i>
           </div>
           <a href="${ad.link || '#'}" target="_blank">
               ${ad.image ? `<img src="${ad.image}" class="w-full h-40 object-cover rounded-lg mb-2">` : ''}
               <h4 class="font-bold text-gray-800">${escapeHTML(ad.title)}</h4>
               <p class="text-xs text-gray-500 mb-2">${escapeHTML(ad.description || '')}</p>
               <button class="w-full mt-1 bg-orange-500 text-white py-2 rounded-lg font-bold text-sm">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
           </a>
        </div>`;
    }

    // --- ALGORITHMIC SCORING FUNCTION ---
    function calculatePostScore(post) {
        const now = Date.now();
        // 1. Time Decay (Hours since posted)
        const hoursAge = (now - post.timestamp) / (1000 * 60 * 60);

        // 2. Engagement Points
        const likeCount = post.likes ? Object.keys(post.likes).length : 0;
        const commentCount = post.comments ? Object.keys(post.comments).length : 0;
        let points = (likeCount * 10) + (commentCount * 20);

        // 3. Authority Bonus
        if (['admin', 'journalist'].includes(post.authorRole)) {
            points += 50;
        }

        // 4. Database Boost
        if (post.adminScore) {
            points += parseInt(post.adminScore);
        }

        // Formula: (Points + 1) / (Age + 2)^Gravity
        // This ensures newer posts rank high, but extremely popular older posts can stay up
        const score = (points + 1) / Math.pow((hoursAge + 2), 1.8);

        return score;
    }

    onAuthStateChanged(auth, (user) => {
        const authScreen = document.getElementById('auth-screen'), mainApp = document.getElementById('main-app'), splash = document.getElementById('splash-screen');
        setTimeout(() => { splash.classList.add('hidden-custom'); }, 1500);
        if (user) {
            window.currentUser = user; 
            authScreen.classList.add('hidden-custom'); mainApp.classList.remove('hidden-custom');
            const savedSize = localStorage.getItem('fontSize'); if(savedSize) changeFontSize(savedSize);
            
            // Initial Page Load handling
            if (!history.state) { 
                const currentHash = window.location.hash.replace('#', ''); 
                if (currentHash && currentHash !== 'home') setTimeout(() => switchPage(currentHash), 500); 
                else history.replaceState({ page: 'home' }, "", "#home"); 
            } else {
                 switchPage(history.state.page || 'home', false);
            }
            
            // FETCH USER DATA WITH ERROR HANDLING FOR OFFLINE
            onValue(ref(db, 'users/' + user.uid), (snap) => { 
                const data = snap.val();
                if(data) {
                    userDetails = data; 
                    updateUIWithUserData(); 
                    loadFriendsPreview(user.uid, 'me'); 
                    loadSettingsData(); 
                    if(document.getElementById('setting-privacy-toggle')) document.getElementById('setting-privacy-toggle').checked = userDetails.privacy_hide_contact || false; 
                    
                    // Also load monetization check
                    checkMonetizationStatus();
                }
            });
            
            loadServiceCategories(); loadDynamicSidebar();
            onValue(ref(db, `users/${user.uid}/friends`), (snap) => { myFriends = snap.exists() ? Object.keys(snap.val()) : []; loadQuickChatFriends(); });
            loadUserSuggestions(); onValue(ref(db, 'directory'), (snap) => { globalDirectory = snap.val() || {}; });
            listenForFriendRequests(user.uid); 
            listenForNotificationBadge(user.uid); 
            loadNotifications(true); 
            loadChatList(user.uid); loadMyComplaints();
            loadEmergencyAlerts(); 
            
            // Initial Load
            loadAds(); // Fetch Ads
            loadFeed('all', true); 
            
            setupInfiniteScroll(); 
            setupVideoObserver(); 
            
            onValue(ref(db, 'app_info/name'), (snap) => { const name = snap.val(); if(name) document.getElementById('app-header-title').innerText = name; });
        } else { window.currentUser = null; authScreen.classList.remove('hidden-custom'); mainApp.classList.add('hidden-custom'); document.getElementById('login-form').classList.remove('hidden-custom'); }
    });

    // --- SCROLL HANDLER (UPDATED for Profile Infinite Scroll) ---
    window.onscroll = function() {
        // FAB Logic
        if (document.getElementById('page-home') && !document.getElementById('page-home').classList.contains('hidden')) {
            let st = window.pageYOffset || document.documentElement.scrollTop;
            const fabContainer = document.getElementById('fab-container');
            
            if (st > lastScrollTop && st > 50) { fabContainer.classList.add('scroll-hidden'); } 
            else { fabContainer.classList.remove('scroll-hidden'); }
            lastScrollTop = st <= 0 ? 0 : st; 
        }

        // Profile Infinite Scroll Logic
        if ((document.getElementById('page-profile').classList.contains('hidden') === false) || 
            (document.getElementById('page-view-profile').classList.contains('hidden') === false)) {
            
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                renderProfileChunk();
            }
        }
    };

    // --- VIDEO AUTOPLAY OBSERVER ---
    function setupVideoObserver() {
        const videoObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.target.tagName === 'VIDEO') {
                    if (entry.isIntersecting) {
                        entry.target.play().catch(e => console.log('Autoplay blocked', e));
                    } else {
                        entry.target.pause();
                    }
                }
            });
        }, { threshold: 0.5 });

        const feedContainer = document.getElementById('news-feed');
        const mutationObserver = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === 1) { 
                        const videos = node.querySelectorAll('video');
                        videos.forEach(v => videoObserver.observe(v));
                        if (node.tagName === 'VIDEO') videoObserver.observe(node);
                    }
                });
            });
        });
        mutationObserver.observe(feedContainer, { childList: true, subtree: true });
    }

    function loadServiceCategories() {
        const grid = document.getElementById('services-grid');
        get(ref(db, 'services/categories')).then((snap) => { 
            const categories = { ...APP_CONFIG.services, ...(snap.val() || {}) }; 
            grid.innerHTML = Object.entries(categories).map(([key, cat]) => {
                let onclick = ['directory', 'blood', 'complaints', 'market', 'emergency'].includes(key) ? `switchPage('${key}')` : `openDynamicCategory('${key}', '${cat.title}')`; 
                return `<div onclick="${onclick}" class="cursor-pointer group transform active:scale-95 transition bg-white border border-gray-100 rounded-2xl p-4 flex flex-col items-center justify-center shadow-sm hover:shadow-md aspect-[4/3]"><div class="w-14 h-14 ${cat.bg} ${cat.color} rounded-full flex items-center justify-center mb-2"><i class="fa-solid ${cat.icon} text-2xl"></i></div><p class="text-base font-bold text-gray-700 text-center">${cat.title}</p></div>`;
            }).join('');
        });
    }

    window.handleChatImageSelect = () => {
        const file = document.getElementById('chat-img-input').files[0];
        if (file) {
            const btn = document.getElementById('btn-chat-send');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true;
            
            uploadMediaToCloudinary(file).then(res => { 
                sendMsg(res.url); 
                document.getElementById('chat-img-input').value = ""; 
            }).catch(e => { 
                showToast("‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø: " + e.message, 'error'); 
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>'; 
                btn.disabled = false; 
            });
        }
    };

    // --- UPDATED SEND MSG WITH ENCRYPTION ---
    window.sendMsg = (imageUrl = null) => { 
        if(!currentChatUser) return; 
        const input = document.getElementById('msg-input'); const text = input.value.trim(); 
        if(!text && !imageUrl) return; 
        const btn = document.getElementById('btn-chat-send');
        const chatId = getChatId(window.currentUser.uid, currentChatUser.uid); const ts = Date.now(); 
        
        // Encrypt Text
        const encryptedText = text ? window.encryptMsg(text) : "";

        const msgData = { sender: window.currentUser.uid, timestamp: ts };
        if (text) msgData.text = encryptedText; // Store Encrypted
        if (imageUrl) msgData.image = imageUrl;
        
        push(ref(db, `chats/${chatId}`), msgData); 
        
        // For Last Message in User Chats (Encrypted)
        const lastMsg = imageUrl ? (text ? "üì∑ " + encryptedText : "üì∑ ‡¶õ‡¶¨‡¶ø ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®") : encryptedText;
        const myUpdate = { name: currentChatUser.name, lastMessage: "You: " + lastMsg, timestamp: ts }; 
        const peerUpdate = { name: userDetails.name, lastMessage: lastMsg, timestamp: ts }; 
        
        update(ref(db, `user_chats/${window.currentUser.uid}/${currentChatUser.uid}`), myUpdate); 
        update(ref(db, `user_chats/${currentChatUser.uid}/${window.currentUser.uid}`), peerUpdate); 
        
        input.value = ""; btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>'; btn.disabled = false;
    };

    // --- UPDATED LOAD MESSAGES (Decryption & Scrolling) ---
    function loadMessages(otherUid) { 
        const chatId = getChatId(window.currentUser.uid, otherUid); 
        const div = document.getElementById('messages-container'); 
        div.innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>'; 
        onValue(query(ref(db, `chats/${chatId}`), limitToLast(50)), (snap) => { 
            const msgs = snap.val() || {};
            if(Object.keys(msgs).length > 0) {
                div.innerHTML = Object.values(msgs).map(m => { 
                    const isMe = m.sender === window.currentUser.uid; 
                    let content = '';
                    if (m.image) content += `<img src="${m.image}" class="rounded-lg mb-1 max-w-full h-auto cursor-pointer" onclick="window.open('${m.image}')">`;
                    
                    // Decrypt Message
                    if (m.text) {
                        const decrypted = window.decryptMsg(m.text);
                        content += `<span>${escapeHTML(decrypted)}</span>`;
                    }
                    
                    return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'} mb-2"><div class="px-4 py-2 max-w-[75%] text-sm ${isMe ? 'chat-bubble-me' : 'chat-bubble-other'}">${content}</div></div>`; 
                }).join('');
                
                // Better Scroll to Bottom
                setTimeout(() => {
                    div.scrollTop = div.scrollHeight;
                }, 100);
            } else div.innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">‡¶ï‡¶•‡¶™‡ßã‡¶ï‡¶•‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</p>';
        }); 
    }

    // --- UPDATED LOAD CHAT LIST (Fetch Profile Pic, Fixed Layout, Decryption) ---
    function loadChatList(uid) { 
        onValue(ref(db, `user_chats/${uid}`), async (snap) => { 
            const list = snap.val() || {}; 
            const container = document.getElementById('chat-list-container'); 
            
            if(Object.keys(list).length > 0) {
                // Prepare Promises to fetch user profile pics
                const promises = Object.entries(list).sort((a,b)=>b[1].timestamp - a[1].timestamp).map(async ([peerUid, info]) => {
                    const userData = await getUserData(peerUid);
                    const profilePic = userData?.profile_pic;
                    return { peerUid, info, profilePic };
                });

                const chatItems = await Promise.all(promises);

                container.innerHTML = chatItems.map(({peerUid, info, profilePic}) => {
                    // Decrypt Last Message for preview
                    let rawLastMsg = info.lastMessage || "";
                    let displayMsg = rawLastMsg;
                    
                    // Check if it starts with "You: "
                    let prefix = "";
                    if(rawLastMsg.startsWith("You: ")) {
                        prefix = "You: ";
                        rawLastMsg = rawLastMsg.substring(5);
                    }
                    
                    // Check if image
                    if(rawLastMsg.includes("üì∑")) {
                        // Keep simple
                    } else {
                        rawLastMsg = window.decryptMsg(rawLastMsg);
                    }
                    displayMsg = prefix + rawLastMsg;

                    let av = profilePic 
                        ? `<img src="${profilePic}" class="w-12 h-12 rounded-full shrink-0 object-cover border border-gray-200">`
                        : `<div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center font-bold text-green-700 text-xl shrink-0">${escapeHTML(info.name).charAt(0)}</div>`; 

                    // Updated HTML Structure for Fixed Layout
                    return `
                    <div onclick="startChat('${peerUid}', '${escapeHTML(info.name)}')" class="p-4 border-b bg-white hover:bg-gray-50 cursor-pointer flex items-center gap-3">
                        ${av}
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-0.5">
                                <h4 class="font-bold text-gray-800 text-base truncate pr-2">${escapeHTML(info.name)}</h4>
                                <span class="text-[10px] text-gray-400 shrink-0 whitespace-nowrap">${timeAgo(info.timestamp)}</span>
                            </div>
                            <p class="text-sm text-gray-500 truncate block">${escapeHTML(displayMsg)}</p>
                        </div>
                    </div>`; 
                }).join('');
            } else {
                container.innerHTML = '<p class="text-center text-gray-400 mt-10 text-sm">‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡¶∏‡ßá‡¶∂‡¶® ‡¶®‡ßá‡¶á</p>'; 
            }
        }); 
    }

    function renderPeopleList(users, isSearch) { 
        const div = document.getElementById('users-list'); 
        let html = isSearch ? `<p class="text-xs font-bold text-green-600 mb-2">Search Results (${users.length})</p>` : '';
        
        if (users.length === 0 && !isSearch) {
             div.innerHTML = '<p class="text-center text-gray-400 text-sm">‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡ßá‡¶á</p>';
             return;
        }

        html += users.map(u => { 
            const badge = checkUserBadge(u); 
            let avatar = `<div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-xl border border-blue-200">${u.name?escapeHTML(u.name).charAt(0):'U'}</div>`; 
            if(u.profile_pic) avatar = `<img src="${u.profile_pic}" class="w-12 h-12 rounded-full object-cover border border-gray-100 shadow-sm">`; 
            return `<div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-row items-center justify-between gap-3"><div class="flex items-center gap-3 flex-1 min-w-0 cursor-pointer" onclick="openUserProfile('${u.uid}')">${avatar}<div class="min-w-0"><h4 class="font-bold text-gray-900 text-base truncate">${escapeHTML(u.name)}${badge}</h4><p class="text-xs text-gray-500 truncate">${escapeHTML(u.profession) || '‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø'}</p></div></div><div class="shrink-0"><button id="btn-req-${u.uid}" onclick="toggleFriendRequest('${u.uid}')" class="bg-blue-600 text-white px-4 py-1.5 rounded-lg font-bold text-xs hover:bg-blue-700 transition shadow-sm active:scale-95 flex items-center gap-1"><i class="fa-solid fa-user-plus"></i> Add</button></div></div>`; 
        }).join('');
        div.innerHTML = html; 
        users.forEach(u => checkRequestStatus(u.uid));
    }
    
    // --- UPDATED SUBMIT POST ---
    window.submitPost = async () => {
        const text = document.getElementById('post-text').value.trim();
        const files = window.selectedImages;
        const bgColor = document.getElementById('selected-post-color').value;
        const privacy = document.getElementById('post-privacy').value;
        const mobile = document.getElementById('post-mobile').value.trim();
        const socialLink = document.getElementById('post-social-link').value.trim();
        
        if(!text && files.length === 0 && !window.selectedFeeling) return showToast("‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶õ‡¶¨‡¶ø ‡¶¶‡¶ø‡¶®!", 'error');
        
        const hasLink = (text.match(/https?:\/\//g) || []).length > 0;
        if (hasLink) {
             const todayStr = new Date().toDateString(); 
             const linkCountKey = 'daily_link_count_' + todayStr;
             let count = parseInt(localStorage.getItem(linkCountKey) || '0');
             if (count >= 5) return showToast("‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡ß´‡¶ü‡¶ø‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ", "error");
             localStorage.setItem(linkCountKey, count + 1);
        }

        const btn = document.getElementById('btn-post-submit'); 
        const originalBtnText = btn.innerHTML; 
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; 
        btn.disabled = true;
        
        try {
            let mediaUrls = [];
            
            if (files.length > 0) {
                const uploadPromises = files.map(file => uploadMediaToCloudinary(file));
                const results = await Promise.all(uploadPromises);
                mediaUrls = results.map(res => res.url);
            }

            const newPostData = { 
                uid: window.currentUser.uid, 
                author: userDetails.name || "Unknown", 
                authorPic: userDetails.profile_pic || null, 
                content: text, 
                images: mediaUrls, // Updated to store array
                image: mediaUrls[0] || "", // For backward compatibility
                type: 'text', 
                timestamp: Date.now(), 
                likes: {}, 
                comments: {}, 
                repostCount: 0, 
                bgColor: bgColor, 
                privacy: privacy, 
                union: userDetails.union || '', 
                village: userDetails.village || '', 
                authorRole: userDetails.role || 'user', 
                authorVerified: !!(userDetails.isVerified), 
                mobile: mobile || null, 
                socialLink: socialLink || null,
                adminScore: 0,
                taggedFriends: window.taggedUsers,
                feeling: window.selectedFeeling
            };
            
            await push(ref(db, 'posts'), newPostData);
            
            // Reset fields
            document.getElementById('post-text').value = ""; 
            document.getElementById('post-mobile').value = ""; 
            document.getElementById('post-social-link').value = ""; 
            selectPostColor(''); 
            removePostImage(); 
            window.selectedImages = [];
            window.taggedUsers = [];
            window.selectedFeeling = null;
            togglePostModal(false); 
            showToast("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            
            if(privacy !== 'only_me') notifyFriends(newPostData.uid, userDetails.name);
            
            // Re-load feed instead of simple prepend to allow algorithm to work
            loadFeed(currentFeedFilter, true);

        } catch (error) { 
            console.error(error); 
            showToast("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message, 'error'); 
        } finally { 
            btn.innerHTML = originalBtnText; 
            btn.disabled = false; 
        }
    };
    
    window.repost = (postId) => { 
        const card = document.getElementById(`post-card-${postId}`);
        const textElem = card.querySelector('.post-text-content') || card.querySelector('h4'); 
        const text = textElem ? textElem.innerText : "";
        runTransaction(ref(db, `posts/${postId}/repostCount`), (c) => (c || 0) + 1); 
        togglePostModal(true); document.getElementById('post-text').value = `[‡¶∞‡¶ø‡¶™‡ßã‡¶∏‡ßç‡¶ü] ${text}\n\n`; 
    };

    window.toggleLike = (postId) => { const btns = document.querySelectorAll(`[id^="like-btn-${postId}"]`), icons = document.querySelectorAll(`[id^="like-icon-${postId}"]`), countSpans = document.querySelectorAll(`[id^="like-cnt-${postId}"]`); if(icons.length === 0) return; const isLiked = icons[0].classList.contains('fa-solid'); let newCount = parseInt(countSpans[0].innerText) + (isLiked ? -1 : 1); icons.forEach(i => i.classList[isLiked ? 'remove' : 'add']('fa-solid', 'text-green-600') || i.classList[isLiked ? 'add' : 'remove']('fa-regular')); countSpans.forEach(s => s.innerText = Math.max(0, newCount)); const likeRef = ref(db, `posts/${postId}/likes/${window.currentUser.uid}`); get(likeRef).then((snap) => { if (snap.exists()) set(likeRef, null); else { set(likeRef, true); get(ref(db, `posts/${postId}`)).then(postSnap => { const post = postSnap.val(); if(post && post.uid !== window.currentUser.uid) push(ref(db, `notifications/${post.uid}`), { type: 'like', fromUid: window.currentUser.uid, fromName: userDetails.name, postId: postId, timestamp: Date.now(), read: false }); }); } }); };
    
    // --- UPDATED PROFILE POST LOAD (Fetch All + Client Side Pagination) ---
    window.loadProfilePosts = (targetUid, containerId) => { 
        const feedDiv = document.getElementById(containerId); 
        feedDiv.innerHTML = '<div class="flex justify-center py-6"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div></div>'; 
        
        currentProfileViewMode = containerId; // Store which container
        currentProfileRenderCount = 0;
        profilePostsFullList = [];

        // Query SPECIFICALLY for this user's posts using orderByChild
        const q = query(ref(db, 'posts'), orderByChild('uid'), equalTo(targetUid));
        
        get(q).then(snap => { 
            const data = snap.val() || {};
            // Convert to array and sort by time descending
            profilePostsFullList = Object.entries(data)
                .map(([id, post]) => ({ id, ...post }))
                .sort((a,b)=>b.timestamp-a.timestamp);
                
            feedDiv.innerHTML = ''; // Clear loader
            
            if (profilePostsFullList.length === 0) {
                 feedDiv.innerHTML = '<p class="text-center text-gray-400 py-10">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</p>';
            } else {
                renderProfileChunk(); // Render first batch
            }
        }).catch(e => {
            console.error("Profile Post Load Error:", e);
            feedDiv.innerHTML = '<p class="text-center text-red-400 py-10">‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ</p>';
        }); 
    }

    // New Function to Render Chunks of Profile Posts
    window.renderProfileChunk = () => {
        if(isProfileRendering || currentProfileRenderCount >= profilePostsFullList.length) return;
        isProfileRendering = true;

        const container = document.getElementById(currentProfileViewMode);
        const batchSize = 5;
        const nextBatch = profilePostsFullList.slice(currentProfileRenderCount, currentProfileRenderCount + batchSize);
        
        let html = '';
        nextBatch.forEach(post => {
            html += createPostHTML(post, post.id);
        });

        container.insertAdjacentHTML('beforeend', html);
        currentProfileRenderCount += batchSize;
        isProfileRendering = false;
    }
    
    window.filterFeed = (type) => {
        currentFeedFilter = type;
        ['all', 'union', 'village'].forEach(t => document.getElementById(`tab-feed-${t}`).classList.toggle('active', type === t));
        loadFeed(type, true); 
    }
    
    window.refreshFeed = () => {
        const spinner = document.getElementById('loader-spinner');
        spinner.classList.remove('hidden'); 
        loadFeed(currentFeedFilter, true); 
        setTimeout(() => spinner.classList.add('hidden'), 1000);
    };

    function setupInfiniteScroll() {
        if (feedObserver) { feedObserver.disconnect(); }
        const sentinel = document.getElementById('scroll-sentinel');
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isFeedLoading && hasMorePosts) {
                loadFeed(currentFeedFilter, false);
            }
        }, { rootMargin: '200px' });
        feedObserver = observer;
        feedObserver.observe(sentinel);
    }
    
    window.loadMorePosts = () => {
        if(!isFeedLoading && hasMorePosts) {
            loadFeed(currentFeedFilter, false);
        }
    }

    // --- REFACTORED LOAD FEED (ALGORITHMIC + ADS) ---
    window.loadFeed = (type, isInitial = false) => {
        if (isFeedLoading) return;
        isFeedLoading = true;
        
        const feedDiv = document.getElementById('news-feed');
        const loaderArea = document.getElementById('feed-loader-area');
        const btnLoadMore = document.getElementById('btn-load-more');
        const spinner = document.getElementById('loader-spinner');
        
        loaderArea.classList.remove('hidden');
        spinner.classList.remove('hidden');
        btnLoadMore.classList.add('hidden');

        if (isInitial) {
            lastLoadedPostKey = null;
            hasMorePosts = true;
            feedDiv.innerHTML = '<div class="flex flex-col gap-3 p-4"><div class="h-40 w-full skeleton"></div><div class="h-40 w-full skeleton"></div></div>';
        }

        const pageSize = 15;
        let postsQuery;

        // Fetching Strategy: Use Timestamp for pagination to get a "batch", then sorting that batch by algorithm.
        if (type === 'union' && userDetails.union) {
            if (isInitial) {
                postsQuery = query(ref(db, 'posts'), orderByChild('union'), equalTo(userDetails.union), limitToLast(pageSize));
            } else {
                 hasMorePosts = false; postsQuery = null;
            }
        } else if (type === 'village' && userDetails.village) {
             if (isInitial) {
                postsQuery = query(ref(db, 'posts'), orderByChild('village'), equalTo(userDetails.village), limitToLast(pageSize));
            } else {
                hasMorePosts = false; postsQuery = null;
            }
        } else {
            // ALL (Default)
            if (isInitial) {
                postsQuery = query(ref(db, 'posts'), orderByKey(), limitToLast(pageSize));
            } else {
                postsQuery = query(ref(db, 'posts'), orderByKey(), endAt(lastLoadedPostKey), limitToLast(pageSize + 1));
            }
        }
        
        if (!postsQuery && !isInitial) {
             isFeedLoading = false;
             loaderArea.classList.add('hidden');
             return;
        }

        get(postsQuery).then((snapshot) => {
            const data = snapshot.val();
            
            if (isInitial) feedDiv.innerHTML = '';
            
            if (!data) {
                if (isInitial) feedDiv.innerHTML = '<div class="p-10 text-center text-gray-400">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</div>';
                hasMorePosts = false;
                loaderArea.classList.add('hidden');
            } else {
                let postsArr = Object.entries(data).map(([key, val]) => ({ id: key, ...val }));
                
                // Pagination Logic (Database Key based)
                // First, sort by Key (Time) strictly to find the next cursor
                postsArr.sort((a, b) => {
                   if(a.id < b.id) return -1;
                   if(a.id > b.id) return 1;
                   return 0;
                });

                if (!isInitial) {
                    // Remove the overlapping key (lastLoadedPostKey)
                    postsArr = postsArr.filter(p => p.id !== lastLoadedPostKey);
                }

                if (postsArr.length === 0) {
                    hasMorePosts = false;
                } else {
                    lastLoadedPostKey = postsArr[0].id; // For limitToLast, the first item is the oldest in batch
                    if (postsArr.length < pageSize && !isInitial) {
                         hasMorePosts = false;
                    }
                }

                // --- ALGORITHM START ---
                // Calculate Score for each post
                postsArr.forEach(post => {
                    post.algorithmicScore = calculatePostScore(post);
                });

                // Sort by Calculated Score (Descending)
                postsArr.sort((a, b) => b.algorithmicScore - a.algorithmicScore);
                // --- ALGORITHM END ---

                // Generate HTML with Ad Injection
                let finalHtml = '';
                postsArr.forEach((post, index) => {
                    finalHtml += createPostHTML(post, post.id);

                    // Inject Ad after every 5th post in this batch
                    // Logic: (index + 1) % 5 === 0
                    if ((index + 1) % 5 === 0 && allAds.length > 0) {
                        const adIndex = Math.floor((index + 1) / 5) % allAds.length;
                        finalHtml += createAdHTML(allAds[adIndex]);
                    }
                });

                feedDiv.insertAdjacentHTML('beforeend', finalHtml);
                
                if(hasMorePosts) {
                    spinner.classList.add('hidden');
                    btnLoadMore.classList.remove('hidden'); 
                } else {
                    loaderArea.classList.add('hidden');
                }
            }
            isFeedLoading = false;
        }).catch(err => {
            console.error("Feed Error:", err);
            isFeedLoading = false;
            spinner.classList.add('hidden');
            btnLoadMore.classList.remove('hidden');
            btnLoadMore.innerText = "‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®";
        });
    }

    // --- END PAGINATION ---

    function loadDynamicSidebar() { 
        onValue(ref(db, 'admin_settings/links'), (snap) => { const links = snap.val() || {}; if(links.help) document.getElementById('sidebar-help').onclick = () => { window.location.href = links.help; toggleSidebar(false); }; }); 
        
        // Load Privacy Policy Link for Registration Form
        onValue(ref(db, 'admin_settings/privacy_link'), (snap) => {
            const link = snap.val();
            if(link) {
                document.getElementById('reg-privacy-link').href = link;
            }
        });
    }
    
    window.loadVillagesForUnion = (unionName, targetId) => { 
        const select = document.getElementById(targetId); select.innerHTML = '<option value="">‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...</option>'; select.disabled = true; 
        if(!unionName) { select.innerHTML = '<option value="">‡¶Ü‡¶ó‡ßá ‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>'; return; } 
        get(ref(db, `locations/${unionName}`)).then((snapshot) => { 
            const local = snapshot.exists() ? Object.values(snapshot.val()) : (APP_CONFIG.locations[unionName] || []); 
            select.innerHTML = local.length ? '<option value="">‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ/‡¶Æ‡¶π‡¶≤‡ßç‡¶≤‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>' + local.sort().map(v => `<option value="${v}">${v}</option>`).join('') : '<option value="">‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</option>';
            select.disabled = !local.length;
        }); 
    }

    window.openDynamicCategory = (catId, title) => { 
        switchPage('dynamic-content'); document.getElementById('dynamic-content-title').innerText = title; 
        const container = document.getElementById('dynamic-items-container'); 
        container.innerHTML = '<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>'; 
        get(ref(db, `services/data/${catId}`)).then((snap) => { 
            const items = snap.val() || {};
            container.innerHTML = Object.keys(items).length > 0 ? Object.values(items).map(item => {
                const imgHtml = item.image ? `<div class="h-32 bg-gray-200 rounded-t-xl overflow-hidden"><img src="${item.image}" class="w-full h-full object-cover"></div>` : ''; 
                const actionBtn = item.phone ? `<a href="tel:${item.phone}" class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center shadow hover:bg-green-600 transition"><i class="fa-solid fa-phone"></i></a>` : ''; 
                return `<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-3">${imgHtml}<div class="p-4 flex justify-between items-center"><div><h3 class="font-bold text-gray-800 text-lg">${escapeHTML(item.title)}</h3><p class="text-sm text-gray-500 mt-1">${escapeHTML(item.details || '')}</p></div>${actionBtn}</div></div>`;
            }).join('') : `<div class="text-center py-10"><i class="fa-regular fa-folder-open text-4xl text-gray-300 mb-3"></i><p class="text-gray-400">‡¶§‡¶•‡ßç‡¶Ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø</p></div>`;
        }); 
    }

    function loadSettingsData() { const s = userDetails.settings || {}; document.getElementById('toggle-blood-alert').checked = s.bloodAlert !== false; document.getElementById('toggle-market-alert').checked = s.marketAlert !== false; }
    window.updateSettings = (key, value) => update(ref(db, `users/${window.currentUser.uid}/settings/${key}`), value).then(()=> showToast("‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá"));
    
    // --- OPTIMIZED SUGGESTIONS ---
    async function loadUserSuggestions(isRefresh = false) { 
        if(isRefresh) document.getElementById('users-list').innerHTML = '<p class="text-center text-gray-400 text-sm">‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';
        try {
            const snap = await get(query(ref(db, 'users'), limitToLast(30)));
            let users = Object.values(snap.val() || {}).filter(u => u.uid !== window.currentUser.uid); 
            users = users.filter(u => !myFriends.includes(u.uid));

            const filteredUsers = [];
            await Promise.all(users.map(async (u) => {
                const s = await get(ref(db, `friend_requests/${u.uid}/${window.currentUser.uid}`));
                const r = await get(ref(db, `friend_requests/${window.currentUser.uid}/${u.uid}`));
                if(!s.exists() && !r.exists()) filteredUsers.push(u);
            }));
            allUsers = filteredUsers; 
            updatePeopleTab(); 
            if(!document.getElementById('search-people').value) {
                 renderPeopleList(allUsers, false);
            }
        } catch (e) { console.error("Suggestion Error", e); }
    }
    
    window.refreshPeople = () => { loadUserSuggestions(true); };

    function updateUIWithUserData() { 
        const badge = checkUserBadge(userDetails), displayName = (userDetails.name || "‡¶Ö‡¶ú‡ßç‡¶û‡¶æ‡¶§") + (userDetails.nickname ? ` (${userDetails.nickname})` : ""); 
        let avatarHtml = userDetails.profile_pic ? `<img src="${userDetails.profile_pic}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-user"></i>`; 
        ['sidebar-avatar-container', 'profile-avatar-container'].forEach(id => document.getElementById(id).innerHTML = avatarHtml);
        document.getElementById('my-comment-avatar-full').innerHTML = userDetails.profile_pic ? `<img src="${userDetails.profile_pic}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-user text-gray-400"></i>`;
        document.getElementById('sidebar-name').innerHTML = document.getElementById('profile-name').innerHTML = displayName + badge; 
        document.getElementById('sidebar-village').innerText = document.getElementById('profile-village-text').innerText = userDetails.village || "‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á";
        document.getElementById('profile-union-badge').innerText = userDetails.union || "‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶®‡ßá‡¶á"; document.getElementById('profile-bio').innerText = userDetails.bio || "‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...";
        document.getElementById('profile-profession').innerText = userDetails.profession || "‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á"; document.getElementById('profile-location').innerText = userDetails.location || "‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á";
        document.getElementById('profile-phone').innerHTML = `${userDetails.phone || "‡¶´‡ßã‡¶® ‡¶®‡ßá‡¶á"}`; document.getElementById('profile-email').innerHTML = `${userDetails.email}`;
        ['edit-name', 'edit-nickname', 'edit-profession', 'edit-location', 'edit-union', 'edit-village', 'edit-bio', 'donor-phone'].forEach(id => document.getElementById(id).value = userDetails[id.replace('edit-', '').replace('donor-', '')] || "");
        
        if(userDetails.cover_pic) {
            const coverImg = document.getElementById('profile-cover-img'); coverImg.src = userDetails.cover_pic; coverImg.classList.remove('hidden');
        }
        const tabVillage = document.getElementById('tab-feed-village'); if (userDetails.village) { tabVillage.style.display = 'block'; tabVillage.innerText = userDetails.village; } else { tabVillage.style.display = 'none'; if(currentFeedFilter === 'village') filterFeed('all'); } 
    }

    // --- COVER PHOTO UPLOAD ---
    window.handleCoverPhotoUpload = async (input) => {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            showToast("‡¶ï‡¶≠‡¶æ‡¶∞ ‡¶´‡¶ü‡ßã ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...", "success");
            try {
                const res = await uploadMediaToCloudinary(file);
                await update(ref(db, 'users/' + window.currentUser.uid), { cover_pic: res.url });
                showToast("‡¶ï‡¶≠‡¶æ‡¶∞ ‡¶´‡¶ü‡ßã ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                const coverImg = document.getElementById('profile-cover-img'); coverImg.src = res.url; coverImg.classList.remove('hidden');
            } catch(e) { showToast("‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + e.message, "error"); }
        }
    }

    window.saveProfileChanges = async () => { 
        const name = document.getElementById('edit-name').value.trim(), file = document.getElementById('edit-profile-img').files[0]; 
        if(!name) return showToast("‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï", 'error'); 
        const btn = document.getElementById('btn-save-profile'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; btn.disabled = true; 
        try { 
            let profilePicUrl = userDetails.profile_pic || null; 
            if (file) { const res = await uploadMediaToCloudinary(file); profilePicUrl = res.url; }
            await update(ref(db, 'users/' + window.currentUser.uid), { name, nickname: document.getElementById('edit-nickname').value.trim(), profession: document.getElementById('edit-profession').value.trim(), location: document.getElementById('edit-location').value.trim(), bio: document.getElementById('edit-bio').value.trim(), profile_pic: profilePicUrl }); 
            showToast("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); toggleEditProfile(false); document.getElementById('edit-profile-img').value = ""; 
        } catch (e) { showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + e.message, 'error'); } finally { btn.innerText = "‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®"; btn.disabled = false; } 
    };
    
    window.previewRegImage = (input) => {
        if(input.files && input.files[0]) {
            const r = new FileReader(); r.onload = (e) => { document.getElementById('reg-img-preview').src = e.target.result; document.getElementById('reg-img-preview').classList.remove('hidden'); document.getElementById('reg-img-placeholder').classList.add('hidden'); }; r.readAsDataURL(input.files[0]);
        }
    }

    window.handleRegister = async () => { 
        const name = document.getElementById('reg-name').value.trim(), email = document.getElementById('reg-email').value.trim(), phone = document.getElementById('reg-phone').value.trim(), pass = document.getElementById('reg-pass').value, union = document.getElementById('reg-union').value, village = document.getElementById('reg-village').value;
        const file = document.getElementById('reg-profile-pic').files[0];
        const isPolicyChecked = document.getElementById('reg-privacy-agree').checked;
        
        if (!isPolicyChecked) return showToast("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡ßü‡¶§‡¶æ ‡¶ì ‡¶®‡ßÄ‡¶§‡¶ø‡¶Æ‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶è‡¶ï‡¶Æ‡¶§ ‡¶π‡ßã‡¶®", "error");

        const nameRegex = /^[a-zA-Z\u0980-\u09FF\s]+$/;
        if(!name || !email || !phone || !pass || !union || !village) return showToast("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®!", 'error'); 
        if(!nameRegex.test(name)) return showToast("‡¶®‡¶æ‡¶Æ‡ßá ‡¶á‡¶Æ‡ßã‡¶ú‡¶ø ‡¶¨‡¶æ ‡¶∏‡¶ø‡¶Æ‡ßç‡¶¨‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ", 'error');
        if(name.length > 20) return showToast("‡¶®‡¶æ‡¶Æ ‡ß®‡ß¶ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ", 'error');
        if(!/^01[3-9]\d{8}$/.test(phone)) return showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®", 'error');
        
        const btn = document.getElementById('btn-reg-action'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...'; btn.disabled = true;
        try {
            let profilePicUrl = "";
            if(file) { const res = await uploadMediaToCloudinary(file); profilePicUrl = res.url; }
            const cred = await createUserWithEmailAndPassword(auth, email, pass);
            await set(ref(db, 'users/' + cred.user.uid), { name, email, phone, union, village, role: 'user', uid: cred.user.uid, joinDate: new Date().toLocaleDateString(), isVerified: false, profile_pic: profilePicUrl });
        } catch (e) { showToast(e.message, 'error'); btn.innerText = "‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®"; btn.disabled = false; }
    };
    
    window.handleLogin = () => { 
        if (!navigator.onLine) { showToast("‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶®‡ßá‡¶á! ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", 'error'); return; }
        const btn = document.getElementById('btn-login-action'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; btn.disabled = true; 
        signInWithEmailAndPassword(auth, document.getElementById('login-email').value.trim(), document.getElementById('login-pass').value).catch((e) => { showToast("‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°", 'error'); btn.innerText = "‡¶≤‡¶ó‡¶á‡¶®"; btn.disabled = false; }); 
    };

    window.handleForgotPass = () => { const email = document.getElementById('forgot-email').value.trim(); if(!email) return showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡¶®", 'error'); const btn = document.getElementById('btn-forgot-action'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; btn.disabled = true; sendPasswordResetEmail(auth, email).then(() => { showToast("‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); btn.innerText = "‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®"; btn.disabled = false; toggleAuth('login'); }).catch((e) => { showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + e.message, 'error'); btn.disabled = false; }); };
    window.handleLogout = () => { if(confirm("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) signOut(auth); };
    
    window.selectPostColor = (color) => { const ta = document.getElementById('post-text'); document.getElementById('selected-post-color').value = color; document.querySelectorAll('.post-color-dot').forEach(el => el.classList.remove('selected')); if(event) event.target.classList.add('selected'); ta.style.background = color; ta.style.color = color ? 'white' : 'black'; ta.style.fontWeight = color ? 'bold' : 'normal'; ta.style.textAlign = color ? 'center' : 'left'; ta.style.fontSize = color ? '20px' : '18px'; ta.style.paddingTop = color ? '40px' : '0px'; };
    
    // Updated Preview Image Logic for Multiple Selection
    window.previewPostImage = (input) => { 
        const previewGrid = document.getElementById('preview-grid');
        const imgArea = document.getElementById('image-preview-area');
        
        // Reset color if image is selected
        selectPostColor(''); 
        document.getElementById('color-picker-wrapper').style.display = 'none';

        if(input.files && input.files.length > 0) {
            window.selectedImages = Array.from(input.files).slice(0, 2); // Limit to 2
            
            // Generate Preview
            let html = '';
            const count = window.selectedImages.length;
            const gridClass = count === 1 ? 'post-images-grid-1' : 'post-images-grid-2';
            
            previewGrid.className = gridClass;
            previewGrid.innerHTML = '';

            window.selectedImages.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const r = new FileReader(); 
                    r.onload = (e) => { 
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'w-full h-full object-cover';
                        previewGrid.appendChild(img);
                    }; 
                    r.readAsDataURL(file); 
                }
            });
            imgArea.classList.remove('hidden');
        } 
    }

    window.removePostImage = () => { 
        document.getElementById('post-image-file').value = ""; 
        document.getElementById('image-preview-area').classList.add('hidden'); 
        document.getElementById('preview-grid').innerHTML = ""; 
        window.selectedImages = [];
        // Restore color picker
        document.getElementById('color-picker-wrapper').style.display = 'block';
    }
    
    // Check Post Conditions (Text Length)
    document.getElementById('post-text').addEventListener('input', function() {
        const text = this.value;
        const words = text.trim().split(/\s+/).length;
        const colorWrapper = document.getElementById('color-picker-wrapper');
        
        if (words > 40 || window.selectedImages.length > 0) {
            selectPostColor('');
            colorWrapper.style.display = 'none';
        } else {
            colorWrapper.style.display = 'block';
        }
    });

    window.submitPoll = () => { 
        const q = document.getElementById('poll-question').value.trim(), o1 = document.getElementById('poll-opt-1').value.trim(), o2 = document.getElementById('poll-opt-2').value.trim();
        if(!q || !o1 || !o2) return showToast("‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶¶‡¶ø‡¶®", 'error');
        const options = [{text: o1, votes: 0}, {text: o2, votes: 0}, document.getElementById('poll-opt-3').value.trim() ? {text: document.getElementById('poll-opt-3').value.trim(), votes: 0} : null, document.getElementById('poll-opt-4').value.trim() ? {text: document.getElementById('poll-opt-4').value.trim(), votes: 0} : null].filter(Boolean);
        push(ref(db, 'posts'), { uid: window.currentUser.uid, author: userDetails.name, authorPic: userDetails.profile_pic || null, content: q, type: 'poll', options, timestamp: Date.now(), likes: {}, comments: {}, repostCount: 0, privacy: 'public', union: userDetails.union || '', village: userDetails.village || '', authorRole: userDetails.role || 'user', authorVerified: !!(userDetails.isVerified) }).then((snap) => { document.getElementById('poll-question').value = ""; document.getElementById('poll-opt-1').value = ""; document.getElementById('poll-opt-2').value = ""; togglePollModal(false); showToast("‡¶™‡ßã‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); notifyFriends(snap.key, userDetails.name); }); 
    };

    function notifyFriends(postId, name) { get(ref(db, `users/${window.currentUser.uid}/friends`)).then((snap) => { if(snap.exists()) snap.forEach((f) => push(ref(db, `notifications/${f.key}`), { type: 'new_post', fromUid: window.currentUser.uid, fromName: name, postId, timestamp: Date.now(), read: false })); }); }
    window.votePoll = (postId, optionIdx) => { const voteRef = ref(db, `posts/${postId}/voters/${window.currentUser.uid}`); get(voteRef).then(snap => { if(snap.exists()) return showToast("‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶≠‡ßã‡¶ü ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®", 'error'); runTransaction(ref(db, `posts/${postId}/options/${optionIdx}/votes`), (v) => (v || 0) + 1).then(() => { set(voteRef, optionIdx); showToast("‡¶≠‡ßã‡¶ü ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); }); }); };
    window.toggleReadMore = (id) => { const m = document.getElementById(`more-${id}`), b = event.target; m.classList.toggle('hidden'); b.innerText = m.classList.contains('hidden') ? '‡¶Ü‡¶∞‡ßã ‡¶™‡ßú‡ßÅ‡¶®' : '‡¶Ü‡ßú‡¶æ‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®'; };
    window.reportPost = (postId) => confirm("‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?") && push(ref(db, 'reports'), { postId, reporter: window.currentUser.uid, timestamp: Date.now() }).then(()=>showToast("‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá"));
    window.openEditPostModal = (postId) => { document.getElementById('edit-post-id').value = postId; document.getElementById('edit-post-text').value = document.querySelector(`#post-card-${postId} .post-text-content`)?.innerText || ""; document.getElementById('edit-post-modal').classList.remove('hidden-custom'); };
        window.submitEditPost = () => update(ref(db, `posts/${document.getElementById('edit-post-id').value}`), { content: document.getElementById('edit-post-text').value }).then(() => { showToast("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá"); document.getElementById('edit-post-modal').classList.add('hidden-custom'); });

    window.openFullCommentModal = (postId) => { currentFullPostId = postId; document.getElementById('comment-full-modal').classList.remove('hidden-custom'); setTimeout(() => document.getElementById('comment-full-modal').classList.add('open'), 10); history.pushState({ page: 'comment-modal', postId }, "", "#comments"); loadFullComments(postId); };
    window.closeFullCommentModal = () => { document.getElementById('comment-full-modal').classList.remove('open'); setTimeout(() => { document.getElementById('comment-full-modal').classList.add('hidden-custom'); currentFullPostId = null; }, 300); };
    window.submitFullComment = () => submitCommentLogic(currentFullPostId, document.getElementById('full-comment-input'));
    window.submitInlineComment = (postId) => submitCommentLogic(postId, document.getElementById(`inline-comment-input-${postId}`));
    
    function submitCommentLogic(postId, input) {
        const text = input.value.trim(); if(!text || !postId) return;
        push(ref(db, `posts/${postId}/comments`), { author: userDetails.name, authorUid: window.currentUser.uid, authorPic: userDetails.profile_pic || null, text, time: Date.now() }).then(() => { input.value = ""; get(ref(db, `posts/${postId}`)).then(s => { const p = s.val(); if(p && p.uid !== window.currentUser.uid) push(ref(db, `notifications/${p.uid}`), { type: 'comment', fromUid: window.currentUser.uid, fromName: userDetails.name, postId, timestamp: Date.now(), read: false }); }); });
    }

    function loadFullComments(postId) { 
        const container = document.getElementById('full-comments-list'); container.innerHTML = '<div class="flex justify-center p-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div></div>'; 
        onValue(ref(db, `posts/${postId}/comments`), (snap) => { 
            if(currentFullPostId !== postId) return; const comments = snap.val() || {}; 
            document.getElementById('full-comment-count').innerText = Object.keys(comments).length; 
            container.innerHTML = Object.keys(comments).length > 0 ? Object.entries(comments).sort((a,b)=>a[1].time - b[1].time).map(([cId, c]) => { 
                const delBtn = c.authorUid === window.currentUser.uid ? `<button onclick="deleteComment('${postId}','${cId}')" class="text-xs text-red-400 ml-2">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>` : ''; 
                const commentAvatar = c.authorPic ? `<img src="${c.authorPic}" class="w-8 h-8 rounded-full object-cover shrink-0 border border-gray-100">` : `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600 text-xs shrink-0">${escapeHTML(c.author).charAt(0)}</div>`; 
                return `<div class="flex gap-2 mb-3">${commentAvatar}<div class="bg-gray-100 rounded-2xl px-3 py-2 relative group max-w-[85%]"><h4 class="font-bold text-xs text-gray-800">${escapeHTML(c.author)}</h4><p class="text-sm text-gray-700 leading-snug">${escapeHTML(c.text)}</p><div class="flex gap-2 mt-1"><span class="text-[10px] text-gray-400">${timeAgo(c.time)}</span>${delBtn}</div></div></div>`; 
            }).join('') : '<p class="text-center text-gray-400 mt-10">‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á</p>'; 
            container.scrollTop = container.scrollHeight; 
        }); 
    }
    
    window.deleteComment = (postId, commentId) => confirm("‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?") && remove(ref(db, `posts/${postId}/comments/${commentId}`));
    window.togglePostMenu = (postId) => { const menu = document.getElementById(`post-menu-${postId}`); const isHidden = menu.classList.contains('hidden'); document.querySelectorAll('.post-menu-dropdown').forEach(el => el.classList.add('hidden')); if(isHidden) menu.classList.remove('hidden'); };
    window.hidePost = (postId) => document.getElementById(`post-card-${postId}`).style.display = 'none';
    
    window.deletePost = (postId) => { 
        if(confirm("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) {
            const card = document.getElementById(`post-card-${postId}`); if(card) card.style.opacity = '0.5';
            remove(ref(db, `posts/${postId}`)).then(() => { if(card) card.remove(); showToast("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); }).catch(e => { showToast("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡¶®‡¶ø: " + e.message, 'error'); if(card) card.style.opacity = '1'; });
        }
    };
    
    window.copyPostText = (id) => {
        const text = document.querySelector(`#post-card-${id} .post-text-content`)?.innerText || "";
        if(!text) return showToast("‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶®‡ßá‡¶á", "error");
        navigator.clipboard.writeText(text).then(() => showToast("‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá"));
    }

    // --- FULL SCREEN IMAGE VIEWER LOGIC ---
    window.openImageViewer = (src) => {
        document.getElementById('full-image-view').src = src;
        const modal = document.getElementById('image-viewer-modal');
        modal.classList.remove('hidden-custom');
        setTimeout(() => modal.classList.add('open'), 10);
    }

    window.closeImageViewer = () => {
        const modal = document.getElementById('image-viewer-modal');
        modal.classList.remove('open');
        setTimeout(() => {
            modal.classList.add('hidden-custom');
            document.getElementById('full-image-view').src = '';
        }, 300);
    }

    // --- POST HTML GENERATOR ---
    function createPostHTML(post, id) { 
        let privacyIcon = '<i class="fa-solid fa-earth-americas text-[10px] text-gray-400"></i>';
        if (post.privacy === 'only_me') { if (post.uid !== window.currentUser.uid) return ''; privacyIcon = '<i class="fa-solid fa-lock text-[10px] text-gray-400"></i>'; } 
        else if (post.privacy === 'friends' && post.uid !== window.currentUser.uid && !myFriends.includes(post.uid)) return ''; else if(post.privacy === 'friends') privacyIcon = '<i class="fa-solid fa-user-group text-[10px] text-gray-400"></i>';
        
        let displayStyle = "";
        let avatarHtml = post.authorPic ? `<img onclick="openUserProfile('${post.uid}')" src="${post.authorPic}" class="cursor-pointer w-10 h-10 rounded-full object-cover shadow-sm">` : `<div onclick="openUserProfile('${post.uid}')" class="cursor-pointer w-10 h-10 bg-green-100 rounded-full flex items-center justify-center font-bold text-green-700 shadow-sm text-lg">${post.author ? escapeHTML(post.author).charAt(0).toUpperCase() : 'U'}</div>`;
        let myInlineAvatar = userDetails.profile_pic ? `<img src="${userDetails.profile_pic}" class="w-9 h-9 rounded-full object-cover shrink-0 border border-gray-100">` : `<div class="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 shrink-0"><i class="fa-solid fa-user"></i></div>`;
        
        const isLiked = post.likes && post.likes[window.currentUser.uid], likeCount = post.likes ? Object.keys(post.likes).length : 0, commentCount = post.comments ? Object.keys(post.comments).length : 0;
                let badge = post.authorRole === 'journalist' ? `<i class="fa-solid fa-feather-pointed journalist-badge"></i>` : (post.authorVerified ? `<i class="fa-solid fa-circle-check verified-badge"></i>` : "");
        let locationTag = (post.union ? `<span class="bg-gray-100 text-[10px] px-2 py-0.5 rounded-full text-gray-500 ml-2">${post.union}</span>` : '') + (post.village ? `<span class="bg-green-50 text-[10px] px-2 py-0.5 rounded-full text-green-600 ml-1 border border-green-100">${post.village}</span>` : '');
        
        // --- Header Text Construction (Tagged + Feeling) ---
        let headerText = `<h4 onclick="openUserProfile('${post.uid}')" class="font-bold text-base text-gray-800 cursor-pointer hover:underline inline">${escapeHTML(post.author)}${badge}</h4>`;
        
        if (post.feeling) {
            headerText += ` <span class="text-gray-600 text-sm">is feeling ${post.feeling.emoji} ${escapeHTML(post.feeling.text)}</span>`;
        }
        
        if (post.taggedFriends && post.taggedFriends.length > 0) {
            headerText += ` <span class="text-gray-600 text-sm">with <span class="font-bold text-gray-800">${escapeHTML(post.taggedFriends[0].name)}</span>`;
            if (post.taggedFriends.length > 1) {
                headerText += ` and ${post.taggedFriends.length - 1} others`;
            }
            headerText += `</span>`;
        }

        let contentHTML = '';

        if(post.content) {
            if(post.bgColor && post.type === 'text') contentHTML = `<div class="colored-post-bg" style="background: ${post.bgColor};">${escapeHTML(post.content)}</div>`;
            else {
                const ytMatch = post.content.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                const driveMatch = post.content.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);

                let cleanText = escapeHTML(post.content);
                if (ytMatch) cleanText = cleanText.replace(ytMatch[0], '');
                if (driveMatch) cleanText = cleanText.replace(driveMatch[0], '[Drive Link]');

                if(cleanText.length > 150) cleanText = `<span>${cleanText.substring(0, 150)}...</span><span id="more-${id}" class="hidden">${cleanText.substring(150)}</span> <button onclick="toggleReadMore('${id}')" class="text-blue-600 text-xs font-bold">‡¶Ü‡¶∞‡ßã ‡¶™‡ßú‡ßÅ‡¶®</button>`;
                
                contentHTML = `<p class="post-text-content text-[15px] text-gray-800 mb-2 whitespace-pre-line leading-relaxed font-normal">${cleanText}</p>`;
                if (ytMatch) { contentHTML += `<div class="video-container ${post.content.includes("shorts")?'portrait':''} mb-3 shadow-sm"><iframe id="yt-${id}" class="yt-player" src="https://www.youtube.com/embed/${ytMatch[1]}?enablejsapi=1&rel=0" frameborder="0" allowfullscreen></iframe></div>`; }
                if (driveMatch) { const previewUrl = `https://drive.google.com/file/d/${driveMatch[1]}/preview`; contentHTML += `<div class="mb-3 shadow-sm rounded-lg overflow-hidden border border-gray-200"><iframe src="${previewUrl}" width="100%" height="250" style="border:0;" allow="autoplay"></iframe></div>`; }
            }
        }
        if(post.type === 'poll' && post.options) {
            let totalVotes = post.options.reduce((a,b) => a + (b.votes||0), 0);
            contentHTML = `<h4 class="font-bold text-gray-800 mb-2">${escapeHTML(post.content)}</h4><div class="space-y-2 mb-3">` + post.options.map((opt, idx) => {
                const percent = totalVotes === 0 ? 0 : Math.round((opt.votes || 0) / totalVotes * 100);
                return `<div onclick="votePoll('${id}', ${idx})" class="poll-option relative w-full border rounded-lg h-10 overflow-hidden cursor-pointer hover:bg-gray-50"><div class="poll-fill absolute top-0 left-0 h-full bg-blue-100 z-0" style="width: ${percent}%"></div><div class="absolute inset-0 flex justify-between items-center px-3 z-10 pointer-events-none"><span class="text-sm font-semibold text-gray-700">${escapeHTML(opt.text)}</span><span class="text-xs font-bold text-gray-500">${percent}%</span></div></div>`;
            }).join('') + `<p class="text-xs text-right text-gray-400 mt-1 font-bold">${totalVotes} ‡¶≠‡ßã‡¶ü</p></div>`;
        }

        // --- Image Rendering Logic (Multiple) ---
        let mediaHtml = '';
        const images = post.images || (post.image ? [post.image] : []);
        
        if (images.length > 0) {
            if (images.length === 1 && (post.mediaType === 'video' || images[0].endsWith('.mp4'))) {
                 mediaHtml = `<div class="mb-3 w-full bg-black rounded-lg overflow-hidden relative shadow-sm"><video src="${images[0]}" controls class="w-full h-auto max-h-[400px]" playsinline preload="metadata"></video></div>`;
            } else {
                 const gridClass = images.length === 1 ? 'post-images-grid-1' : 'post-images-grid-2';
                 // Add onclick to images for full screen view
                 const imgsHtml = images.map(img => `<img src="${img}" onclick="openImageViewer('${img}')" class="w-full h-full object-cover cursor-pointer">`).join('');
                 
                 mediaHtml = `<div class="mb-3 w-full bg-gray-200 rounded-lg overflow-hidden border border-gray-200 relative ${images.length === 1 ? 'min-h-[200px]' : ''} ${gridClass}">${imgsHtml}</div>`;
            }
        }

        let menuOptions = `<li onclick="copyPostText('${id}')" class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-600"><i class="fa-regular fa-copy w-5"></i> ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</li>`;
        if (post.uid === window.currentUser.uid) { menuOptions += `<li onclick="openEditPostModal('${id}')" class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-blue-600"><i class="fa-solid fa-pen w-5"></i> ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</li><li onclick="deletePost('${id}')" class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-red-600"><i class="fa-solid fa-trash w-5"></i> ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</li>`; } 
        else { menuOptions += `<li onclick="reportPost('${id}')" class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-yellow-600"><i class="fa-solid fa-triangle-exclamation w-5"></i> ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</li><li onclick="hidePost('${id}')" class="px-4 py-2 hover:bg-gray-100 cursor-pointer"><i class="fa-regular fa-eye-slash w-5"></i> ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</li>`; }

        let actionButtons = (post.mobile || post.socialLink) ? `<div class="grid grid-cols-2 gap-2 mt-3 mb-2">${post.mobile ? `<a href="tel:${post.mobile}" class="flex items-center justify-center gap-2 bg-green-50 text-green-700 py-2 rounded-lg font-bold text-sm hover:bg-green-100 transition border border-green-200"><i class="fa-solid fa-phone"></i> Call Now</a>` : '<div></div>'}${post.socialLink ? `<a href="${post.socialLink}" target="_blank" class="flex items-center justify-center gap-2 bg-blue-50 text-blue-700 py-2 rounded-lg font-bold text-sm hover:bg-blue-100 transition border border-blue-200"><i class="fa-brands fa-whatsapp"></i> Message</a>` : '<div></div>'}</div>` : '';

        return `<div id="post-card-${id}" class="bg-white p-4 rounded-xl shadow-sm mb-3 border border-gray-100 relative max-w-lg mx-auto ${post.authorRole === 'journalist' ? 'journalist-post' : ''}" style="${displayStyle}" data-union="${post.union||''}" data-village="${post.village||''}"><div class="flex items-center justify-between mb-2"><div class="flex items-center gap-3">${avatarHtml}<div>${headerText}<p class="text-[11px] text-gray-400 flex flex-wrap gap-1 items-center font-medium">${timeAgo(post.timestamp)} ${privacyIcon} ${locationTag}</p></div></div><div class="relative"><button onclick="togglePostMenu('${id}')" class="w-8 h-8 rounded-full hover:bg-gray-100 text-gray-500 flex items-center justify-center transition"><i class="fa-solid fa-ellipsis-vertical text-lg"></i></button><div id="post-menu-${id}" class="post-menu-dropdown hidden absolute right-0 top-8 w-48 bg-white shadow-xl rounded-lg z-20 border border-gray-100 py-1 text-sm text-gray-700"><ul>${menuOptions}</ul></div></div></div>${contentHTML}${mediaHtml}${actionButtons}<div class="grid grid-cols-3 border-t border-b border-gray-100 py-2 mt-2"><button id="like-btn-${id}" onclick="toggleLike('${id}')" class="flex items-center justify-center gap-2 hover:bg-gray-50 py-1.5 rounded transition text-gray-500"><i id="like-icon-${id}" class="${isLiked ? 'fa-solid text-green-600' : 'fa-regular'} fa-thumbs-up text-lg"></i> <span id="like-cnt-${id}" class="text-sm ${isLiked ? 'font-bold text-green-600' : ''}">${likeCount}</span></button><button onclick="openFullCommentModal('${id}')" class="flex items-center justify-center gap-2 hover:bg-gray-50 py-1.5 rounded transition text-gray-500"><i class="fa-regular fa-comment text-lg"></i> <span id="comment-cnt-${id}" class="text-sm">${commentCount}</span></button><button onclick="repost('${id}')" class="flex items-center justify-center gap-2 hover:bg-gray-50 py-1.5 rounded transition text-gray-500"><i class="fa-solid fa-share text-lg"></i> <span class="text-sm">${post.repostCount||0}</span></button></div><div class="mt-2"><div id="comments-preview-${id}">${post.comments ? Object.entries(post.comments).slice(-2).map(([_, c]) => `<div class="bg-gray-50 px-3 py-1.5 rounded-lg mt-1 text-xs border border-gray-100 truncate"><span class="font-bold text-gray-800 mr-1">${escapeHTML(c.author)}</span>${escapeHTML(c.text)}</div>`).join('') : ''}</div>${commentCount > 0 ? `<button onclick="openFullCommentModal('${id}')" class="text-xs text-green-600 font-bold mt-2 hover:underline w-full text-left">‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (${commentCount})</button>` : ''}<div class="mt-3 flex gap-2 items-center">${myInlineAvatar}<input type="text" id="inline-comment-input-${id}" onkeydown="handleEnter(event, 'comment', '${id}')" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶§‡¶æ‡¶Æ‡¶§..." class="flex-1 bg-gray-100 border-0 rounded-full px-4 py-2 text-sm focus:ring-1 focus:ring-green-500"><button onclick="submitInlineComment('${id}')" class="text-green-600 w-9 h-9 flex items-center justify-center bg-green-50 rounded-full hover:bg-green-100"><i class="fa-solid fa-paper-plane text-sm"></i></button></div></div></div>`;
    }

    // --- PEOPLE SEARCH & FILTER ---
    function updatePeopleTab() { 
        get(ref(db, `friend_requests/${window.currentUser.uid}`)).then(async (snap) => { 
            const reqDiv = document.getElementById('friend-requests-list'), requests = snap.val() || {}; 
            const count = Object.keys(requests).length;
            document.getElementById('nav-badge-people').innerText = count; document.getElementById('nav-badge-people').classList[count > 0 ? 'add' : 'remove']('active');
            document.getElementById('friend-requests-section').classList[count > 0 ? 'remove' : 'add']('hidden');
            if(count > 0) {
                const reqHTMLs = await Promise.all(Object.values(requests).map(async (r) => {
                    const uData = await getUserData(r.fromUid) || {};
                    let av = uData.profile_pic ? `<img src="${uData.profile_pic}" class="w-10 h-10 rounded-full object-cover">` : `<div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 font-bold">${uData.name ? uData.name.charAt(0) : 'U'}</div>`;
                    return `<div class="bg-white p-3 rounded-xl shadow-sm border border-yellow-100 flex justify-between items-center"><div class="flex items-center gap-3" onclick="openUserProfile('${r.fromUid}')">${av}<div><h4 class="font-bold text-gray-800 text-sm">${escapeHTML(r.fromName)}</h4></div></div><div class="flex gap-2"><button onclick="acceptRequest('${r.fromUid}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs">Confirm</button><button onclick="cancelRequest('${r.fromUid}', true)" class="bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs">Delete</button></div></div>`;
                }));
                reqDiv.innerHTML = reqHTMLs.join('');
            } else reqDiv.innerHTML = '';
        });
        
        const frPreviewDiv = document.getElementById('my-friends-preview-list');
        const friendsList = allUsers.filter(u => myFriends.includes(u.uid)).slice(0, 10);
        frPreviewDiv.innerHTML = friendsList.length > 0 ? friendsList.map(u => {
            let av = u.profile_pic ? `<img src="${u.profile_pic}" class="w-8 h-8 rounded-full object-cover">` : `<div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-green-600 font-bold text-xs">${escapeHTML(u.name).charAt(0)}</div>`;
            return `<div onclick="openUserProfile('${u.uid}')" class="bg-green-50 p-2 rounded-lg border border-green-100 flex items-center gap-2 cursor-pointer">${av}<span class="text-xs font-bold text-gray-700 truncate">${escapeHTML(u.name).split(' ')[0]}</span></div>`;
        }).join('') : '<p class="col-span-2 text-center text-gray-400 text-xs py-2">‡¶è‡¶ñ‡¶®‡ßã ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶®‡ßá‡¶á</p>';
    }

    // Debounced Search Handler for People
    window.debouncedPeopleSearch = debounce((q) => {
        q = q.trim(); const div = document.getElementById('users-list'); if(!q) { renderPeopleList(allUsers, false); return; }
        div.innerHTML = '<p class="text-center text-gray-400 mt-4">‡¶ñ‡ßÅ‡¶ú‡¶õ‡ßá...</p>';
        const usersRef = ref(db, 'users'); const qRef = query(usersRef, orderByChild('name'), startAt(q), endAt(q + "\uf8ff"), limitToFirst(20));
        get(qRef).then((snap) => {
            const results = []; snap.forEach((child) => { if(child.key !== window.currentUser.uid) results.push(child.val()); });
            if(results.length > 0) renderPeopleList(results, true); else div.innerHTML = '<p class="text-center text-gray-400 mt-4">‡¶ï‡¶æ‡¶â‡¶ï‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p>';
        });
    }, 500);

    window.toggleFriendRequest = (toUid) => { const btn = document.getElementById(`btn-req-${toUid}`); const isCancel = btn.innerText.includes('Cancel'); btn.disabled = true; btn.innerText = "..."; const refPath = isCancel ? `friend_requests/${toUid}/${window.currentUser.uid}` : `friend_requests/${toUid}/${window.currentUser.uid}`; const action = isCancel ? remove(ref(db, refPath)) : set(ref(db, refPath), { fromName: userDetails.name, fromUid: window.currentUser.uid, timestamp: Date.now() }); action.then(() => { showToast(isCancel ? "‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá" : "‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); btn.classList.toggle('bg-blue-600'); btn.classList.toggle('bg-gray-200'); btn.classList.toggle('text-white'); btn.classList.toggle('text-gray-600'); btn.innerHTML = isCancel ? '<i class="fa-solid fa-user-plus"></i> Add' : 'Cancel'; btn.disabled = false; }).catch(e => { showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + e.message, 'error'); btn.disabled = false; }); };
    window.checkRequestStatus = (targetUid) => get(ref(db, `friend_requests/${targetUid}/${window.currentUser.uid}`)).then(s => { const btn = document.getElementById(`btn-req-${targetUid}`); if(btn && s.exists()) { btn.classList.remove('bg-blue-600', 'text-white'); btn.classList.add('bg-gray-200', 'text-gray-600'); btn.innerHTML = 'Cancel'; } });
    window.unfriend = (uid) => confirm("‡¶Ü‡¶®‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?") && update(ref(db), { [`users/${window.currentUser.uid}/friends/${uid}`]: null, [`users/${uid}/friends/${window.currentUser.uid}`]: null }).then(() => { showToast("‡¶Ü‡¶®‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); if(currentChatUser?.uid === uid) closeChat(); get(ref(db, `users/${window.currentUser.uid}/friends`)).then(s => { myFriends = Object.keys(s.val()||{}); updatePeopleTab(); }); });

    async function loadQuickChatFriends() { 
        const div = document.getElementById('quick-chat-friends'); 
        if(myFriends.length === 0) { div.innerHTML = '<span class="text-xs text-gray-400">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶®‡ßá‡¶á</span>'; return; }
        const friendsData = await Promise.all(myFriends.slice(0, 15).map(uid => getUserData(uid)));
        div.innerHTML = friendsData.filter(u=>u).map(u => {
            let av = u.profile_pic ? `<div class="w-12 h-12 relative"><img src="${u.profile_pic}" class="w-full h-full rounded-full object-cover"><div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div></div>` : `<div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-700 font-bold text-lg relative">${escapeHTML(u.name).charAt(0)}<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div></div>`;
            return `<div onclick="startChat('${u.uid}', '${escapeHTML(u.name)}')" class="flex flex-col items-center cursor-pointer min-w-[50px]">${av}<span class="text-[10px] text-gray-600 mt-1 truncate w-14 text-center font-bold">${escapeHTML(u.name).split(' ')[0]}</span></div>`;
        }).join('');
    }

    // --- DIRECTORY ---
    window.openDirectoryCategory = (category, title) => { 
        switchPage('directory-list'); document.getElementById('directory-list-title').innerText = title; 
        const container = document.getElementById('directory-items-container'); 
        container.innerHTML = '<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>'; 
        onValue(ref(db, `directory/${category}`), (snap) => { 
            const data = snap.val() || {};
            container.innerHTML = Object.keys(data).length > 0 ? Object.values(data).map(item => 
                `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-blue-50 rounded-full text-blue-600 flex items-center justify-center text-xl"><i class="fa-solid fa-user-tie"></i></div><div><h4 class="font-bold text-gray-800 text-lg">${escapeHTML(item.name)}</h4><p class="text-sm text-gray-500">${escapeHTML(item.details) || title}</p><p class="text-xs text-gray-400 mt-1"><i class="fa-solid fa-location-dot"></i> ${escapeHTML(item.address) || '‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶®‡ßá‡¶á'}</p></div></div><div class="flex gap-2"><a href="tel:${item.phone}" class="bg-green-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow hover:bg-green-600"><i class="fa-solid fa-phone"></i></a></div></div>`
            ).join('') : `<div class="text-center py-10"><i class="fa-regular fa-folder-open text-4xl text-gray-300 mb-3"></i><p class="text-gray-400">‡¶è‡¶á ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p></div>`;
        }); 
    }

    window.openUserProfile = (uid) => { 
        if(uid === window.currentUser.uid) return switchPage('profile'); 
        switchPage('view-profile'); history.pushState({ page: 'view-profile', uid }, "", "#profile-view"); 
        ['view-profile-name', 'view-profile-avatar-container', 'view-profile-union-badge', 'view-profile-village-text'].forEach(id => document.getElementById(id).innerText = "...");
        document.getElementById('view-profile-posts-feed').innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>';
        document.getElementById('btn-view-friends-other').setAttribute('onclick', `showAllFriends('${uid}')`);
        const coverImg = document.getElementById('view-profile-cover-img'); coverImg.classList.add('hidden');
        get(ref(db, 'users/' + uid)).then(snap => { 
            const user = snap.val(); if(!user) return switchPage('home');
            document.getElementById('view-profile-avatar-container').innerHTML = user.profile_pic ? `<img src="${user.profile_pic}" class="w-full h-full object-cover">` : `<span class="text-5xl">${user.name ? escapeHTML(user.name).charAt(0) : 'U'}</span>`;
            document.getElementById('view-profile-name').innerHTML = (escapeHTML(user.name) || "‡¶Ö‡¶ú‡ßç‡¶û‡¶æ‡¶§") + checkUserBadge(user);
            document.getElementById('view-profile-union-badge').innerText = user.union || "‡¶á‡¶â‡¶®‡¶ø‡ßü‡¶® ‡¶®‡ßá‡¶á"; document.getElementById('view-profile-village-text').innerText = user.village || "‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á";
            document.getElementById('view-profile-profession').innerText = escapeHTML(user.profession) || "‡¶™‡ßá‡¶∂‡¶æ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á"; document.getElementById('view-profile-location').innerText = escapeHTML(user.location) || "‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶®‡ßá‡¶á";
            document.getElementById('view-profile-bio').innerText = escapeHTML(user.bio) || "‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á"; document.getElementById('view-profile-phone').innerText = user.privacy_hide_contact ? "‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º" : (user.phone || "‡¶´‡ßã‡¶® ‡¶®‡ßá‡¶á");
            if(user.cover_pic) { coverImg.src = user.cover_pic; coverImg.classList.remove('hidden'); }
            checkFriendshipStatus(uid, user.name); loadProfilePosts(uid, 'view-profile-posts-feed'); loadFriendsPreview(uid, 'other');
        }).catch(() => switchPage('home')); 
    };

    window.loadFriendsPreview = (uid, mode) => { 
        const container = document.getElementById(mode === 'me' ? 'profile-friends-preview-me' : 'profile-friends-preview-other'), countSpan = document.getElementById(mode === 'me' ? 'friends-count-me' : 'friends-count-other');
        container.innerHTML = '<p class="col-span-3 text-center text-xs text-gray-400">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';
        get(ref(db, `users/${uid}/friends`)).then(async snap => {
            const friends = Object.keys(snap.val() || {}); countSpan.innerText = `${friends.length} ‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ`;
            if(friends.length === 0) { container.innerHTML = '<p class="col-span-3 text-center text-xs text-gray-400 py-2">‡¶è‡¶ñ‡¶®‡ßã ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶®‡ßá‡¶á</p>'; return; }
            const profiles = await Promise.all(friends.slice(0, 6).map(async fUid => { const data = await getUserData(fUid); return {...data, uid: fUid}; }));
            container.innerHTML = profiles.map(uData => {
                let av = uData.profile_pic ? `<img src="${uData.profile_pic}" class="w-full h-full object-cover">` : `<span class="text-2xl">${escapeHTML(uData.name).charAt(0)}</span>`;
                return `<div onclick="openUserProfile('${uData.uid}')" class="flex flex-col items-center cursor-pointer"><div class="w-full aspect-square bg-gray-100 rounded-lg flex items-center justify-center text-gray-500 font-bold mb-1 border border-gray-200 overflow-hidden shadow-sm">${av}</div><p class="text-[11px] font-semibold text-gray-800 truncate w-full leading-tight mt-0.5">${escapeHTML(uData.name).split(' ')[0]}</p></div>`;
            }).join('');
        });
    }

    window.showAllFriends = (uid) => { 
        const targetUid = uid === 'me' ? window.currentUser.uid : uid; switchPage('friends-list'); 
        const container = document.getElementById('all-friends-container'); container.innerHTML = '<div class="flex justify-center pt-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div></div>';
        get(ref(db, `users/${targetUid}/friends`)).then(async snap => {
            const friends = Object.keys(snap.val() || {});
            if(friends.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 mt-10">‡¶ï‡ßã‡¶®‡ßã ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶° ‡¶®‡ßá‡¶á</p>'; return; }
            const profiles = await Promise.all(friends.map(async fUid => { const data = await getUserData(fUid); return {...data, uid: fUid}; }));
            container.innerHTML = profiles.map(u => {
                let av = u.profile_pic ? `<img src="${u.profile_pic}" class="w-10 h-10 rounded-full object-cover">` : `<div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold">${u.name?escapeHTML(u.name).charAt(0):'U'}</div>`;
                return `<div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer" onclick="openUserProfile('${u.uid}')"><div class="flex items-center gap-3">${av}<div><h4 class="font-bold text-gray-800 text-sm">${escapeHTML(u.name)}</h4><p class="text-xs text-gray-500">${escapeHTML(u.profession) || '‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø'}</p></div></div></div>`;
            }).join('');
        });
    };
    
    // --- MONETIZATION LOGIC (UPDATED: 2000 Friends) ---
    window.checkMonetizationStatus = () => {
        const hasVerified = !!userDetails.isVerified;
        const friendCount = myFriends.length;
        get(query(ref(db, 'posts'), orderByChild('uid'), equalTo(window.currentUser.uid))).then(snap => {
            const postCount = snap.exists() ? Object.keys(snap.val()).length : 0;
            updateMonetizationUI(friendCount, hasVerified, postCount);
        });
    }

    function updateMonetizationUI(friends, verified, posts) {
        const btn = document.getElementById('btn-monetization-apply');
        
        // Updated criteria: 2000 friends
        const fIcon = document.getElementById('crit-follower-icon');
        if(friends >= 2000) { 
            fIcon.classList.replace('criteria-cross', 'criteria-check'); 
            fIcon.innerHTML = '<i class="fa-solid fa-check"></i>'; 
        } else { 
            fIcon.classList.replace('criteria-check', 'criteria-cross'); 
            fIcon.innerHTML = '<i class="fa-solid fa-xmark"></i>'; 
        }
        
        const vIcon = document.getElementById('crit-verified-icon');
        if(verified) { vIcon.classList.replace('criteria-cross', 'criteria-check'); vIcon.innerHTML = '<i class="fa-solid fa-check"></i>'; } else { vIcon.classList.replace('criteria-check', 'criteria-cross'); vIcon.innerHTML = '<i class="fa-solid fa-xmark"></i>'; }
        
        const pIcon = document.getElementById('crit-post-icon');
        if(posts >= 10) { pIcon.classList.replace('criteria-cross', 'criteria-check'); pIcon.innerHTML = '<i class="fa-solid fa-check"></i>'; } else { pIcon.classList.replace('criteria-check', 'criteria-cross'); pIcon.innerHTML = '<i class="fa-solid fa-xmark"></i>'; }
        
        if(friends >= 2000 && verified && posts >= 10) { btn.disabled = false; } else { btn.disabled = true; }
    }

    window.applyForMonetization = () => {
        const btn = document.getElementById('btn-monetization-apply'); btn.innerHTML = '‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; btn.disabled = true;
        push(ref(db, 'monetization_requests'), { uid: window.currentUser.uid, name: userDetails.name, timestamp: Date.now(), status: 'pending' }).then(() => { showToast("‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); btn.innerHTML = '‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'; }).catch(e => { showToast("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + e.message, "error"); btn.disabled = false; btn.innerHTML = '‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®'; });
    }

    function checkFriendshipStatus(targetUid, targetName) { 
        const actionDiv = document.getElementById('view-profile-actions'); actionDiv.innerHTML = '<button class="w-full bg-gray-200 py-2 rounded-lg text-sm font-bold">Checking...</button>';
        get(ref(db, `users/${window.currentUser.uid}/friends/${targetUid}`)).then(snap => {
            if(snap.exists()) actionDiv.innerHTML = `<button onclick="startChat('${targetUid}', '${escapeHTML(targetName)}')" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold text-sm shadow hover:bg-blue-700 flex items-center justify-center gap-2"><i class="fa-brands fa-facebook-messenger"></i> ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</button><button onclick="unfriend('${targetUid}')" class="w-12 bg-red-100 text-red-600 py-2 rounded-lg font-bold text-sm hover:bg-red-200 flex items-center justify-center"><i class="fa-solid fa-user-xmark"></i></button>`;
            else get(ref(db, `friend_requests/${targetUid}/${window.currentUser.uid}`)).then(reqSnap => {
                if(reqSnap.exists()) actionDiv.innerHTML = `<button onclick="toggleFriendRequest('${targetUid}')" class="flex-1 bg-gray-200 text-gray-600 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2">Cancel Request</button>`;
                else get(ref(db, `friend_requests/${window.currentUser.uid}/${targetUid}`)).then(incSnap => {
                    if(incSnap.exists()) actionDiv.innerHTML = `<button onclick="acceptRequest('${targetUid}')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold text-sm shadow hover:bg-green-700 flex items-center justify-center gap-2">Confirm</button><button onclick="cancelRequest('${targetUid}', true)" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-bold text-sm hover:bg-gray-300 flex items-center justify-center gap-2">Delete</button>`;
                    else actionDiv.innerHTML = `<button onclick="sendFriendRequest('${targetUid}')" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold text-sm shadow hover:bg-blue-700 flex items-center justify-center gap-2"><i class="fa-solid fa-user-plus"></i> ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°</button><button onclick="startChat('${targetUid}', '${escapeHTML(targetName)}')" class="flex-1 bg-gray-200 text-black py-2 rounded-lg font-bold text-sm hover:bg-gray-300 flex items-center justify-center gap-2"><i class="fa-brands fa-facebook-messenger"></i> ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</button>`;
                });
            });
        });
    }
    
    window.sendFriendRequest = (toUid) => set(ref(db, `friend_requests/${toUid}/${window.currentUser.uid}`), { fromName: userDetails.name, fromUid: window.currentUser.uid, timestamp: Date.now() }).then(() => { showToast("‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); checkFriendshipStatus(toUid, "User"); });
    function listenForFriendRequests(uid) { onValue(ref(db, `friend_requests/${uid}`), updatePeopleTab); }
    
    // --- NOTIFICATIONS ---
    window.listenForNotificationBadge = (uid) => {
        onValue(query(ref(db, `notifications/${uid}`), orderByChild('read'), equalTo(false)), (snap) => {
            const count = snap.exists() ? Object.keys(snap.val()).length : 0;
            const badge = document.getElementById('header-badge-notice');
            badge.innerText = count; badge.classList[count > 0 ? 'add' : 'remove']('active');
        });
    }

    window.loadNotifications = (isInitial = false) => {
        const list = document.getElementById('notifications-list'); const btn = document.getElementById('btn-load-more-notif');
        if(isInitial) { list.innerHTML = '<p class="text-center text-gray-400 mt-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>'; lastNotifKey = null; hasMoreNotifs = true; }
        if(!hasMoreNotifs) { btn.classList.add('hidden'); return; }
        const pageSize = 10;
        let notifQuery;
        if (isInitial) notifQuery = query(ref(db, `notifications/${window.currentUser.uid}`), orderByKey(), limitToLast(pageSize));
        else notifQuery = query(ref(db, `notifications/${window.currentUser.uid}`), orderByKey(), endAt(lastNotifKey), limitToLast(pageSize + 1));
        
        get(notifQuery).then(snap => {
            const data = snap.val(); if(isInitial) list.innerHTML = '';
            if(!data) { if(isInitial) list.innerHTML = '<p class="text-center text-gray-400 mt-10">‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶®‡ßá‡¶á</p>'; hasMoreNotifs = false; btn.classList.add('hidden'); return; }
            let items = Object.entries(data).map(([key, val]) => ({id: key, ...val})).sort((a,b)=>b.timestamp - a.timestamp);
            if (!isInitial && items.length > 0) items = items.filter(i => i.id !== lastNotifKey);
            if (items.length < pageSize && !isInitial) hasMoreNotifs = false;
            items.forEach(n => {
                const bgClass = n.read ? 'bg-white' : 'bg-blue-50'; let html = '';
                if(n.type === 'blood_req') {
                    html = `<div class="${bgClass} p-3 rounded-xl shadow-sm border-l-4 border-red-600 flex justify-between items-center mb-3"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600 font-bold"><i class="fa-solid fa-droplet"></i></div><div><h4 class="font-bold text-red-800 text-sm">‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶∞‡¶ï‡ßç‡¶§ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®! (${n.group})</h4><p class="text-xs text-gray-600">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó: ${n.contact}</p><p class="text-[10px] text-gray-400">${timeAgo(n.timestamp)}</p></div></div><a href="tel:${n.contact}" class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white"><i class="fa-solid fa-phone"></i></a></div>`;
                } else {
                    let icon = 'fa-rss', color = 'text-blue-600', bg = 'bg-blue-100', text = '‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®';
                    if (n.type === 'like') { icon = 'fa-thumbs-up'; color = 'text-green-600'; bg = 'bg-green-100'; text = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá ‡¶≤‡¶æ‡¶á‡¶ï ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®'; }
                    if (n.type === 'comment') { icon = 'fa-comment'; color = 'text-purple-600'; bg = 'bg-purple-100'; text = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®'; }
                    html = `<div class="${bgClass} p-3 rounded-xl shadow-sm border-l-4 border-blue-400 flex justify-between items-center mb-3 cursor-pointer" onclick="handleNotificationClick('${n.id}', '${n.postId}', '${n.type}')"><div class="flex items-center gap-3"><div class="w-10 h-10 ${bg} rounded-full flex items-center justify-center ${color} font-bold"><i class="fa-solid ${icon}"></i></div><div><h4 class="font-bold text-gray-800 text-sm">${escapeHTML(n.fromName)}</h4><p class="text-xs text-gray-500">${text}</p><p class="text-[10px] text-gray-400">${timeAgo(n.timestamp)}</p></div></div></div>`;
                }
                list.insertAdjacentHTML('beforeend', html);
            });
            if(items.length > 0) { lastNotifKey = items[items.length - 1].id; btn.classList.remove('hidden'); } else { btn.classList.add('hidden'); }
        });
    }

    window.handleNotificationClick = (notifId, postId, type) => { update(ref(db, `notifications/${window.currentUser.uid}/${notifId}`), { read: true }); if (['new_post', 'like', 'comment'].includes(type)) openSinglePostModal(postId); };
    window.openSinglePostModal = (postId) => { const c = document.getElementById('single-post-content'); document.getElementById('single-post-modal').classList.remove('hidden-custom'); c.innerHTML = '<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div></div>'; get(ref(db, `posts/${postId}`)).then(snap => c.innerHTML = snap.exists() ? createPostHTML(snap.val(), postId) : '<p class="text-center text-gray-400 mt-10">‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶ü‡¶ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p>'); };
    
    window.acceptRequest = (fromUid) => update(ref(db), { [`users/${window.currentUser.uid}/friends/${fromUid}`]: true, [`users/${fromUid}/friends/${window.currentUser.uid}`]: true, [`friend_requests/${window.currentUser.uid}/${fromUid}`]: null }).then(() => { showToast("‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶™‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); get(ref(db, `users/${window.currentUser.uid}/friends`)).then((snap) => { myFriends = Object.keys(snap.val()||{}); updatePeopleTab(); loadQuickChatFriends(); }); });
    window.cancelRequest = (fromUid, isDelete) => remove(ref(db, isDelete ? `friend_requests/${window.currentUser.uid}/${fromUid}` : `friend_requests/${fromUid}/${window.currentUser.uid}`)).then(() => { showToast("‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü/‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); if(!isDelete) { const btn = document.getElementById(`btn-req-${fromUid}`); if(btn) { btn.classList.replace('bg-gray-200', 'bg-blue-600'); btn.classList.replace('text-gray-600', 'text-white'); btn.innerHTML = '<i class="fa-solid fa-user-plus"></i> Add'; btn.disabled = false; } } });

    window.startChat = (uid, name) => { currentChatUser = { uid, name }; switchPage('messages'); document.getElementById('chat-list-view').classList.add('hidden', 'hidden-custom'); document.getElementById('chat-conversation-view').classList.remove('hidden', 'hidden-custom'); document.getElementById('chat-header-name').innerText = escapeHTML(name); document.getElementById('chat-header-img').innerText = escapeHTML(name).charAt(0); history.pushState({ page: 'chat-conversation', uid }, "", "#chat"); loadMessages(uid); };
    window.closeChat = () => { document.getElementById('chat-list-view').classList.remove('hidden', 'hidden-custom'); document.getElementById('chat-conversation-view').classList.add('hidden', 'hidden-custom'); currentChatUser = null; };
    function getChatId(uid1, uid2) { return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`; }
    
    onValue(ref(db, 'notices'), (snapshot) => { const data = snapshot.val(); if(data) { const notice = Object.values(data).pop(); document.getElementById('live-notices').innerHTML = `<div class="bg-orange-50 p-4 m-3 rounded-xl border-l-4 border-orange-500 flex items-start gap-3 shadow-sm"><i class="fa-solid fa-bullhorn text-orange-600 mt-1"></i><div><h3 class="font-bold text-orange-900 text-sm">${escapeHTML(notice.title)}</h3><p class="text-xs text-orange-800 line-clamp-2 mt-1">${escapeHTML(notice.description)}</p></div></div>`; } });
    
    window.submitProduct = async () => { 
        const title = document.getElementById('sell-title').value.trim(), price = document.getElementById('sell-price').value.trim(), desc = document.getElementById('sell-desc').value.trim(), file = document.getElementById('sell-image-file').files[0];
        if(!title) return; const btn = document.getElementById('btn-sell-submit'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...'; btn.disabled = true;
        try { 
            let imgUrl = "";
            if(file) { const res = await uploadMediaToCloudinary(file); imgUrl = res.url; }
            await push(ref(db, 'market_items'), { uid: window.currentUser.uid, seller: userDetails.name, title, price, desc, image: imgUrl, time: Date.now() }); toggleSellModal(false); document.getElementById('sell-title').value = ""; showToast("‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); 
        } catch(e) { console.error(e); showToast("‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶°‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + e.message, 'error'); } finally { btn.innerText = "‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡¶ø‡¶®"; btn.disabled = false; } 
    };
    
    onValue(ref(db, 'market_items'), (snap) => { 
        globalMarketItems = Object.values(snap.val() || {}).reverse(); 
        document.getElementById('market-list').innerHTML = globalMarketItems.length > 0 ? globalMarketItems.map(item => {
            const imgTag = item.image ? `<img src="${item.image}" class="h-full w-full object-cover">` : `<i class="fa-solid fa-image text-3xl"></i>`;
            return `<div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex flex-col justify-between"><div><div class="h-24 bg-gray-100 rounded-lg mb-2 flex items-center justify-center text-gray-300 overflow-hidden">${imgTag}</div><h3 class="font-bold text-sm text-gray-800 line-clamp-1">${escapeHTML(item.title)}</h3><p class="text-orange-600 font-bold text-sm">‡ß≥ ${escapeHTML(item.price)}</p><p class="text-[10px] text-gray-500 line-clamp-2 mt-1">${escapeHTML(item.desc)}</p></div><div class="mt-2 pt-2 border-t flex justify-between items-center"><span class="text-[10px] text-gray-400">${escapeHTML(item.seller).split(' ')[0]}</span><button class="bg-green-500 text-white px-2 py-1 rounded text-xs"><i class="fa-solid fa-phone"></i></button></div></div>`;
        }).join('') : '<p class="col-span-2 text-center text-gray-400 py-10">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á</p>'; 
    });

    window.submitEmergencyAlert = () => {
        const type = document.getElementById('emergency-type').value; const title = document.getElementById('emergency-title').value.trim(); const desc = document.getElementById('emergency-desc').value.trim(); const contact = document.getElementById('emergency-contact').value.trim();
        if(!title || !desc) return showToast("‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®", "error");
        push(ref(db, 'emergency_alerts'), { uid: window.currentUser.uid, authorName: userDetails.name, type, title, desc, contact, timestamp: Date.now() }).then(() => { showToast("‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); document.getElementById('emergency-modal').classList.add('hidden-custom'); document.getElementById('emergency-title').value = ""; document.getElementById('emergency-desc').value = ""; });
    }

    window.loadEmergencyAlerts = () => {
        onValue(query(ref(db, 'emergency_alerts'), limitToLast(20)), (snap) => {
            const data = snap.val(); const list = document.getElementById('emergency-list');
            if(!data) { list.innerHTML = '<p class="text-center text-gray-400 py-10">‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶®‡ßá‡¶á</p>'; return; }
            const alerts = Object.values(data).sort((a,b)=>b.timestamp - a.timestamp);
            list.innerHTML = alerts.map(alert => {
                let badgeColor = "bg-red-100 text-red-800"; if(alert.type === 'Lost') badgeColor = "bg-orange-100 text-orange-800"; if(alert.type === 'Found') badgeColor = "bg-green-100 text-green-800";
                return `<div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500"><div class="flex justify-between items-start mb-2"><span class="text-xs font-bold px-2 py-0.5 rounded ${badgeColor}">${alert.type}</span><span class="text-[10px] text-gray-400">${timeAgo(alert.timestamp)}</span></div><h3 class="font-bold text-gray-800 text-base mb-1">${escapeHTML(alert.title)}</h3><p class="text-sm text-gray-600 mb-2">${escapeHTML(alert.desc)}</p><div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-100"><span class="text-xs text-gray-500 font-bold"><i class="fa-solid fa-user mr-1"></i> ${escapeHTML(alert.authorName)}</span>${alert.contact ? `<a href="tel:${alert.contact}" class="bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow"><i class="fa-solid fa-phone mr-1"></i> ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</a>` : ''}</div></div>`;
            }).join('');
        });
    }

    window.submitDonor = () => { const bloodGroup = document.getElementById('donor-blood-group').value; if(!bloodGroup) return showToast("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®!", 'error'); set(ref(db, 'donors/' + window.currentUser.uid), { name: userDetails.name, bloodGroup, phone: document.getElementById('donor-phone').value, lastDate: document.getElementById('donor-last-date').value, uid: window.currentUser.uid, union: userDetails.union || '', village: userDetails.village || '' }).then(() => { showToast("‡¶Ü‡¶™‡¶®‡¶ø ‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡¶®!"); toggleDonorModal(false); }); };
    window.sendEmergencyBloodRequest = () => { const group = document.getElementById('req-blood-group').value; if(!group) return showToast("‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï", 'error'); get(ref(db, 'donors')).then((snapshot) => { const count = Object.values(snapshot.val()||{}).filter(d=>d.bloodGroup===group).length; Object.values(snapshot.val()||{}).filter(d=>d.bloodGroup===group).forEach(d=> push(ref(db, `notifications/${d.uid}`), { type: 'blood_req', group, location: document.getElementById('req-location').value.trim(), contact: document.getElementById('req-contact').value.trim(), timestamp: Date.now(), read: false })); showToast(`${count} ‡¶ú‡¶® ‡¶°‡ßã‡¶®‡¶æ‡¶∞‡¶ï‡ßá ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!`); toggleBloodRequestModal(false); }); }
    
    onValue(ref(db, 'donors'), (snapshot) => { allDonors = Object.values(snapshot.val() || {}); filterDonors(); });
    window.filterDonors = () => { 
        const bgFilter = document.getElementById('blood-filter').value, unionFilter = document.getElementById('blood-union-filter').value;
        const filtered = allDonors.filter(d => (bgFilter === 'all' || d.bloodGroup === bgFilter) && (unionFilter === 'all' || d.union === unionFilter));
        document.getElementById('donor-list').innerHTML = filtered.length > 0 ? filtered.map(donor => `<div class="bg-white p-4 rounded-xl shadow-sm border border-red-50 flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600 font-bold text-xs border border-red-200">${escapeHTML(donor.bloodGroup)}</div><div><p class="font-bold text-gray-800 text-sm">${escapeHTML(donor.name)}</p><p class="text-[10px] text-gray-500 mt-0.5"><i class="fa-solid fa-location-dot mr-1"></i>${escapeHTML(donor.union || 'Unknown')}</p><p class="text-[10px] text-gray-500 mt-0.5"><i class="fa-regular fa-calendar mr-1"></i>‡¶∂‡ßá‡¶∑ ‡¶¶‡¶æ‡¶®: ${escapeHTML(donor.lastDate)}</p></div></div><a href="tel:${donor.phone}" class="bg-green-500 text-white w-9 h-9 rounded-full flex items-center justify-center shadow hover:bg-green-600"><i class="fa-solid fa-phone text-sm"></i></a></div>`).join('') : '<div class="text-center p-6 text-gray-400">‡¶è‡¶á ‡¶∂‡¶∞‡ßç‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßã‡¶®‡¶æ‡¶∞ ‡¶®‡ßá‡¶á</div>';
    };

        window.submitComplaint = () => { const text = document.getElementById('complaint-text').value.trim(); if(!text) return showToast("‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®", 'error'); push(ref(db, 'complaints'), { uid: window.currentUser.uid, authorName: document.getElementById('complaint-anon').checked ? "‡¶®‡¶æ‡¶Æ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡ßá ‡¶Ö‡¶®‡¶ø‡¶ö‡ßç‡¶õ‡ßÅ‡¶ï" : userDetails.name, type: document.getElementById('complaint-type').value, submitTo: document.getElementById('complaint-to').value, text, timestamp: Date.now(), status: 'Pending', union: userDetails.union || 'Unknown', village: userDetails.village || 'Unknown' }).then(() => { showToast("‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); document.getElementById('complaint-text').value = ""; document.getElementById('complaint-anon').checked = false; }).catch(e => showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + e.message, 'error')); };
    window.loadMyComplaints = () => { onValue(query(ref(db, 'complaints'), orderByChild('uid'), startAt(window.currentUser.uid), endAt(window.currentUser.uid)), (snap) => { const data = Object.values(snap.val() || {}).sort((a,b)=>b.timestamp - a.timestamp); document.getElementById('my-complaints-list').innerHTML = data.length > 0 ? data.map(c => { const statusMap = { 'Processing': {c: 'text-blue-600 bg-blue-100', t: '‡¶ï‡¶æ‡¶ú ‡¶ö‡¶≤‡¶õ‡ßá'}, 'Resolved': {c: 'text-green-600 bg-green-100', t: '‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá'} }; const st = statusMap[c.status] || {c: 'text-yellow-600 bg-yellow-100', t: '‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'}; return `<div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100"><div class="flex justify-between items-start mb-1"><span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded">To: ${c.submitTo}</span><span class="text-[10px] font-bold px-2 py-0.5 rounded ${st.c}">${st.t}</span></div><p class="text-sm text-gray-800 mt-2">${escapeHTML(c.text)}</p><p class="text-[10px] text-gray-400 mt-2 text-right">${timeAgo(c.timestamp)}</p></div>`; }).join('') : '<p class="text-center text-gray-400 text-xs py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶®‡ßá‡¶á</p>'; }); };

    // --- UPDATED VERIFICATION LOGIC (FULL SCREEN PAGE) ---
    window.checkVerificationStatus = () => {
        // Fetch User Data for Verification Status
        const uid = window.currentUser.uid;
        get(ref(db, `users/${uid}`)).then(snap => {
            const user = snap.val();
            const status = user.verificationStatus || 'none'; 
            const expiry = user.verificationExpiry || 0;
            const banner = document.getElementById('verify-status-banner');
            const formContainer = document.getElementById('verify-form-container');
            const plansContainer = document.getElementById('verification-plans-container');
            
            // Check Expiry Logic
            if (status === 'verified' && Date.now() > expiry) {
                // EXPIRED: Reset locally and show form (Ideally update DB via backend function, but client logic handles display)
                banner.classList.remove('hidden');
                banner.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg mb-4">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-clock-rotate-left text-red-600 text-xl"></i>
                            <div>
                                <h4 class="font-bold text-red-800">‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá‡¶õ‡ßá</h4>
                                <p class="text-sm text-red-600">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú‡ßá‡¶∞ ‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                            </div>
                        </div>
                    </div>`;
                formContainer.classList.remove('hidden');
                
                // Load Plans for Re-application
                loadVerificationPlans(plansContainer);
                return; 
            }

            if (status === 'pending') {
                banner.classList.remove('hidden');
                banner.innerHTML = `
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-r-lg">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-hourglass-half text-yellow-600 text-xl"></i>
                            <div>
                                <h4 class="font-bold text-yellow-800">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ‡¶ß‡ßÄ‡¶®</h4>
                                <p class="text-sm text-yellow-600">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ü‡¶ø ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ï‡¶∞‡¶õ‡ßá‡¶®‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                              </div>
                        </div>
                    </div>`;
                formContainer.classList.add('hidden'); // ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶´‡¶∞‡ßç‡¶Æ ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®
            } else if (status === 'verified') {
                const daysLeft = Math.ceil((expiry - Date.now()) / (1000 * 60 * 60 * 24));
                banner.classList.remove('hidden');
                banner.innerHTML = `
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-circle-check text-green-600 text-xl"></i>
                            <div>
                                <h4 class="font-bold text-green-800">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</h4>
                                <p class="text-sm text-green-600">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶°‡•§ ‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶Ü‡¶õ‡ßá: <b>${daysLeft > 0 ? daysLeft : 0} ‡¶¶‡¶ø‡¶®</b></p>
                            </div>
                        </div>
                    </div>`;
                formContainer.classList.add('hidden'); // ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶° ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶´‡¶∞‡ßç‡¶Æ ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®
            } else if (status === 'rejected') {
                banner.classList.remove('hidden');
                banner.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg mb-4">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-circle-xmark text-red-600 text-xl"></i>
                            <div>
                                <h4 class="font-bold text-red-800">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá</h4>
                                <p class="text-sm text-red-600">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ü‡¶ø ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                            </div>
                        </div>
                    </div>`;
                formContainer.classList.remove('hidden'); // ‡¶∞‡¶ø‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶≤‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶´‡¶∞‡ßç‡¶Æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
                loadVerificationPlans(plansContainer);
            } else {
                // NONE or default status
                banner.classList.add('hidden');
                formContainer.classList.remove('hidden');
                loadVerificationPlans(plansContainer);
            }
        });
    }

    function loadVerificationPlans(container) {
        container.innerHTML = '<p class="text-center text-sm text-gray-400">‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';
        onValue(ref(db, 'admin_settings/verification_plans'), (snap) => {
            const plans = snap.val();
            if (plans) {
                container.innerHTML = Object.entries(plans).map(([key, plan]) => {
                    return `<div onclick="selectPlan('${key}', '${plan.price}', '${plan.duration}')" id="plan-${key}" class="plan-card bg-white p-3 rounded-xl border flex justify-between items-center cursor-pointer hover:shadow-sm mb-2">
                        <div>
                            <h4 class="font-bold text-gray-800">${plan.name}</h4>
                            <p class="text-xs text-gray-500">${plan.duration} ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø</p>
                            ${plan.trial ? '<span class="text-[10px] bg-green-100 text-green-700 px-1 rounded font-bold">Free Trial Available</span>' : ''}
                        </div>
                        <span class="font-bold text-blue-600">‡ß≥ ${plan.price}</span>
                    </div>`;
                }).join('');
            } else {
                // Default Dummy Plans if not set by admin
                const defaults = [
                    {id: 'p1', name: 'Starter', price: 100, duration: 30},
                    {id: 'p2', name: 'Pro', price: 500, duration: 180},
                    {id: 'p3', name: 'Yearly', price: 900, duration: 365}
                ];
                container.innerHTML = defaults.map(plan => `
                    <div onclick="selectPlan('${plan.id}', '${plan.price}', '${plan.duration}')" id="plan-${plan.id}" class="plan-card bg-white p-3 rounded-xl border flex justify-between items-center cursor-pointer hover:shadow-sm mb-2">
                        <div><h4 class="font-bold text-gray-800">${plan.name}</h4><p class="text-xs text-gray-500">${plan.duration} ‡¶¶‡¶ø‡¶®</p></div>
                        <span class="font-bold text-blue-600">‡ß≥ ${plan.price}</span>
                    </div>`).join('');
            }
        });
    }

    window.selectPlan = (id, price, duration) => {
        document.querySelectorAll('.plan-card').forEach(el => el.classList.remove('selected'));
        document.getElementById(`plan-${id}`).classList.add('selected');
        document.getElementById('selected-plan-id').value = id;
        document.getElementById('verification-payment-section').classList.remove('hidden');
        document.getElementById('verification-docs-section').classList.remove('hidden');
        document.getElementById('btn-verify-submit').classList.remove('hidden');
        document.getElementById('btn-verify-submit').disabled = false;
        
        // Auto scroll to payment section
        document.getElementById('verification-payment-section').scrollIntoView({behavior: 'smooth'});
    }

    window.selectPaymentMethod = (method) => {
        document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
        const el = document.getElementById(`pay-${method.toLowerCase()}`);
        if(el) el.classList.add('selected');
        document.getElementById('selected-payment-method').value = method;
        
        // Fetch Admin Number based on method
        onValue(ref(db, `admin_settings/payment_numbers/${method}`), (snap) => {
            const num = snap.val() || "01xxxxxxxxx";
            document.getElementById('admin-number').innerText = num;
        });
    }

    window.submitVerification = async () => { 
        const planId = document.getElementById('selected-plan-id').value;
        const method = document.getElementById('selected-payment-method').value;
        const paymentNumber = document.getElementById('verify-payment-number').value;
        const trxId = document.getElementById('verify-trx-id').value;
        const nid = document.getElementById('verify-nid').value.trim();
        const docFile = document.getElementById('verify-doc-img').files[0];
        const userFile = document.getElementById('verify-user-img').files[0];

        if(!planId) return showToast("‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®", "error");
        if(!method || !paymentNumber || !trxId) return showToast("‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®", "error");
        if(!nid || !docFile || !userFile) return showToast("‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∏ ‡¶ì ‡¶õ‡¶¨‡¶ø ‡¶¶‡¶ø‡¶®", "error");

        const btn = document.getElementById('btn-verify-submit'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç...'; btn.disabled = true; 
        
        try { 
            const [docRes, userRes] = await Promise.all([ uploadMediaToCloudinary(docFile), uploadMediaToCloudinary(userFile) ]);
            
            const reqData = {
                uid: window.currentUser.uid,
                name: userDetails.name,
                planId,
                paymentMethod: method,
                paymentNumber,
                trxId,
                nid,
                docImage: docRes.url,
                userImage: userRes.url,
                timestamp: Date.now(),
                status: 'pending' // Initial status for Admin request list
            };

            // 1. Save Request for Admin (UID as Key)
            await set(ref(db, 'verification_requests/' + window.currentUser.uid), reqData);
            
            // 2. Update User Profile Status to 'pending' to lock UI
            await update(ref(db, 'users/' + window.currentUser.uid), { verificationStatus: 'pending' });

            showToast("‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); 
            
            // Reload the verification page view to show pending banner immediately
            window.checkVerificationStatus();

        } catch(e) { 
            console.error(e); showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + e.message, 'error'); 
            btn.innerHTML = "‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®"; btn.disabled = false; 
        } 
    }

    window.togglePrivacy = (checked) => update(ref(db, 'users/' + window.currentUser.uid), { privacy_hide_contact: checked }).then(() => showToast("‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá"));
    window.changeFontSize = (size) => { const body = document.getElementById('body-main'); body.classList.remove('text-small', 'text-large'); if(size !== 'normal') body.classList.add('text-' + size); localStorage.setItem('fontSize', size); };
    window.handleDeleteAccount = () => { if (prompt("‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá 'DELETE' ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:") === 'DELETE') update(ref(db, 'users/' + window.currentUser.uid), { deleted: true, email: 'deleted', phone: 'deleted' }).then(() => deleteUser(window.currentUser).then(() => { alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); window.location.reload(); })); };
    
    window.toggleGlobalSearch = (open) => { const m = document.getElementById('search-modal'); if(open) { m.classList.remove('hidden-custom'); setTimeout(()=>m.classList.add('open'), 10); document.getElementById('global-search-input').focus(); } else { m.classList.remove('open'); setTimeout(()=>m.classList.add('hidden-custom'), 300); } }
    
    window.debouncedGlobalSearch = debounce((q) => {
        q = q.toLowerCase().trim(); const container = document.getElementById('global-search-results');
        if(q.length < 1) { container.innerHTML = '<div class="text-center mt-20 text-gray-400"><i class="fa-solid fa-magnifying-glass text-4xl mb-3 opacity-30"></i><p>‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</p></div>'; return; }
        let html = '';
        const matchedUsers = allUsers.filter(u => u.name.toLowerCase().includes(q));
        if(matchedUsers.length > 0) html += `<h4 class="font-bold text-xs text-gray-500 mb-2 mt-2">‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑</h4>` + matchedUsers.slice(0, 3).map(u => `<div onclick="openUserProfile('${u.uid}'); toggleGlobalSearch(false)" class="bg-white p-3 rounded-lg shadow-sm flex items-center gap-3 cursor-pointer"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-xs">${u.name.charAt(0)}</div><span class="text-sm font-bold text-gray-800">${u.name}${checkUserBadge(u)}</span></div>`).join('');
        const matchedMarket = globalMarketItems.filter(i => i.title.toLowerCase().includes(q));
        if(matchedMarket.length > 0) html += `<h4 class="font-bold text-xs text-gray-500 mb-2 mt-4">‡¶π‡¶æ‡¶ü / ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞</h4>` + matchedMarket.slice(0, 3).map(i => `<div onclick="switchPage('market'); toggleGlobalSearch(false)" class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center cursor-pointer"><span class="text-sm font-bold text-gray-800">${i.title}</span><span class="text-xs text-orange-600 font-bold">‡ß≥ ${i.price}</span></div>`).join('');
        let dirMatches = []; Object.values(globalDirectory || {}).forEach(catItems => Object.values(catItems).forEach(item => { if(item.name.toLowerCase().includes(q)) dirMatches.push(item); }));
        if(dirMatches.length > 0) html += `<h4 class="font-bold text-xs text-gray-500 mb-2 mt-4">‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø</h4>` + dirMatches.slice(0, 3).map(i => `<div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center"><span class="text-sm font-bold text-gray-800">${i.name}</span><a href="tel:${i.phone}" class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs"><i class="fa-solid fa-phone"></i></a></div>`).join('');
        container.innerHTML = html || '<div class="text-center mt-10 text-gray-400"><p>‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p></div>';
    }, 500);

    // --- New Features Logic ---
    window.openTagModal = () => {
        openModalWithHistory('tag-friends-modal', "#tag-friends");
        const list = document.getElementById('tag-friends-list');
        list.innerHTML = '';
        
        if (myFriends.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-400">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶®‡ßá‡¶á</p>';
            return;
        }

        const promises = myFriends.map(uid => getUserData(uid));
        Promise.all(promises).then(friendsData => {
            let html = '';
            friendsData.forEach(u => {
                                if(u) {
                    const isTagged = window.taggedUsers.some(t => t.uid === u.uid);
                    html += `<div onclick="toggleTagUser('${u.uid}', '${escapeHTML(u.name)}')" class="bg-white p-3 rounded-lg flex justify-between items-center cursor-pointer border ${isTagged ? 'border-green-500 bg-green-50' : 'border-gray-100'} tag-item-${u.uid}">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-xs font-bold">${u.name.charAt(0)}</div>
                            <span class="font-bold text-sm text-gray-800">${escapeHTML(u.name)}</span>
                        </div>
                        <i class="fa-solid fa-check-circle ${isTagged ? 'text-green-600' : 'text-gray-300'} tag-icon-${u.uid}"></i>
                    </div>`;
                }
            });
            list.innerHTML = html;
        });
    };

    window.closeTagModal = () => {
        document.getElementById('tag-friends-modal').classList.add('hidden-custom');
        if(history.state?.modal === 'tag-friends-modal') history.back();
    };

    window.toggleTagUser = (uid, name) => {
        const index = window.taggedUsers.findIndex(u => u.uid === uid);
        const item = document.querySelector(`.tag-item-${uid}`);
        const icon = document.querySelector(`.tag-icon-${uid}`);
        
        if (index > -1) {
            window.taggedUsers.splice(index, 1);
            item.classList.remove('border-green-500', 'bg-green-50');
            item.classList.add('border-gray-100');
            icon.classList.remove('text-green-600');
            icon.classList.add('text-gray-300');
        } else {
            window.taggedUsers.push({uid, name});
            item.classList.add('border-green-500', 'bg-green-50');
            item.classList.remove('border-gray-100');
            icon.classList.add('text-green-600');
            icon.classList.remove('text-gray-300');
        }
    };

    window.saveTags = () => {
        closeTagModal();
        showToast(`${window.taggedUsers.length} ‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`);
    };

    window.openFeelingModal = () => {
        openModalWithHistory('feeling-modal', "#feeling");
        document.getElementById('feeling-modal').classList.remove('hidden-custom');
        setTimeout(() => document.getElementById('feeling-modal').classList.add('open'), 10);
    };

    window.closeFeelingModal = () => {
        document.getElementById('feeling-modal').classList.remove('open');
        setTimeout(() => {
            document.getElementById('feeling-modal').classList.add('hidden-custom');
            if(history.state?.modal === 'feeling-modal') history.back();
        }, 300);
    };

    window.selectFeeling = (text, emoji) => {
        window.selectedFeeling = { text, emoji };
        closeFeelingModal();
        showToast(`Feeling ${text} ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`);
    };
    
    // --- INVITE & RULES LOGIC ---
    window.handleInvite = () => {
        onValue(ref(db, 'admin_settings/share_link'), (snap) => {
            const link = snap.val() || window.location.href;
            const text = `‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ï‡¶≤ ‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡¶ø‡¶® ‡¶π‡¶æ‡¶§‡ßá‡¶∞ ‡¶Æ‡ßÅ‡¶†‡ßã‡ßü! ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶≤‡¶ø‡¶Ç‡¶ï: ${link}`;
            
            if (navigator.share) {
                navigator.share({
                    title: '‡¶™‡¶æ‡¶•‡¶∞‡¶ò‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤',
                    text: text,
                    url: link,
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(text).then(() => showToast("‡¶á‡¶®‡¶≠‡¶æ‡¶á‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!"));
            }
        });
    }

    window.openRules = () => {
        onValue(ref(db, 'admin_settings/rules_link'), (snap) => {
            const link = snap.val();
            if(link) window.open(link, '_blank');
            else showToast("‡¶∞‡ßÅ‡¶≤‡¶∏ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø", "error");
        });
    }

</script>

<script>
    function toggleAuth(v){ ['login-form','register-form','forgot-form'].forEach(id => document.getElementById(id).classList.add('hidden-custom')); document.getElementById(v+'-form')?.classList.remove('hidden-custom'); }
    
    function openModalWithHistory(id, hash) { document.getElementById(id).classList.remove('hidden-custom'); history.pushState({ modal: id }, null, hash); }

    function togglePostModal(s){ 
        if(s) { 
            openModalWithHistory('post-modal', "#create-post");
            if(window.currentUser) { 
                document.getElementById('post-modal-user-name').innerText = document.getElementById('sidebar-name').innerText; 
                document.getElementById('post-modal-user-img').innerHTML = document.getElementById('sidebar-avatar-container').innerHTML; 
            } 
        } else {
            document.getElementById('post-modal').classList.add('hidden-custom');
            if(history.state?.modal === 'post-modal') history.back();
        }
    }

    function togglePollModal(s){ 
        if(s) { openModalWithHistory('poll-modal', "#create-poll"); } else { document.getElementById('poll-modal').classList.add('hidden-custom'); if(history.state?.modal === 'poll-modal') history.back(); }
    }

    function toggleDonorModal(s){ 
        if(s) openModalWithHistory('donor-modal', "#donor-reg"); else { document.getElementById('donor-modal').classList.add('hidden-custom'); if(history.state?.modal === 'donor-modal') history.back(); }
    }

    function toggleBloodRequestModal(s){ 
        if(s) openModalWithHistory('modal-blood-request', "#blood-req"); else { document.getElementById('modal-blood-request').classList.add('hidden-custom'); if(history.state?.modal === 'modal-blood-request') history.back(); }
    }
    
    function toggleEditProfile(s){ 
        if(s) openModalWithHistory('edit-profile-modal', "#edit-profile"); else { document.getElementById('edit-profile-modal').classList.add('hidden-custom'); if(history.state?.modal === 'edit-profile-modal') history.back(); }
    }
    
    function toggleSellModal(s){ 
        if(s) openModalWithHistory('sell-modal', "#sell-item"); else { document.getElementById('sell-modal').classList.add('hidden-custom'); if(history.state?.modal === 'sell-modal') history.back(); }
    }

        function toggleSidebar(open) { 
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('sidebar-overlay'); 
        if(open) { 
            sb.classList.add('open'); 
            ov.classList.remove('hidden-custom'); 
            setTimeout(()=>ov.classList.add('open'), 10); 
        } else { 
            sb.classList.remove('open'); 
            ov.classList.remove('open'); 
            setTimeout(()=>ov.classList.add('hidden-custom'), 300); 
        } 
    }

    let fabOpen = false; 
    function toggleFab() { 
        fabOpen = !fabOpen; 
        document.getElementById('fab-options').classList.toggle('show'); 
        document.getElementById('main-fab').classList.toggle('rotate'); 
    }

    function switchPage(id, addHistory = true){ 
        document.querySelectorAll('.post-menu-dropdown').forEach(el => el.classList.add('hidden')); 
        
        // Hide all pages & reset nav buttons
        ['home','services','market','blood','emergency','directory','directory-list','profile','people','messages','notifications','view-profile','friends-list', 'complaints', 'settings', 'dynamic-content', 'monetization', 'verification'].forEach(p => { 
            document.getElementById('page-'+p)?.classList.add('hidden'); 
            document.getElementById('btn-'+p)?.classList.replace('nav-active', 'text-gray-500'); 
            document.getElementById('btn-'+p)?.classList.remove('text-green-600'); 
        });

        // Show target page
        document.getElementById('page-'+id)?.classList.remove('hidden'); 
        
        // Update Nav Button Style
        const btn = document.getElementById('btn-'+id); 
        if(btn) { 
            btn.classList.add('nav-active','text-green-600'); 
            btn.classList.remove('text-gray-500'); 
        }
        
        window.scrollTo(0,0); 
        
        // Specific Page Logic
        if(id === 'profile' && window.currentUser) window.loadProfilePosts(window.currentUser.uid, 'my-posts-feed');
        if(id === 'monetization' && window.currentUser) window.checkMonetizationStatus();
        if(id === 'verification' && window.currentUser) window.checkVerificationStatus();
        if(id === 'notifications') { 
            document.getElementById('nav-badge-notice')?.classList.remove('active'); 
            document.getElementById('header-badge-notice')?.classList.remove('active'); 
        }
        
        // Push History
        if(addHistory) history.pushState({ page: id }, "", `#${id}`);
        
        // Handle FAB Visibility (Only show on Home)
        const fabContainer = document.getElementById('fab-container');
        if(fabContainer) {
            if(id === 'home') {
                fabContainer.classList.remove('hidden-custom');
            } else {
                fabContainer.classList.add('hidden-custom');
            }
        }
        
        // Handle Chat View Hiding
        if (id !== 'messages' && id !== 'chat-conversation') {
             document.getElementById('chat-list-view').classList.remove('hidden', 'hidden-custom'); 
             document.getElementById('chat-conversation-view').classList.add('hidden', 'hidden-custom');
             currentChatUser = null;
        }
    }

    window.handleHomeClick = () => {
        const homeBtn = document.getElementById('btn-home');
        if(homeBtn.classList.contains('nav-active')){ 
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const icon = homeBtn.querySelector('i'); 
            if(icon) icon.classList.add('fa-spin'); 
            if(window.refreshFeed) window.refreshFeed();
            setTimeout(() => { if(icon) icon.classList.remove('fa-spin'); }, 1000);
        } else { switchPage('home'); }
    }
    
    window.onpopstate = function(event) { 
        // Close Modals on Back Button
        if (!document.getElementById('post-modal').classList.contains('hidden-custom')) { document.getElementById('post-modal').classList.add('hidden-custom'); return; }
        if (!document.getElementById('poll-modal').classList.contains('hidden-custom')) { document.getElementById('poll-modal').classList.add('hidden-custom'); return; }
        if (!document.getElementById('donor-modal').classList.contains('hidden-custom')) { document.getElementById('donor-modal').classList.add('hidden-custom'); return; }
        if (!document.getElementById('modal-blood-request').classList.contains('hidden-custom')) { document.getElementById('modal-blood-request').classList.add('hidden-custom'); return; }
        if (!document.getElementById('emergency-modal').classList.contains('hidden-custom')) { document.getElementById('emergency-modal').classList.add('hidden-custom'); return; }
        if (!document.getElementById('sell-modal').classList.contains('hidden-custom')) { document.getElementById('sell-modal').classList.add('hidden-custom'); return; }
        if (!document.getElementById('edit-profile-modal').classList.contains('hidden-custom')) { document.getElementById('edit-profile-modal').classList.add('hidden-custom'); return; }
        // Verification modal removed in this update, handled by page
        
        if(document.getElementById('search-modal').classList.contains('open')) { toggleGlobalSearch(false); return; }
        if(!document.getElementById('tag-friends-modal').classList.contains('hidden-custom')) { closeTagModal(); return; }
        if(!document.getElementById('feeling-modal').classList.contains('hidden-custom')) { closeFeelingModal(); return; }
        if(!document.getElementById('single-post-modal').classList.contains('hidden-custom')) { document.getElementById('single-post-modal').classList.add('hidden-custom'); return; }
        if(document.getElementById('image-viewer-modal').classList.contains('open')) { closeImageViewer(); return; }
        
        // Handle Page Navigation History
        if (event.state?.page) { 
            if(event.state.page === 'comment-modal') { closeFullCommentModal(); history.back(); } 
            else if (event.state.page === 'chat-conversation') { closeChat(); } 
            else { switchPage(event.state.page, false); }
        } else { switchPage('home', false); }
    };
    
    // Dropdown menu close when clicking outside
    window.addEventListener('click', function(e){ 
        if(!e.target.closest('.relative')) {
            document.querySelectorAll('.post-menu-dropdown').forEach(el => el.classList.add('hidden')); 
        }
    });
</script>

</body>
</html>